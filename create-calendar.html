<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>달력(날짜줄/스케줄줄) + 엑셀 다운로드</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <style>
         :root {
            --border: #cfcfcf;
            --title-bg: #f3cfcf;
            /* 연핑크 */
            --dow-bg: #d9d9d9;
            /* 요일 헤더 회색 */
            --date-bg: #dfeaf7;
            /* 날짜 줄 연파랑 */
            --sun: #d60000;
            --sat: #0047ff;
            --out-text: #9a9a9a;
            /* 다른달 날짜 글자 */
            --out-fill: #9e9e9e;
            /* 다른달 스케줄칸 회색 */
        }
        
        body {
            font-family: Arial, "Malgun Gothic", "맑은 고딕", sans-serif;
            background: #fafafa;
            margin: 24px;
            color: #111;
        }
        
        .bar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        
        .bar label {
            font-weight: 700;
        }
        
        .bar input {
            width: 90px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .bar button {
            padding: 9px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
        }
        
        .bar button:hover {
            background: #f5f5f5;
        }
        
        .wrap {
            width: 980px;
            max-width: 100%;
            background: #fff;
            border: 1px solid var(--border);
            box-shadow: 0 6px 20px rgba(0, 0, 0, .06);
            border-radius: 12px;
            overflow: hidden;
        }
        
        table.calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        table.calendar th,
        table.calendar td {
            border: 1px solid var(--border);
        }
        
        tr.title-row th {
            background: var(--title-bg);
            font-size: 44px;
            padding: 18px 0;
            text-align: center;
            font-weight: 900;
            letter-spacing: 1px;
        }
        
        tr.dow-row th {
            background: var(--dow-bg);
            font-size: 22px;
            padding: 10px 0;
            text-align: center;
            font-weight: 900;
        }
        
        .sun {
            color: var(--sun);
        }
        
        .sat {
            color: var(--sat);
        }
        
        .holiday {
            color: var(--sun);
        }
        /* 날짜 줄(작은 높이, 연파랑) */
        
        tr.date-row td {
            height: 36px;
            background: var(--date-bg);
            vertical-align: top;
            position: relative;
        }
        
        .date-num {
            position: absolute;
            top: 6px;
            right: 10px;
            font-size: 16px;
            font-weight: 900;
            line-height: 1;
            user-select: none;
        }
        
        

        .holiday-name {
            position: absolute;
            top: 6px;
            left: 10px;
            font-size: 11px;
            font-weight: 800;
            line-height: 1.1;
            color: var(--sun);
            user-select: none;
            max-width: calc(100% - 44px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
.out-month {
            color: var(--out-text);
            font-weight: 800;
        }
        /* 스케줄 줄(큰 높이) */
        
        tr.sched-row td {
            height: 85px;
            background: #fff;
            vertical-align: middle;
            text-align: center;
            padding: 6px 8px;
            font-size: 14px;
            font-weight: 700;
            white-space: pre-wrap;
            /* 줄바꿈 유지 */
            cursor: pointer;
        }
        
        tr.sched-row td:hover {
            background: #fafafa;
        }
        /* 다른달(leading/trailing) 스케줄칸 회색 */
        
        tr.sched-row td.out-cell {
            background: var(--out-fill);
            cursor: default;
        }
        
        tr.sched-row td.out-cell:hover {
            background: var(--out-fill);
        }
        
        .hint {
            margin-top: 10px;
            color: #666;
            font-size: 13px;
        }
        
        .title-main {
            font-size: 21px;
            font-weight: 900;
        }
        
        .title-sub {
            font-size: 14px;
            font-weight: 600;
            margin-top: 6px;
            color: #444;
        }
    </style>
</head>

<body>
    <div>
        <div class="title-main">Schedule Calendar</div>
        <div class="title-sub">by 필디</div>
    </div>
    <div class="bar">
        <label>년도</label>
        <input type="number" id="year" min="1900" max="2100" />

        <label>월</label>
        <input type="number" id="month" min="1" max="12" />

        <button id="btnDownload">엑셀 다운로드(.xlsx)</button>
    </div>

    <div class="wrap">
        <table class="calendar" id="calTable">
            <thead>
                <tr class="title-row">
                    <th colspan="7" id="titleCell">25년 11월</th>
                </tr>
                <tr class="dow-row">
                    <th class="sun">일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th class="sat">토</th>
                </tr>
            </thead>
            <tbody id="calBody"></tbody>
        </table>
    </div>

    <div class="hint">
        • 스케줄 칸(큰 칸) 클릭 → 텍스트 입력 가능 → 엑셀에도 그대로 들어갑니다.
    </div>

    <script>
        // 스케줄 저장소: key = "YYYY-MM-DD" / value = "스케줄 텍스트"
        const schedules = {};



        // ---- Korea public holidays (via Nager.Date) ----
        // cache[year] = { "YYYY-MM-DD": ["Holiday name", ...] }
        const holidayCache = {};

        async function ensureHolidays(year) {
            if (holidayCache[year]) return holidayCache[year];

            try {
                const url = `https://date.nager.at/api/v3/PublicHolidays/${year}/KR`;
                const res = await fetch(url, {
                    cache: "no-store"
                });
                if (!res.ok) throw new Error(`holiday fetch failed: ${res.status}`);

                const arr = await res.json();
                const map = {};
                (arr || []).forEach(h => {
                    // h.date: "YYYY-MM-DD", h.localName: "설날", h.name: "Seollal"
                    if (!h || !h.date) return;
                    const label = h.localName || h.name || "Holiday";
                    map[h.date] = map[h.date] ? [...map[h.date], label] : [label];
                });

                holidayCache[year] = map;
            } catch (e) {
                console.warn("공휴일 정보를 불러오지 못했습니다. (오프라인/차단 등)", e);
                holidayCache[year] = {}; // fallback
            }

            return holidayCache[year];
        }

        function getHolidayLabel(dateKey) {
            const y = Number((dateKey || "").slice(0, 4));
            const m = holidayCache[y] || {};
            return m[dateKey] ? m[dateKey].join(", ") : "";
        }

        function debounce(fn, wait) {
            let t;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        function pad2(n) {
            return String(n).padStart(2, "0");
        }

        

        // 요일 상수 (엑셀/화면 공통)
        const WEEKS = ["일", "월", "화", "수", "목", "금", "토"];

function ymdKey(dt) {
            return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}`;
        }

        function setTitle(y, m) {
            const yy = String(y).slice(-2);
            $("#titleCell").text(`${yy}년 ${pad2(m)}월`);
        }

        // 6주 고정, 각 주마다 date-row + sched-row
        function buildBody() {
            const $body = $("#calBody");
            $body.empty();

            for (let w = 0; w < 6; w++) {
                const $dateTr = $("<tr>").addClass("date-row").attr("data-week", w);
                const $schdTr = $("<tr>").addClass("sched-row").attr("data-week", w);

                for (let d = 0; d < 7; d++) {
                    $dateTr.append($("<td>").attr({
                        "data-w": w,
                        "data-d": d,
                        "data-kind": "date"
                    }));
                    $schdTr.append($("<td>").attr({
                        "data-w": w,
                        "data-d": d,
                        "data-kind": "sched"
                    }));
                }
                $body.append($dateTr, $schdTr);
            }
        }

        // 달력 렌더링: 달력 grid는 "해당 달의 1일이 포함된 주의 일요일"부터 42일
        function renderCalendar(y, m) {
            if (!y || !m) return;

            setTitle(y, m);
            buildBody();

            const firstOfMonth = new Date(y, m - 1, 1);
            const start = new Date(firstOfMonth);
            start.setDate(1 - start.getDay()); // 그 주의 일요일로 이동

            for (let i = 0; i < 42; i++) {
                const dt = new Date(start);
                dt.setDate(start.getDate() + i);

                const w = Math.floor(i / 7);
                const d = i % 7;

                const inMonth = (dt.getMonth() === (m - 1));
                const $dateTd = $(`#calBody td[data-kind="date"][data-w="${w}"][data-d="${d}"]`);
                const $schdTd = $(`#calBody td[data-kind="sched"][data-w="${w}"][data-d="${d}"]`);

                // 날짜 숫자
                const $num = $("<div>").addClass("date-num").text(dt.getDate());

                if (d === 0) $num.addClass("sun");
                if (d === 6) $num.addClass("sat");
                if (!inMonth) $num.addClass("out-month");


                const key = ymdKey(dt);

                // 공휴일 표시 (해당 년도의 공휴일 캐시가 있으면 적용)
                const hLabel = getHolidayLabel(key);
                if (hLabel) {
                    $num.addClass("holiday").attr("title", `공휴일: ${hLabel}`);
                }
                $dateTd.empty();

                // 공휴일 이름(날짜 옆에 표시)
                if (hLabel) {
                    const $h = $("<div>").addClass("holiday-name").text(hLabel);
                    $dateTd.append($h);
                }
                $dateTd.append($num);

// 스케줄 텍스트                
                const txt = schedules[key] || "";
                $schdTd.text(txt);

                // 다른달 칸 처리(회색)
                $schdTd.toggleClass("out-cell", !inMonth);

                // 셀에 날짜 메타 저장
                $schdTd.data("dateKey", key);
                $schdTd.data("inMonth", inMonth);
            }
        }

        // 스케줄 입력(간단 prompt)
        $(document).on("click", 'td[data-kind="sched"]', function() {
            const inMonth = $(this).data("inMonth");
            if (!inMonth) return;

            const key = $(this).data("dateKey");
            const prev = schedules[key] || "";
            const next = prompt("스케줄 입력(줄바꿈 가능):", prev);
            if (next === null) return;

            schedules[key] = next.trim();
            $(this).text(schedules[key]);
        });

        // ---------- Excel Export (날짜줄 + 스케줄줄) ----------
        function downloadExcel(y, m) {
            // ✅ 화면 디자인에 최대한 맞춘 엑셀 출력 (7열 유지)
            // 1) 제목(병합) + 핑크 배경
            // 2) 요일 헤더(회색 배경)
            // 3) 주 단위로 (날짜줄/스케줄줄) 반복
            // 4) 날짜줄은 교차로 연한 파란 배경(밴드)
            // 5) 일요일/공휴일 빨강, 토요일 파랑, 다른달 날짜는 회색

            const title = `${String(y).slice(-2)}년 ${pad2(m)}월`;

            // 화면 렌더링과 동일한 42일 그리드 시작점
            const firstOfMonth = new Date(y, m - 1, 1);
            const gridStart = new Date(firstOfMonth);
            gridStart.setDate(1 - gridStart.getDay());

            const aoa = [];
            aoa.push([title, "", "", "", "", "", ""]);    // row 0: title (A1:G1 merge)
            aoa.push(WEEKS.slice());                     // row 1: weekday header

            for (let w = 0; w < 6; w++) {
                const dateRow = new Array(7).fill("");
                const schedRow = new Array(7).fill("");

                for (let d = 0; d < 7; d++) {
                    const dt = new Date(gridStart);
                    dt.setDate(gridStart.getDate() + (w * 7 + d));

                    const inMonth = (dt.getMonth() === (m - 1));
                    const key = ymdKey(dt);
                    const hLabel = getHolidayLabel(key);

                    // 날짜칸: "일자\n명절명" (엑셀 한 셀에서 가시성 확보)
                    if (inMonth) {
                        dateRow[d] = (hLabel ? (String(hLabel) + " " + String(dt.getDate())) : String(dt.getDate()));
                    } else {
                        // 다른 달: 날짜는 회색으로 표시 (필요시 1일은 '3-1월'처럼 표기)
                        if (dt.getDate() === 1) {
                            dateRow[d] = `${dt.getMonth() + 1}-1월`;
                        } else {
                            dateRow[d] = String(dt.getDate());
                        }
                    }

                    // 스케줄칸: 현재 달만 유지 (다른달은 빈칸)
                    schedRow[d] = inMonth ? (schedules[key] || "") : "";
                }

                aoa.push(dateRow);
                aoa.push(schedRow);
            }

            const ws = XLSX.utils.aoa_to_sheet(aoa);

            // 병합: 제목(A1:G1)
            ws["!merges"] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }];

            // 컬럼 폭(화면 느낌)
            ws["!cols"] = [
                { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 14 }
            ];

            // 행 높이: 제목, 요일, 날짜줄/스케줄줄
            const rows = [];
            rows.push({ hpt: 46 }); // title
            rows.push({ hpt: 26 }); // weekday
            for (let w = 0; w < 6; w++) {
                rows.push({ hpt: 28 }); // date row (holiday newline)
                rows.push({ hpt: 84 }); // schedule row
            }
            ws["!rows"] = rows;

            // 스타일
            const BORDER = {
                top: { style: "thin" },
                bottom: { style: "thin" },
                left: { style: "thin" },
                right: { style: "thin" }
            };

            const FILL_PINK = { patternType: "solid", fgColor: { rgb: "F3D0D0" } };  // title bg
            const FILL_GRAY = { patternType: "solid", fgColor: { rgb: "D9D9D9" } };  // weekday bg
            const FILL_BAND = { patternType: "solid", fgColor: { rgb: "DCEAF8" } };  // date band

            const RED = { rgb: "E53935" };
            const BLUE = { rgb: "1E88E5" };
            const MUTED = { rgb: "9AA0A6" };

            function ensureCell(addr) {
                if (!ws[addr]) ws[addr] = { t: "s", v: "" };
                return ws[addr];
            }

            // Title (row 0)
            const aTitle = XLSX.utils.encode_cell({ r: 0, c: 0 });
            ensureCell(aTitle).s = {
                font: { bold: true, sz: 26 },
                alignment: { horizontal: "center", vertical: "center" },
                fill: FILL_PINK,
                border: BORDER
            };
            // merged partner cells need fill/border too
            for (let c = 1; c <= 6; c++) {
                const addr = XLSX.utils.encode_cell({ r: 0, c });
                ensureCell(addr).s = { fill: FILL_PINK, border: BORDER };
            }

            // Weekday header (row 1)
            for (let d = 0; d < 7; d++) {
                const addr = XLSX.utils.encode_cell({ r: 1, c: d });
                const cell = ensureCell(addr);
                cell.s = {
                    font: { bold: true, sz: 14, color: (d === 0 ? RED : (d === 6 ? BLUE : undefined)) },
                    alignment: { horizontal: "center", vertical: "center" },
                    fill: FILL_GRAY,
                    border: BORDER
                };
                if (d !== 0 && d !== 6) delete cell.s.font.color;
            }

            // Body rows start at r=2
            for (let w = 0; w < 6; w++) {
                const rDate = 2 + (w * 2);
                const rSched = rDate + 1;
                const band = true; // 화면처럼 날짜줄은 항상 연한 파란 음영


                for (let d = 0; d < 7; d++) {
                    const dt = new Date(gridStart);
                    dt.setDate(gridStart.getDate() + (w * 7 + d));
                    const inMonth = (dt.getMonth() === (m - 1));
                    const key = ymdKey(dt);
                    const hLabel = getHolidayLabel(key);

                    const isSun = (d === 0);
                    const isSat = (d === 6);
                    const isHoliday = !!(hLabel && inMonth);

                    // Date cell
                    const aD = XLSX.utils.encode_cell({ r: rDate, c: d });
                    const cD = ensureCell(aD);
                    cD.s = {
                        font: {
                            bold: true,
                            sz: 12,
                            color: inMonth ? ((isSun || isHoliday) ? RED : (isSat ? BLUE : undefined)) : MUTED
                        },
                        alignment: { horizontal: "left", vertical: "top", wrapText: true },
                        fill: FILL_BAND,
                        border: BORDER
                    };
if (inMonth && !(isSun || isHoliday) && !isSat) delete cD.s.font.color;

                    // Schedule cell
                    const aS = XLSX.utils.encode_cell({ r: rSched, c: d });
                    const cS = ensureCell(aS);
                    cS.s = {
                        font: { sz: 11 },
                        alignment: { horizontal: "left", vertical: "top", wrapText: true },
                        border: BORDER
                    };
                }
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Calendar");
            XLSX.writeFile(wb, `calendar_${y}_${pad2(m)}.xlsx`);
        }

        // ---------- Init ----------
        $(function() {
            const now = new Date();
            $("#year").val(now.getFullYear());
            $("#month").val(now.getMonth() + 1);

            ensureHolidays(now.getFullYear()).then(() => {
                renderCalendar(Number($("#year").val()), Number($("#month").val()));
            });

            

            const autoRender = debounce(function() {
                const y = Number($("#year").val());
                const m = Number($("#month").val());
                if (!y || !m || m < 1 || m > 12) return;
                ensureHolidays(y).then(() => {
                    renderCalendar(y, m);
                });
            }, 150);

            $("#year, #month").on("input change", autoRender);
            

            $("#btnDownload").on("click", function() {
                const y = Number($("#year").val());
                const m = Number($("#month").val());
                if (!y || !m || m < 1 || m > 12) return alert("년도/월을 올바르게 입력해줘!");
                ensureHolidays(y).then(() => {
                    renderCalendar(y, m);
                    downloadExcel(y, m);
                });
            });
        });
    </script>
</body>

</html>