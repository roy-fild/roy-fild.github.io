<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>지하철 시간대별 승하차 인원 조회</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- XLSX (엑셀 다운로드용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #eff6ff;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-sub: #4b5563;
            --radius-lg: 14px;
            --shadow-card: 0 10px 24px rgba(15, 23, 42, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 18px 20px 22px;
        }

        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
        }

        .header-meta {
            font-size: 11px;
            color: var(--text-sub);
        }

        .filter-card {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f9fafb;
            padding: 10px 12px 12px;
            margin-bottom: 12px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 90px minmax(0, 1fr) 70px minmax(0, 1fr) 80px minmax(0, 1fr) auto;
            gap: 8px 10px;
            align-items: center;
        }

        .filter-label {
            font-size: 13px;
            color: var(--text-sub);
        }

        select,
        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #ffffff;
        }

        .btn-search {
            border-radius: 999px;
            background: var(--primary);
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            padding: 7px 16px;
            cursor: pointer;
            border: none;
        }

        .btn-excel {
            border-radius: 999px;
            background: #0ea5e9;
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 14px;
            cursor: pointer;
            border: none;
        }

        .tables-toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 4px;
        }

        .tables-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 16px;
            margin-top: 4px;
            overflow-x: auto;
        }

        .table-card {
            flex: 0 0 50%;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 600px;
        }

        .table-title {
            padding: 8px 10px;
            font-size: 13px;
            font-weight: 600;
            background: #111827;
            color: #f9fafb;
        }

        .table-scroll {
            max-height: 65vh;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }

        thead tr {
            background: #e5e7eb;
        }

        th,
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            line-height: 1.4;
        }

        /* THEAD 두 줄 sticky */
        thead th {
            position: sticky;
            z-index: 1;
            background: #e5e7eb;
        }

        thead tr:nth-child(1) th {
            top: 0;
        }

        thead tr:nth-child(2) th {
            top: 28px;
        }

        tbody tr:nth-child(even) td {
            background: #f9fafb;
        }

        tbody tr:hover td {
            background: #eff6ff;
        }

        #tblBoarding th:nth-child(1),
        #tblAlighting th:nth-child(1) {
            width: 90px;
        }

        #tblBoarding th:nth-child(2),
        #tblAlighting th:nth-child(2) {
            width: 180px;
        }

        #tblBoarding th:nth-child(n+3),
        #tblAlighting th:nth-child(n+3) {
            width: 90px;
        }

        #loading {
            font-size: 11px;
            color: var(--text-sub);
        }

        /* =========================
            반응형 최적화
        ========================= */

        @media (max-width: 1024px) {
            .app {
                max-width: 100%;
                padding: 8px;
            }

            table {
                font-size: 11px;
            }

            th,
            td {
                padding: 5px 6px;
            }

            thead tr:nth-child(2) th {
                top: 26px;
            }

            .table-card {
                min-width: 560px;
            }
        }

        @media (max-width: 768px) {
            .tables-wrapper {
                flex-direction: column;
                gap: 12px;
            }

            .table-card {
                width: 100%;
            }

            .filter-grid {
                grid-template-columns: 90px 1fr;
            }

            .btn-search {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header-row {
                flex-direction: column;
                gap: 4px;
            }

            table {
                font-size: 10px;
            }

            th,
            td {
                padding: 4px 5px;
            }

            #tblBoarding th:nth-child(1),
            #tblAlighting th:nth-child(1) {
                width: 70px;
            }

            #tblBoarding th:nth-child(2),
            #tblAlighting th:nth-child(2) {
                width: 120px;
            }
        }
    </style>

    <script>
        let metroData = [];
        let lastResult = [];
        let csvLoaded = false;

        let monthField = null;
        let lineField = null;
        let stationField = null;

        const timeFields = {
            board_07_08: null,
            board_08_09: null,
            alight_18_19: null,
            alight_19_20: null,
            alight_07_08: null,
            alight_08_09: null,
            board_18_19: null,
            board_19_20: null,
        };

        const CSV_PATH = 'https://roy-fild.github.io/file/metro_data.csv';

        $(function () {
            loadCsvData();
            $('#btnSearch').on('click', applyFilterAndRender);
            $('#selMonth').on('change', rebuildLineSelect);
        });

        function findHeader(headers, keywords) {
            return headers.find(h => keywords.every(k => h.includes(k))) || null;
        }

        function loadCsvData() {
            $('#loading').text('CSV 불러오는 중...');

            fetch(CSV_PATH)
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    const decoder = new TextDecoder('euc-kr');
                    const text = decoder.decode(buffer);
                    metroData = parseCsv(text);
                    csvLoaded = true;
                    $('#loading').text('');
                    buildInitialSelects();
                });
        }

        function parseCsv(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            const headers = lines[0].split(',').map(h => h.trim());

            monthField = headers[0];
            lineField = findHeader(headers, ['호선']) || headers[1];
            stationField = findHeader(headers, ['역']) || headers[2];

            timeFields.board_07_08 = findHeader(headers, ['07', '승차']);
            timeFields.board_08_09 = findHeader(headers, ['08', '승차']);
            timeFields.alight_18_19 = findHeader(headers, ['18', '하차']);
            timeFields.alight_19_20 = findHeader(headers, ['19', '하차']);

            timeFields.alight_07_08 = findHeader(headers, ['07', '하차']);
            timeFields.alight_08_09 = findHeader(headers, ['08', '하차']);
            timeFields.board_18_19 = findHeader(headers, ['18', '승차']);
            timeFields.board_19_20 = findHeader(headers, ['19', '승차']);

            return lines.slice(1).map(line => {
                const cols = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h] = cols[i]);
                return obj;
            });
        }

        function buildInitialSelects() {
            const months = [...new Set(metroData.map(r => r[monthField]))].sort();
            const lines = [...new Set(metroData.map(r => r[lineField]))].sort();

            $('#selMonth').html('<option value="">사용월 선택</option>' + months.map(m => `<option>${m}</option>`));
            $('#selLine').html('<option value="">전체</option>' + lines.map(l => `<option>${l}</option>`));
        }

        function rebuildLineSelect() {
            const month = $('#selMonth').val();
            const lines = [...new Set(metroData.filter(r => r[monthField] === month).map(r => r[lineField]))];
            $('#selLine').html('<option value="">전체</option>' + lines.map(l => `<option>${l}</option>`));
        }

        function dedupeRows(rows) {
            const seen = new Set();
            return rows.filter(r => {
                const key = [r[monthField], r[lineField], r[stationField]].join('|');
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function applyFilterAndRender() {
            const month = $('#selMonth').val();
            const line = $('#selLine').val();
            const station = $('#txtStation').val();

            if (!month) {
                alert('사용월을 선택해 주세요.');
                return;
            }

            lastResult = dedupeRows(metroData.filter(r =>
                r[monthField] === month &&
                (!line || r[lineField] === line) &&
                (!station || r[stationField].includes(station))
            ));

            renderTables(lastResult);
        }

        function renderTables(rows) {
            const left = $('#tblBoarding tbody').empty();
            const right = $('#tblAlighting tbody').empty();

            rows.forEach(r => {
                left.append(`<tr>
                    <td>${r[lineField]}</td><td>${r[stationField]}</td>
                    <td>${r[timeFields.board_07_08]}</td>
                    <td>${r[timeFields.board_08_09]}</td>
                    <td>${r[timeFields.alight_18_19]}</td>
                    <td>${r[timeFields.alight_19_20]}</td>
                </tr>`);

                right.append(`<tr>
                    <td>${r[lineField]}</td><td>${r[stationField]}</td>
                    <td>${r[timeFields.alight_07_08]}</td>
                    <td>${r[timeFields.alight_08_09]}</td>
                    <td>${r[timeFields.board_18_19]}</td>
                    <td>${r[timeFields.board_19_20]}</td>
                </tr>`);
            });
        }

        function exportToExcel() {
            if (!lastResult.length) {
                alert("조회 후 실행하세요");
                return;
            }

            const wb = XLSX.utils.book_new();
            const rows = [];

            // 1행 ─ 화면과 동일한 2줄 헤더 구조
            rows.push([
                "", "",              // 호선명, 지하철역
                "승차", "",          // [A] 승차 (07~08 / 08~09)
                "하차", "",          // [A] 하차 (18~19 / 19~20)
                "하차", "",          // [B] 하차 (07~08 / 08~09)
                "승차", ""           // [B] 승차 (18~19 / 19~20)
            ]);

            // 2행 ─ 상세 헤더
            rows.push([
                "호선명",
                "지하철역",

                // [A] 출근 승차
                "07-08",
                "08-09",

                // [A] 퇴근 하차
                "18-19",
                "19-20",

                // [B] 출근 하차
                "07-08",
                "08-09",

                // [B] 퇴근 승차
                "18-19",
                "19-20"
            ]);

            // 데이터 행 ─ 화면 표시 순서 그대로
            lastResult.forEach(r => {
                rows.push([
                    r[lineField],
                    r[stationField],

                    // [A] 출근 승차
                    r[timeFields.board_07_08],
                    r[timeFields.board_08_09],

                    // [A] 퇴근 하차
                    r[timeFields.alight_18_19],
                    r[timeFields.alight_19_20],

                    // [B] 출근 하차
                    r[timeFields.alight_07_08],
                    r[timeFields.alight_08_09],

                    // [B] 퇴근 승차
                    r[timeFields.board_18_19],
                    r[timeFields.board_19_20]
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);

            // 병합(화면의 2줄 헤더와 동일)
            ws['!merges'] = [
                // [A] 승차(2칸)
                { s: { r: 0, c: 2 }, e: { r: 0, c: 3 } },
                // [A] 하차(2칸)
                { s: { r: 0, c: 4 }, e: { r: 0, c: 5 } },
                // [B] 하차(2칸)
                { s: { r: 0, c: 6 }, e: { r: 0, c: 7 } },
                // [B] 승차(2칸)
                { s: { r: 0, c: 8 }, e: { r: 0, c: 9 } }
            ];

            XLSX.utils.book_append_sheet(wb, ws, "화면_같이_출력");
            XLSX.writeFile(wb, "metro_"+ $('#selMonth').val() +".xlsx");
        }
    </script>
</head>

<body>
    <div class="app">
        <div class="card">

            <div class="header-row">
                <div class="header-title">지하철 시간대별 승·하차 인원 조회</div>
                <div class="header-meta"><i>by 필디</i></div>
            </div>

            <div class="filter-card">
                <div class="filter-grid">
                    <div class="filter-label">사용월*</div>
                    <div><select id="selMonth">
                            <option>로딩중</option>
                        </select></div>

                    <div class="filter-label">호선명</div>
                    <div><select id="selLine">
                            <option>전체</option>
                        </select></div>

                    <div class="filter-label">지하철역</div>
                    <div><input id="txtStation" type="text" placeholder="역 이름 일부 입력 가능"></div>

                    <div><button id="btnSearch" class="btn-search">조회</button></div>
                </div>
                <div id="loading"></div>
            </div>

            <div class="tables-toolbar">
                <button class="btn-excel" onclick="exportToExcel()">엑셀 다운로드</button>
            </div>

            <div class="tables-wrapper">

                <div class="table-card">
                    <div class="table-title">[A] 출근 승차 & 퇴근 하차</div>
                    <div class="table-scroll">
                        <table id="tblBoarding">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">승차</th>
                                    <th colspan="2">하차</th>
                                </tr>
                                <tr>
                                    <th>호선명</th>
                                    <th>지하철역</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-title">[B] 출근 하차 & 퇴근 승차</div>
                    <div class="table-scroll">
                        <table id="tblAlighting">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">하차</th>
                                    <th colspan="2">승차</th>
                                </tr>
                                <tr>
                                    <th>호선명</th>
                                    <th>지하철역</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>

</html>