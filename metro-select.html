<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>지하철 시간대별 승하차 인원 조회</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- XLSX (엑셀 다운로드용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #eff6ff;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-sub: #4b5563;
            --radius-lg: 14px;
            --shadow-card: 0 10px 24px rgba(15, 23, 42, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 18px 20px 22px;
        }

        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
        }

        .header-meta {
            font-size: 11px;
            color: var(--text-sub);
        }

        /* 검색 영역 */
        .filter-card {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f9fafb;
            padding: 10px 12px 12px;
            margin-bottom: 12px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 90px minmax(0, 1fr) 70px minmax(0, 1fr) 80px minmax(0, 1fr) auto;
            gap: 8px 10px;
            align-items: center;
        }

        .filter-label {
            font-size: 13px;
            color: var(--text-sub);
        }

        select,
        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid var(--border);
            outline: none;
            background: #ffffff;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        select:focus,
        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .btn-search {
            border-radius: 999px;
            background: var(--primary);
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            padding: 7px 16px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
            white-space: nowrap;
        }

        .btn-search:hover {
            background: #1d4ed8;
        }

        .btn-search:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(37, 99, 235, 0.4);
        }

        .btn-excel {
            border-radius: 999px;
            background: #0ea5e9;
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 14px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.35);
            white-space: nowrap;
        }

        .btn-excel:hover {
            background: #0284c7;
        }

        .btn-excel:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(14, 165, 233, 0.4);
        }

        .note {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-sub);
        }

        /* 결과 테이블 영역 */
        .tables-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 4px;
        }

        .tables-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 16px;
            margin-top: 4px;
            overflow-x: auto;
        }

        .table-card {
            flex: 0 0 50%;
            min-width: 0;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .table-title {
            padding: 8px 10px;
            font-size: 13px;
            font-weight: 600;
            background: #111827;
            color: #f9fafb;
        }

        .table-scroll {
            max-height: 65vh;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
            word-break: keep-all;
        }

        thead tr {
            background: #e5e7eb;
        }

        th,
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            white-space: normal;
            line-height: 1.4;
            text-align: center;
        }

        th {
            font-weight: 600;
            font-size: 12px;
            color: #374151;
        }

        /* THEAD 2줄 모두 고정 */
        thead th {
            position: sticky;
            z-index: 1;
            background: #e5e7eb;
        }

        /* 1번째 헤더 줄 */
        thead tr:nth-child(1) th {
            top: 0;
        }

        /* 2번째 헤더 줄 */
        thead tr:nth-child(2) th {
            top: 28px;
            /* 필요하면 30px 등으로 살짝 조정 가능 */
        }

        tbody tr:nth-child(even) td {
            background: #f9fafb;
        }

        tbody tr:hover td {
            background: #eff6ff;
        }

        /* 열 너비 튜닝 */
        #tblBoarding th:nth-child(1),
        #tblAlighting th:nth-child(1) {
            width: 90px;
        }

        #tblBoarding th:nth-child(2),
        #tblAlighting th:nth-child(2) {
            width: 180px;
        }

        #tblBoarding th:nth-child(n+3),
        #tblAlighting th:nth-child(n+3) {
            width: 90px;
        }

        /* 로딩 표시 */
        #loading {
            display: none;
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-sub);
        }
    </style>

    <script>
        // CSV 데이터를 담을 전역 배열
        let metroData = [];
        let csvLoaded = false;

        // 마지막 조회 결과 (엑셀 다운로드용)
        let lastResult = [];

        // CSV 컬럼명 동적 매핑
        let monthField = null;      // 1열 (사용월)
        let lineField = null;       // 호선명
        let stationField = null;    // 지하철역

        // 시간대별 승/하차 컬럼명 매핑
        const timeFields = {
            // 왼쪽 테이블
            board_07_08: null,
            board_08_09: null,
            alight_18_19: null,
            alight_19_20: null,
            // 오른쪽 테이블
            alight_07_08: null,
            alight_08_09: null,
            board_18_19: null,
            board_19_20: null,
        };

        // CSV 경로
        const CSV_PATH = 'https://roy-fild.github.io/file/metro_data.csv';

        $(function () {
            loadCsvData();

            $('#btnSearch').on('click', function () {
                applyFilterAndRender();
            });

            $('#selMonth').on('change', function () {
                rebuildLineSelect();
            });
        });

        function findHeader(headers, keywords) {
            return headers.find(h =>
                keywords.every(k => h.includes(k))
            ) || null;
        }

        // CSV 로딩 (euc-kr 고려)
        function loadCsvData() {
            $('#loading').text('CSV 불러오는 중...').show();

            fetch(CSV_PATH)
                .then(function (res) {
                    return res.arrayBuffer();
                })
                .then(function (buffer) {
                    let text;

                    if (window.TextDecoder) {
                        try {
                            const decoder = new TextDecoder('euc-kr');
                            text = decoder.decode(buffer);
                        } catch (e) {
                            const utf8decoder = new TextDecoder('utf-8');
                            text = utf8decoder.decode(buffer);
                        }
                    } else {
                        text = String.fromCharCode.apply(null, new Uint8Array(buffer));
                    }

                    metroData = parseCsv(text);
                    csvLoaded = true;
                    $('#loading').hide();
                    buildInitialSelects();
                })
                .catch(function (err) {
                    console.error(err);
                    $('#loading').text('CSV 로딩 실패 (경로/인코딩 확인 필요)').show();
                });
        }

        // 단순 CSV 파서
        function parseCsv(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];

            const firstLine = lines[0].replace(/^\uFEFF/, '');
            const headers = firstLine.split(',').map(h => h.trim());

            monthField = headers[0]; // 1열 → 사용월

            lineField = findHeader(headers, ['호선']) || headers[1] || null;
            stationField = findHeader(headers, ['역']) || headers[2] || null;

            timeFields.board_07_08 = findHeader(headers, ['07', '승차']);
            timeFields.board_08_09 = findHeader(headers, ['08', '승차']);
            timeFields.alight_18_19 = findHeader(headers, ['18', '하차']);
            timeFields.alight_19_20 = findHeader(headers, ['19', '하차']);

            timeFields.alight_07_08 = findHeader(headers, ['07', '하차']);
            timeFields.alight_08_09 = findHeader(headers, ['08', '하차']);
            timeFields.board_18_19 = findHeader(headers, ['18', '승차']);
            timeFields.board_19_20 = findHeader(headers, ['19', '승차']);

            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const cols = lines[i].split(',');
                const obj = {};
                headers.forEach((h, idx) => {
                    obj[h] = (cols[idx] || '').trim();
                });
                rows.push(obj);
            }
            return rows;
        }

        // 사용월 / 호선명 selectBox 초기 세팅
        function buildInitialSelects() {
            const monthSet = new Set();
            const lineSet = new Set();

            metroData.forEach(row => {
                if (monthField && row[monthField]) monthSet.add(row[monthField]);
                if (lineField && row[lineField]) lineSet.add(row[lineField]);
            });

            const $selMonth = $('#selMonth');
            const $selLine = $('#selLine');

            $selMonth.empty().append('<option value="">사용월 선택</option>');
            Array.from(monthSet).sort().forEach(m => {
                $selMonth.append('<option value="' + m + '">' + m + '</option>');
            });

            $selLine.empty().append('<option value="">전체</option>');
            Array.from(lineSet).sort().forEach(l => {
                $selLine.append('<option value="' + l + '">' + l + '</option>');
            });
        }

        // 사용월에 맞게 호선명만 다시 구성
        function rebuildLineSelect() {
            const month = $('#selMonth').val();
            const $selLine = $('#selLine');

            if (!month) {
                buildInitialSelects();
                return;
            }

            const lineSet = new Set();
            metroData.forEach(row => {
                if (row[monthField] === month && lineField && row[lineField]) {
                    lineSet.add(row[lineField]);
                }
            });

            $selLine.empty().append('<option value="">전체</option>');
            Array.from(lineSet).sort().forEach(l => {
                $selLine.append('<option value="' + l + '">' + l + '</option>');
            });
        }

        // (사용월 + 호선명 + 지하철역) 기준으로 중복 제거
        function dedupeRows(rows) {
            const seen = new Set();
            const result = [];

            rows.forEach(row => {
                const key = [
                    monthField ? row[monthField] : '',
                    lineField ? row[lineField] : '',
                    stationField ? row[stationField] : ''
                ].join('|');

                if (!seen.has(key)) {
                    seen.add(key);
                    result.push(row);
                }
            });

            return result;
        }

        // 필터 적용 후 테이블 렌더링
        function applyFilterAndRender() {
            if (!csvLoaded) {
                alert('CSV를 아직 불러오는 중입니다.');
                return;
            }

            const month = $('#selMonth').val();
            const line = $('#selLine').val();
            const station = $('#txtStation').val().trim();

            if (!month) {
                alert('사용월을 선택해 주세요.');
                return;
            }

            const filtered = metroData.filter(row => {
                if (row[monthField] !== month) return false;
                if (line && lineField && row[lineField] !== line) return false;
                if (station && stationField && row[stationField].indexOf(station) === -1) return false;
                return true;
            });

            // 중복 제거 후 저장 + 렌더링
            lastResult = dedupeRows(filtered);
            renderTables(lastResult);
        }

        // 두 개의 테이블 렌더링 (사용월 컬럼 제외)
        function renderTables(rows) {
            const $tbodyLeft = $('#tblBoarding tbody');
            const $tbodyRight = $('#tblAlighting tbody');

            $tbodyLeft.empty();
            $tbodyRight.empty();

            if (!rows.length) {
                $tbodyLeft.append('<tr><td colspan="6" style="text-align:center;">조회 결과가 없습니다.</td></tr>');
                $tbodyRight.append('<tr><td colspan="6" style="text-align:center;">조회 결과가 없습니다.</td></tr>');
                return;
            }

            rows.forEach(row => {
                const lineVal = lineField ? (row[lineField] || '') : '';
                const stationVal = stationField ? (row[stationField] || '') : '';

                const b0708 = timeFields.board_07_08 ? (row[timeFields.board_07_08] || '0') : '0';
                const b0809 = timeFields.board_08_09 ? (row[timeFields.board_08_09] || '0') : '0';
                const a1819 = timeFields.alight_18_19 ? (row[timeFields.alight_18_19] || '0') : '0';
                const a1920 = timeFields.alight_19_20 ? (row[timeFields.alight_19_20] || '0') : '0';

                const a0708 = timeFields.alight_07_08 ? (row[timeFields.alight_07_08] || '0') : '0';
                const a0809 = timeFields.alight_08_09 ? (row[timeFields.alight_08_09] || '0') : '0';
                const b1819 = timeFields.board_18_19 ? (row[timeFields.board_18_19] || '0') : '0';
                const b1920 = timeFields.board_19_20 ? (row[timeFields.board_19_20] || '0') : '0';

                const leftTr = [
                    '<tr>',
                    '<td>', lineVal, '</td>',
                    '<td>', stationVal, '</td>',
                    '<td>', b0708, '</td>',
                    '<td>', b0809, '</td>',
                    '<td>', a1819, '</td>',
                    '<td>', a1920, '</td>',
                    '</tr>'
                ].join('');

                const rightTr = [
                    '<tr>',
                    '<td>', lineVal, '</td>',
                    '<td>', stationVal, '</td>',
                    '<td>', a0708, '</td>',
                    '<td>', a0809, '</td>',
                    '<td>', b1819, '</td>',
                    '<td>', b1920, '</td>',
                    '</tr>'
                ].join('');

                $tbodyLeft.append(leftTr);
                $tbodyRight.append(rightTr);
            });
        }

        // 엑셀 다운로드 (테이블 A/B 레이아웃 그대로)
        function exportToExcel() {
            if (!lastResult.length) {
                alert('엑셀로 내보낼 조회 결과가 없습니다.\n먼저 조회 버튼을 눌러주세요.');
                return;
            }

            const dataA = [];
            const dataB = [];

            // [A] 헤더 (2줄)
            dataA.push(["", "", "승차", "", "하차", ""]);
            dataA.push(["호선명", "지하철역", "07-08", "08-09", "18-19", "19-20"]);

            // [B] 헤더 (2줄)
            dataB.push(["", "", "하차", "", "승차", ""]);
            dataB.push(["호선명", "지하철역", "07-08", "08-09", "18-19", "19-20"]);

            lastResult.forEach(row => {
                const lineVal = lineField ? (row[lineField] || '') : '';
                const stationVal = stationField ? (row[stationField] || '') : '';

                const b0708 = timeFields.board_07_08 ? (row[timeFields.board_07_08] || '0') : '0';
                const b0809 = timeFields.board_08_09 ? (row[timeFields.board_08_09] || '0') : '0';
                const a1819 = timeFields.alight_18_19 ? (row[timeFields.alight_18_19] || '0') : '0';
                const a1920 = timeFields.alight_19_20 ? (row[timeFields.alight_19_20] || '0') : '0';

                const a0708 = timeFields.alight_07_08 ? (row[timeFields.alight_07_08] || '0') : '0';
                const a0809 = timeFields.alight_08_09 ? (row[timeFields.alight_08_09] || '0') : '0';
                const b1819 = timeFields.board_18_19 ? (row[timeFields.board_18_19] || '0') : '0';
                const b1920 = timeFields.board_19_20 ? (row[timeFields.board_19_20] || '0') : '0';

                // [A] 출근/퇴근 시간 승차 & 퇴근 시간 하차
                dataA.push([
                    lineVal,
                    stationVal,
                    b0708,
                    b0809,
                    a1819,
                    a1920
                ]);

                // [B] 출근/퇴근 시간 하차 & 퇴근 시간 승차
                dataB.push([
                    lineVal,
                    stationVal,
                    a0708,
                    a0809,
                    b1819,
                    b1920
                ]);
            });

            const wb = XLSX.utils.book_new();

            // 시트 A
            const wsA = XLSX.utils.aoa_to_sheet(dataA);
            wsA['!merges'] = [
                // C1:D1 승차
                { s: { r: 0, c: 2 }, e: { r: 0, c: 3 } },
                // E1:F1 하차
                { s: { r: 0, c: 4 }, e: { r: 0, c: 5 } }
            ];
            XLSX.utils.book_append_sheet(wb, wsA, 'A_승차&하차');

            // 시트 B
            const wsB = XLSX.utils.aoa_to_sheet(dataB);
            wsB['!merges'] = [
                // C1:D1 하차
                { s: { r: 0, c: 2 }, e: { r: 0, c: 3 } },
                // E1:F1 승차
                { s: { r: 0, c: 4 }, e: { r: 0, c: 5 } }
            ];
            XLSX.utils.book_append_sheet(wb, wsB, 'B_하차&승차');

            const month = $('#selMonth').val() || 'all';
            const fileName = `metro_${month}.xlsx`;

            XLSX.writeFile(wb, fileName);
        }
    </script>

</head>

<body>
    <div class="app">
        <div class="card">
            <div class="header-row">
                <div class="header-title">지하철 시간대별 승·하차 인원 조회</div>
                <div class="header-meta"><i>by 필디</i></div>
            </div>

            <!-- 필터 영역 -->
            <div class="filter-card">
                <div class="filter-grid">
                    <div class="filter-label">사용월*</div>
                    <div>
                        <select id="selMonth">
                            <option value="">사용월 선택</option>
                        </select>
                    </div>

                    <div class="filter-label">호선명</div>
                    <div>
                        <select id="selLine">
                            <option value="">전체</option>
                        </select>
                    </div>

                    <div class="filter-label">지하철역</div>
                    <div>
                        <input type="text" id="txtStation" placeholder="역 이름 일부 입력 가능">
                    </div>

                    <div>
                        <button id="btnSearch" class="btn-search" type="button">조회</button>
                    </div>
                </div>
                <div id="loading"></div>
                <div class="note">
                    ※ 최소 조회 조건은 <b>사용월</b>입니다. 호선명/지하철역은 선택 또는 일부 문자만 입력해도 검색됩니다.
                </div>
            </div>

            <!-- 엑셀 다운로드 버튼 -->
            <div class="tables-toolbar">
                <button type="button" class="btn-excel" onclick="exportToExcel()">엑셀 다운로드</button>
            </div>

            <!-- 결과 테이블 2개 (양쪽 배치) -->
            <div class="tables-wrapper">
                <!-- 왼쪽: 승차 중심 -->
                <div class="table-card">
                    <div class="table-title">[A] 출근/퇴근 시간 승차 & 퇴근 시간 하차</div>
                    <div class="table-scroll">
                        <table id="tblBoarding">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">승차</th>
                                    <th colspan="2">하차</th>
                                </tr>
                                <tr>
                                    <th>호선명</th>
                                    <th>지하철역</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- 오른쪽: 하차 중심 -->
                <div class="table-card">
                    <div class="table-title">[B] 출근/퇴근 시간 하차 & 퇴근 시간 승차</div>
                    <div class="table-scroll">
                        <table id="tblAlighting">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">하차</th>
                                    <th colspan="2">승차</th>
                                </tr>
                                <tr>
                                    <th>호선명</th>
                                    <th>지하철역</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>

</html>