<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ÏßÄÌïòÏ≤† ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏäπÌïòÏ∞® Ïù∏Ïõê Ï°∞Ìöå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- XLSX (ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÏö©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
         :root {
            --primary: #2563eb;
            --primary-soft: #eff6ff;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-sub: #4b5563;
            --radius-lg: 14px;
            --shadow-card: 0 10px 24px rgba(15, 23, 42, 0.12);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }
        
        .app {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 18px 20px 22px;
        }
        
        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-meta {
            font-size: 11px;
            color: var(--text-sub);
        }
        /* ÎèÑÏãú ÌÉ≠ */
        
        .city-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .city-tab {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 13px;
            border: 1px solid var(--border);
            background: #f3f4f6;
            color: var(--text-main);
            cursor: pointer;
            user-select: none;
        }
        
        .city-tab.active {
            background: var(--primary);
            color: #ffffff;
            border-color: var(--primary);
        }
        
        .filter-card {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f9fafb;
            padding: 10px 12px 12px;
            margin-bottom: 12px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: 90px minmax(0, 1fr) 70px minmax(0, 1fr) 80px minmax(0, 1fr) auto;
            gap: 8px 10px;
            align-items: center;
        }
        
        .filter-label {
            font-size: 13px;
            color: var(--text-sub);
        }
        
        select,
        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #ffffff;
        }
        
        .btn-search {
            border-radius: 999px;
            background: var(--primary);
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            padding: 7px 16px;
            cursor: pointer;
            border: none;
        }
        
        .btn-excel {
            border-radius: 999px;
            background: #0ea5e9;
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 14px;
            cursor: pointer;
            border: none;
        }
        
        .tables-toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 4px;
        }
        
        .tables-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 16px;
            margin-top: 4px;
            overflow-x: auto;
        }
        
        .table-card {
            flex: 0 0 50%;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 600px;
        }
        
        .table-title {
            padding: 8px 10px;
            font-size: 13px;
            font-weight: 600;
            background: #111827;
            color: #f9fafb;
        }
        
        .table-scroll {
            max-height: 65vh;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }
        
        thead tr {
            background: #e5e7eb;
        }
        
        th,
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            line-height: 1.4;
        }
        /* THEAD Îëê Ï§Ñ sticky */
        
        thead th {
            position: sticky;
            z-index: 1;
            background: #e5e7eb;
        }
        
        thead tr:nth-child(1) th {
            top: 0;
        }
        
        thead tr:nth-child(2) th {
            top: 28px;
        }
        
        tbody tr:nth-child(even) td {
            background: #f9fafb;
        }
        
        tbody tr:hover td {
            background: #eff6ff;
        }
        
        #tblBoarding th:nth-child(1),
        #tblAlighting th:nth-child(1) {
            width: 90px;
        }
        
        #tblBoarding th:nth-child(2),
        #tblAlighting th:nth-child(2) {
            width: 180px;
        }
        
        #tblBoarding th:nth-child(n+3),
        #tblAlighting th:nth-child(n+3) {
            width: 90px;
        }
        
        #loading {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }
        /* =========================
            Î∞òÏùëÌòï ÏµúÏ†ÅÌôî
        ========================= */
        
        @media (max-width: 1024px) {
            .app {
                max-width: 100%;
                padding: 8px;
            }
            table {
                font-size: 11px;
            }
            th,
            td {
                padding: 5px 6px;
            }
            thead tr:nth-child(2) th {
                top: 26px;
            }
            .table-card {
                min-width: 560px;
            }
        }
        
        @media (max-width: 768px) {
            .tables-wrapper {
                flex-direction: column;
                gap: 12px;
            }
            .table-card {
                width: 100%;
            }
            .filter-grid {
                grid-template-columns: 90px 1fr;
            }
            .btn-search {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .header-row {
                flex-direction: column;
                gap: 4px;
            }
            table {
                font-size: 10px;
            }
            th,
            td {
                padding: 4px 5px;
            }
            #tblBoarding th:nth-child(1),
            #tblAlighting th:nth-child(1) {
                width: 70px;
            }
            #tblBoarding th:nth-child(2),
            #tblAlighting th:nth-child(2) {
                width: 120px;
            }
        }
    </style>

    <script>
        // ÎèÑÏãúÎ≥Ñ ÏÉÅÌÉú Í¥ÄÎ¶¨
        const cityState = {
            seoul: {
                name: 'ÏÑúÏö∏',
                csvPath: 'https://roy-fild.github.io/file/metro_sudo.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: null,
                    board_08_09: null,
                    alight_18_19: null,
                    alight_19_20: null,
                    alight_07_08: null,
                    alight_08_09: null,
                    board_18_19: null,
                    board_19_20: null,
                }
            },
            busan: {
                name: 'Î∂ÄÏÇ∞',
                csvPath: 'https://roy-fild.github.io/file/metro_busan.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: 'board_07_08',
                    board_08_09: 'board_08_09',
                    alight_18_19: 'alight_18_19',
                    alight_19_20: 'alight_19_20',
                    alight_07_08: 'alight_07_08',
                    alight_08_09: 'alight_08_09',
                    board_18_19: 'board_18_19',
                    board_19_20: 'board_19_20',
                }
            },
            daejeon: {
                name: 'ÎåÄÏ†Ñ',
                csvPath: 'https://roy-fild.github.io/file/metro_daejeon.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: 'board_07_08',
                    board_08_09: 'board_08_09',
                    alight_18_19: 'alight_18_19',
                    alight_19_20: 'alight_19_20',
                    alight_07_08: 'alight_07_08',
                    alight_08_09: 'alight_08_09',
                    board_18_19: 'board_18_19',
                    board_19_20: 'board_19_20',
                }
            },
            daegu: {
                name: 'ÎåÄÍµ¨',
                // ÌååÏùº Ïù¥Î¶ÑÏùÄ ÎÑ§Í∞Ä Ïã§Ï†ú Ïò¨Î¶∞ Ïù¥Î¶ÑÏóê ÎßûÍ≤å Î≥ÄÍ≤ΩÌï¥Ï§ò (Ïòà: metro_daegu.csv vs metro-daegu.csv)
                csvPath: 'https://roy-fild.github.io/file/metro_daegu.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: 'board_07_08',
                    board_08_09: 'board_08_09',
                    alight_18_19: 'alight_18_19',
                    alight_19_20: 'alight_19_20',
                    alight_07_08: 'alight_07_08',
                    alight_08_09: 'alight_08_09',
                    board_18_19: 'board_18_19',
                    board_19_20: 'board_19_20',
                }
            }
        };

        let activeCity = 'seoul'; // Í∏∞Î≥∏: ÏÑúÏö∏

        $(function() {
            // Ï¥àÍ∏∞: ÏÑúÏö∏ Îç∞Ïù¥ÌÑ∞ Î°úÎî©
            loadCityData('seoul');

            // Ï°∞Ìöå Î≤ÑÌäº
            $('#btnSearch').on('click', function() {
                applyFilterAndRender(activeCity);
            });

            // ÏÇ¨Ïö©Ïõî Î≥ÄÍ≤Ω Ïãú Ìò∏ÏÑ† Ïû¨Íµ¨ÏÑ±
            $('#selMonth').on('change', function() {
                rebuildLineSelect(activeCity);
            });

            // ÌÉ≠ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            $('.city-tab').on('click', function() {
                const city = $(this).data('city');
                if (city === activeCity) return;

                activeCity = city;

                $('.city-tab').removeClass('active');
                $(this).addClass('active');

                resetFilterUI();
                clearTables();

                if (!cityState[city].loaded) {
                    loadCityData(city);
                } else {
                    buildInitialSelects(city);
                    if (cityState[city].lastResult.length) {
                        renderTables(cityState[city].lastResult, city);
                    }
                }
            });
        });

        function findHeader(headers, keywords) {
            return headers.find(h => keywords.every(k => h.includes(k))) || null;
        }

        // ÎèÑÏãúÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎî©
        function loadCityData(city) {
            const state = cityState[city];
            $('#loading').text(state.name + ' Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...');

            fetch(state.csvPath)
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    if (city === 'seoul') {
                        // ===== ÏÑúÏö∏: CSV (euc-kr) =====
                        const decoder = new TextDecoder('euc-kr');
                        const text = decoder.decode(buffer);
                        parseSeoulCsv(text);
                    } else {
                        // ===== ÎπÑÏÑúÏö∏(Î∂ÄÏÇ∞/ÎåÄÏ†Ñ/ÎåÄÍµ¨): CSV/XLSX Î™®Îëê XLSX ÎùºÏù¥Î∏åÎü¨Î¶¨Î°ú Ï≤òÎ¶¨ =====
                        const bytes = new Uint8Array(buffer);

                        // HTML Î∞©Ïñ¥: GitHub ÏïàÎÇ¥ ÌéòÏù¥ÏßÄÍ∞Ä ÎÇ¥Î†§Ïò§Îäî Í≤ΩÏö∞
                        const firstChars = String.fromCharCode(
                            bytes[0] || 0,
                            bytes[1] || 0,
                            bytes[2] || 0,
                            bytes[3] || 0,
                            bytes[4] || 0,
                            bytes[5] || 0,
                        ).toLowerCase();

                        if (firstChars.startsWith('<!doct') || firstChars.startsWith('<html')) {
                            $('#loading').text('');
                            alert(state.name + ' Îç∞Ïù¥ÌÑ∞ Í≤ΩÎ°úÏóêÏÑú CSV/ÏóëÏÖÄ ÎåÄÏã† HTML ÌéòÏù¥ÏßÄÍ∞Ä ÎÇ¥Î†§Ïò§Í≥† ÏûàÏñ¥Ïöî.\nGitHubÏóêÏÑú "raw" Ï£ºÏÜåÎ•º ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.');
                            return;
                        }

                        // CSVÎì† XLSXÎì† workbookÏúºÎ°ú ÏùΩÏñ¥ÏÑú Ï≤´ ÏãúÌä∏Îßå ÏÇ¨Ïö©
                        const wb = XLSX.read(buffer, {
                            type: 'array'
                        });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, {
                            defval: ""
                        });
                        parseNonSeoulRows(rows, city);
                    }

                    state.loaded = true;
                    $('#loading').text('');
                    buildInitialSelects(city);
                })
                .catch(err => {
                    console.error(err);
                    $('#loading').text(state.name + ' Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®');
                });
        }

        // ---------------- ÏÑúÏö∏ ÌååÏÑú (Í∏∞Ï°¥ Î°úÏßÅ) ----------------
        function parseSeoulCsv(csvText) {
            const state = cityState.seoul;

            const lines = csvText.trim().split(/\r?\n/);
            const headers = lines[0].split(',').map(h => h.trim());

            state.monthField = headers[0]; // "ÏÇ¨Ïö©Ïõî"
            state.lineField = findHeader(headers, ['Ìò∏ÏÑ†']) || headers[1];
            state.stationField = findHeader(headers, ['Ïó≠']) || headers[2];

            state.timeFields.board_07_08 = findHeader(headers, ['07', 'ÏäπÏ∞®']);
            state.timeFields.board_08_09 = findHeader(headers, ['08', 'ÏäπÏ∞®']);
            state.timeFields.alight_18_19 = findHeader(headers, ['18', 'ÌïòÏ∞®']);
            state.timeFields.alight_19_20 = findHeader(headers, ['19', 'ÌïòÏ∞®']);

            state.timeFields.alight_07_08 = findHeader(headers, ['07', 'ÌïòÏ∞®']);
            state.timeFields.alight_08_09 = findHeader(headers, ['08', 'ÌïòÏ∞®']);
            state.timeFields.board_18_19 = findHeader(headers, ['18', 'ÏäπÏ∞®']);
            state.timeFields.board_19_20 = findHeader(headers, ['19', 'ÏäπÏ∞®']);

            state.data = lines.slice(1).map(line => {
                const cols = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h] = cols[i]);
                return obj;
            });
        }

        // ---------------- ÎπÑÏÑúÏö∏(Î∂ÄÏÇ∞/ÎåÄÏ†Ñ/ÎåÄÍµ¨) ÌååÏÑú ----------------
        function parseNonSeoulRows(rows, city) {
            const state = cityState[city];

            if (!rows || !rows.length) {
                state.data = [];
                return;
            }

            const first = rows[0];
            const keys = Object.keys(first);

            // ÎÇ†Ïßú Ïª¨Îüº: "ÎÖÑÏõîÏùº", "ÏÇ¨Ïö©Ïõî", "ÎÖÑÏõî" Îì± Ìè¨Ìï®Îêú ÌÇ§ Ï∞æÍ∏∞
            const COL_DATE =
                keys.find(k => k.includes('ÎÖÑÏõîÏùº') || k.includes('ÏÇ¨Ïö©Ïõî') || k.includes('ÎÖÑÏõî')) || keys[2];

            const COL_STATION = keys.find(k => k.includes('Ïó≠Î™Ö')) || 'Ïó≠Î™Ö';
            const COL_TYPE = keys.find(k => k.includes('Íµ¨Î∂Ñ')) || 'Íµ¨Î∂Ñ';

            // Î∂ÄÏÇ∞ / ÎåÄÍµ¨Îäî AÏó¥(ÎòêÎäî 'Ìò∏ÏÑ†Î™Ö'/'ÎÖ∏ÏÑ†Î™Ö' Îì±)Î°ú Ìò∏ÏÑ† ÏÇ¨Ïö©
            let COL_LINE = null;
            if (city === 'busan' || city === 'daegu') {
                COL_LINE =
                    keys.find(k =>
                        k.includes('Ìò∏ÏÑ†') ||
                        k.includes('ÎÖ∏ÏÑ†') ||
                        k.includes('ÎùºÏù∏') ||
                        k.includes('Ìò∏')
                    ) || keys[0]; // ÏóÜÏúºÎ©¥ Ï≤´ Î≤àÏß∏ Ïª¨Îüº(AÏó¥)
            } else if (city === 'daejeon') {
                COL_LINE = null; // ÎåÄÏ†ÑÏùÄ Ìò∏ÏÑ† Í∞úÎÖê ÏóÜÏùå
            }

            const COL_B07 = keys.find(k => k.includes('07') && k.includes('Ïãú')) || '07Ïãú-08Ïãú';
            const COL_B08 = keys.find(k => k.includes('08') && k.includes('Ïãú')) || '08Ïãú-09Ïãú';
            const COL_B18 = keys.find(k => k.includes('18') && k.includes('Ïãú')) || '18Ïãú-19Ïãú';
            const COL_B19 = keys.find(k => k.includes('19') && k.includes('Ïãú')) || '19Ïãú-20Ïãú';

            const map = {};

            rows.forEach(r => {
                const rawDate = r[COL_DATE];

                // CÏó¥ Í∞í(ÎÖÑÏõîÏùº/ÏÇ¨Ïö©Ïõî)ÏùÑ Í∑∏ÎåÄÎ°ú Î¨∏ÏûêÏó¥Î°ú ÏÇ¨Ïö©
                let date;
                if (rawDate === null || rawDate === undefined) {
                    date = "";
                } else {
                    date = String(rawDate).trim();
                }

                const station = r[COL_STATION];
                const type = r[COL_TYPE];

                // ‚òÖ Î∂ÄÏÇ∞/ÎåÄÍµ¨: Ïã§Ï†ú CSVÏùò Ìò∏ÏÑ†/ÎÖ∏ÏÑ†(AÏó¥) Í∞íÏùÑ ÏÇ¨Ïö©
                let lineValue;
                if ((city === 'busan' || city === 'daegu') && COL_LINE) {
                    let rawLineVal = (r[COL_LINE] !== undefined && r[COL_LINE] !== null) ? r[COL_LINE] : '';
                    lineValue = String(rawLineVal).trim() || state.name;
                } else if (city === 'daejeon') {
                    lineValue = 'ÎåÄÏ†ÑÎèÑÏãúÏ≤†ÎèÑ';
                } else {
                    lineValue = state.name;
                }

                if (!date || !station || !type) return;

                // keyÏóê Ìò∏ÏÑ†Î™ÖÏùÑ Ìè¨Ìï®Ìï¥ÏÑú Í∑∏Î£πÌïë
                const key = date + '|' + lineValue + '|' + station;

                if (!map[key]) {
                    map[key] = {
                        ÏÇ¨Ïö©Ïõî: date,
                        Ìò∏ÏÑ†Î™Ö: lineValue,
                        ÏßÄÌïòÏ≤†Ïó≠: station,
                        board_07_08: 0,
                        board_08_09: 0,
                        alight_18_19: 0,
                        alight_19_20: 0,
                        alight_07_08: 0,
                        alight_08_09: 0,
                        board_18_19: 0,
                        board_19_20: 0
                    };
                }

                const obj = map[key];

                const n = v => {
                    if (typeof v === 'number') return v;
                    if (!v) return 0;
                    const num = parseInt(String(v).replace(/,/g, ''), 10);
                    return isNaN(num) ? 0 : num;
                };

                if (type === 'ÏäπÏ∞®') {
                    obj.board_07_08 += n(r[COL_B07]);
                    obj.board_08_09 += n(r[COL_B08]);
                    obj.board_18_19 += n(r[COL_B18]);
                    obj.board_19_20 += n(r[COL_B19]);
                } else if (type === 'ÌïòÏ∞®') {
                    obj.alight_07_08 += n(r[COL_B07]);
                    obj.alight_08_09 += n(r[COL_B08]);
                    obj.alight_18_19 += n(r[COL_B18]);
                    obj.alight_19_20 += n(r[COL_B19]);
                }
            });

            state.data = Object.values(map);

            // ÎπÑÏÑúÏö∏Ïö© ÌïÑÎìú Ï†ïÏùò
            state.monthField = 'ÏÇ¨Ïö©Ïõî';
            state.lineField = 'Ìò∏ÏÑ†Î™Ö';
            state.stationField = 'ÏßÄÌïòÏ≤†Ïó≠';
        }

        // ---------------- Í≥µÌÜµ: ÏÖÄÎ†âÌä∏/ÌïÑÌÑ∞/Î†åÎçî ----------------
        function buildInitialSelects(city) {
            const state = cityState[city];

            const months = [...new Set(
                state.data
                .map(r => r[state.monthField])
                .filter(v => v !== null && v !== undefined && v !== '')
            )].sort();

            const lines = [...new Set(
                state.data
                .map(r => r[state.lineField])
                .filter(v => v !== null && v !== undefined && v !== '')
            )].sort();

            // üîπ ÏÇ¨Ïö©Ïõî ÏÖÄÎ†âÌä∏ ÏÉùÏÑ±
            $('#selMonth').html(
                months.length ?
                months.map((m, i) => `<option value="${m}" ${i === 0 ? 'selected' : ''}>${m}</option>`) :
                '<option value="">ÏÇ¨Ïö©Ïõî ÏóÜÏùå</option>'
            );

            // üîπ Ï≤´ Î≤àÏß∏ ÏÇ¨Ïö©Ïõî ÏûêÎèô ÏÑ†ÌÉù ‚Üí Ìò∏ÏÑ† Ïû¨Íµ¨ÏÑ±
            if (months.length > 0) {
                rebuildLineSelect(city);
            } else {
                $('#selLine').html('<option value="">Ï†ÑÏ≤¥</option>');
            }
        }

        function rebuildLineSelect(city) {
            const state = cityState[city];
            const month = $('#selMonth').val();

            const lines = [...new Set(
                state.data
                .filter(r => String(r[state.monthField]) === month)
                .map(r => r[state.lineField])
            )];

            $('#selLine').html('<option value="">Ï†ÑÏ≤¥</option>' + lines.map(l => `<option>${l}</option>`));
        }

        function dedupeRows(state, rows) {
            const seen = new Set();
            return rows.filter(r => {
                const key = [r[state.monthField], r[state.lineField], r[state.stationField]].join('|');
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function applyFilterAndRender(city) {
            const state = cityState[city];

            const month = $('#selMonth').val();
            const line = $('#selLine').val();
            const station = $('#txtStation').val();

            if (!month) {
                alert('ÏÇ¨Ïö©ÏõîÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const filtered = state.data.filter(r =>
                String(r[state.monthField]) === month &&
                (!line || r[state.lineField] === line) &&
                (!station || String(r[state.stationField]).includes(station))
            );

            state.lastResult = dedupeRows(state, filtered);
            renderTables(state.lastResult, city);
        }

        function clearTables() {
            $('#tblBoarding tbody').empty();
            $('#tblAlighting tbody').empty();
        }

        function renderTables(rows, city) {
            const state = cityState[city];

            const left = $('#tblBoarding tbody').empty();
            const right = $('#tblAlighting tbody').empty();

            rows.forEach(r => {
                left.append(`<tr>
                    <td>${r[state.lineField]}</td><td>${r[state.stationField]}</td>
                    <td>${r[state.timeFields.board_07_08] || ''}</td>
                    <td>${r[state.timeFields.board_08_09] || ''}</td>
                    <td>${r[state.timeFields.alight_18_19] || ''}</td>
                    <td>${r[state.timeFields.alight_19_20] || ''}</td>
                </tr>`);

                right.append(`<tr>
                    <td>${r[state.lineField]}</td><td>${r[state.stationField]}</td>
                    <td>${r[state.timeFields.alight_07_08] || ''}</td>
                    <td>${r[state.timeFields.alight_08_09] || ''}</td>
                    <td>${r[state.timeFields.board_18_19] || ''}</td>
                    <td>${r[state.timeFields.board_19_20] || ''}</td>
                </tr>`);
            });
        }

        function exportToExcel() {
            const state = cityState[activeCity];

            if (!state.lastResult.length) {
                alert("Ï°∞Ìöå ÌõÑ Ïã§ÌñâÌïòÏÑ∏Ïöî");
                return;
            }

            const wb = XLSX.utils.book_new();
            const rows = [];

            // 1Ìñâ ‚îÄ ÌôîÎ©¥Í≥º ÎèôÏùºÌïú 2Ï§Ñ Ìó§Îçî Íµ¨Ï°∞
            rows.push([
                "", "",
                "ÏäπÏ∞®", "",
                "ÌïòÏ∞®", "",
                "ÌïòÏ∞®", "",
                "ÏäπÏ∞®", ""
            ]);

            // 2Ìñâ ‚îÄ ÏÉÅÏÑ∏ Ìó§Îçî
            rows.push([
                "Ìò∏ÏÑ†Î™Ö",
                "ÏßÄÌïòÏ≤†Ïó≠",
                "07-08",
                "08-09",
                "18-19",
                "19-20",
                "07-08",
                "08-09",
                "18-19",
                "19-20"
            ]);

            state.lastResult.forEach(r => {
                rows.push([
                    r[state.lineField],
                    r[state.stationField],
                    r[state.timeFields.board_07_08],
                    r[state.timeFields.board_08_09],
                    r[state.timeFields.alight_18_19],
                    r[state.timeFields.alight_19_20],
                    r[state.timeFields.alight_07_08],
                    r[state.timeFields.alight_08_09],
                    r[state.timeFields.board_18_19],
                    r[state.timeFields.board_19_20]
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);

            ws['!merges'] = [{
                s: {
                    r: 0,
                    c: 2
                },
                e: {
                    r: 0,
                    c: 3
                }
            }, {
                s: {
                    r: 0,
                    c: 4
                },
                e: {
                    r: 0,
                    c: 5
                }
            }, {
                s: {
                    r: 0,
                    c: 6
                },
                e: {
                    r: 0,
                    c: 7
                }
            }, {
                s: {
                    r: 0,
                    c: 8
                },
                e: {
                    r: 0,
                    c: 9
                }
            }];

            XLSX.utils.book_append_sheet(wb, ws, "ÌôîÎ©¥_Í∞ôÏù¥_Ï∂úÎ†•");
            XLSX.writeFile(wb, `metro_${cityState[activeCity].name}_${$('#selMonth').val()}.xlsx`);
        }

        function resetFilterUI() {
            $('#selMonth').val('');
            $('#selLine').val('');
            $('#txtStation').val('');
        }
    </script>
</head>

<body>
    <div class="app">
        <div class="card">

            <div class="header-row">
                <div class="header-title">ÏßÄÌïòÏ≤† ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïäπ¬∑ÌïòÏ∞® Ïù∏Ïõê Ï°∞Ìöå</div>
                <div class="header-meta"><i>by ÌïÑÎîî</i></div>
            </div>

            <!-- ÎèÑÏãú ÌÉ≠ -->
            <div class="city-tabs">
                <div class="city-tab active" data-city="seoul">ÏÑúÏö∏</div>
                <div class="city-tab" data-city="busan">Î∂ÄÏÇ∞</div>
                <div class="city-tab" data-city="daejeon">ÎåÄÏ†Ñ</div>
                <div class="city-tab" data-city="daegu">ÎåÄÍµ¨</div>
            </div>

            <div class="filter-card">
                <div class="filter-grid">
                    <div class="filter-label">ÏÇ¨Ïö©Ïõî*</div>
                    <div>
                        <select id="selMonth">
                            <option>Î°úÎî©Ï§ë</option>
                        </select>
                    </div>

                    <div class="filter-label">Ìò∏ÏÑ†Î™Ö</div>
                    <div>
                        <select id="selLine">
                            <option>Ï†ÑÏ≤¥</option>
                        </select>
                    </div>

                    <div class="filter-label">ÏßÄÌïòÏ≤†Ïó≠</div>
                    <div>
                        <input id="txtStation" type="text" placeholder="Ïó≠ Ïù¥Î¶Ñ ÏùºÎ∂Ä ÏûÖÎ†• Í∞ÄÎä•">
                    </div>

                    <div>
                        <button id="btnSearch" class="btn-search">Ï°∞Ìöå</button>
                    </div>
                </div>
                <div id="loading"></div>
            </div>

            <div class="tables-toolbar">
                <button class="btn-excel" onclick="exportToExcel()">ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
            </div>

            <div class="tables-wrapper">

                <div class="table-card">
                    <div class="table-title">[A] Ï∂úÍ∑º ÏäπÏ∞® & Ìá¥Í∑º ÌïòÏ∞®</div>
                    <div class="table-scroll">
                        <table id="tblBoarding">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">ÏäπÏ∞®</th>
                                    <th colspan="2">ÌïòÏ∞®</th>
                                </tr>
                                <tr>
                                    <th>Ìò∏ÏÑ†Î™Ö</th>
                                    <th>ÏßÄÌïòÏ≤†Ïó≠</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-title">[B] Ï∂úÍ∑º ÌïòÏ∞® & Ìá¥Í∑º ÏäπÏ∞®</div>
                    <div class="table-scroll">
                        <table id="tblAlighting">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">ÌïòÏ∞®</th>
                                    <th colspan="2">ÏäπÏ∞®</th>
                                </tr>
                                <tr>
                                    <th>Ìò∏ÏÑ†Î™Ö</th>
                                    <th>ÏßÄÌïòÏ≤†Ïó≠</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>

</html>