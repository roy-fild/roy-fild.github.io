<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì§€í•˜ì²  ì‹œê°„ëŒ€ë³„ ìŠ¹í•˜ì°¨ ì¸ì› ì¡°íšŒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- XLSX (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
         :root {
            --primary: #2563eb;
            --primary-soft: #eff6ff;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-sub: #4b5563;
            --radius-lg: 14px;
            --shadow-card: 0 10px 24px rgba(15, 23, 42, 0.12);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }
        
        .app {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 18px 20px 22px;
        }
        
        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-meta {
            font-size: 11px;
            color: var(--text-sub);
        }
        /* ë„ì‹œ íƒ­ */
        
        .city-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .city-tab {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 13px;
            border: 1px solid var(--border);
            background: #f3f4f6;
            color: var(--text-main);
            cursor: pointer;
            user-select: none;
        }
        
        .city-tab.active {
            background: var(--primary);
            color: #ffffff;
            border-color: var(--primary);
        }
        
        .filter-card {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f9fafb;
            padding: 10px 12px 12px;
            margin-bottom: 12px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: 90px minmax(0, 1fr) 70px minmax(0, 1fr) 80px minmax(0, 1fr) auto;
            gap: 8px 10px;
            align-items: center;
        }
        
        .filter-label {
            font-size: 13px;
            color: var(--text-sub);
        }
        
        select,
        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #ffffff;
        }
        
        .btn-search {
            border-radius: 999px;
            background: var(--primary);
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            padding: 7px 16px;
            cursor: pointer;
            border: none;
        }
        
        .btn-excel {
            border-radius: 999px;
            background: #0ea5e9;
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 14px;
            cursor: pointer;
            border: none;
        }
        
        .tables-toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 4px;
        }
        
        .tables-wrapper {
            display: flex;
            flex-wrap: nowrap;
            gap: 16px;
            margin-top: 4px;
            overflow-x: auto;
        }
        
        .table-card {
            flex: 0 0 50%;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 600px;
        }
        
        .table-title {
            padding: 8px 10px;
            font-size: 13px;
            font-weight: 600;
            background: #111827;
            color: #f9fafb;
        }
        
        .table-scroll {
            max-height: 65vh;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }
        
        thead tr {
            background: #e5e7eb;
        }
        
        th,
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            line-height: 1.4;
        }
        /* THEAD ë‘ ì¤„ sticky */
        
        thead th {
            position: sticky;
            z-index: 1;
            background: #e5e7eb;
        }
        
        thead tr:nth-child(1) th {
            top: 0;
        }
        
        thead tr:nth-child(2) th {
            top: 28px;
        }
        
        tbody tr:nth-child(even) td {
            background: #f9fafb;
        }
        
        tbody tr:hover td {
            background: #eff6ff;
        }
        
        #tblBoarding th:nth-child(1),
        #tblAlighting th:nth-child(1) {
            width: 90px;
        }
        
        #tblBoarding th:nth-child(2),
        #tblAlighting th:nth-child(2) {
            width: 180px;
        }
        
        #tblBoarding th:nth-child(n+3),
        #tblAlighting th:nth-child(n+3) {
            width: 90px;
        }
        
        #loading {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }
        /* =========================
            ë°˜ì‘í˜• ìµœì í™”
        ========================= */
        
        @media (max-width: 1024px) {
            .app {
                max-width: 100%;
                padding: 8px;
            }
            table {
                font-size: 11px;
            }
            th,
            td {
                padding: 5px 6px;
            }
            thead tr:nth-child(2) th {
                top: 26px;
            }
            .table-card {
                min-width: 560px;
            }
        }
        
        @media (max-width: 768px) {
            .tables-wrapper {
                flex-direction: column;
                gap: 12px;
            }
            .table-card {
                width: 100%;
            }
            .filter-grid {
                grid-template-columns: 90px 1fr;
            }
            .btn-search {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .header-row {
                flex-direction: column;
                gap: 4px;
            }
            table {
                font-size: 10px;
            }
            th,
            td {
                padding: 4px 5px;
            }
            #tblBoarding th:nth-child(1),
            #tblAlighting th:nth-child(1) {
                width: 70px;
            }
            #tblBoarding th:nth-child(2),
            #tblAlighting th:nth-child(2) {
                width: 120px;
            }
        }
    </style>

    <script>
        // ë„ì‹œë³„ ìƒíƒœ ê´€ë¦¬
        const cityState = {
            seoul: {
                name: 'ì„œìš¸',
                csvPath: 'https://roy-fild.github.io/file/metro_sudo.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: null,
                    board_08_09: null,
                    alight_18_19: null,
                    alight_19_20: null,
                    alight_07_08: null,
                    alight_08_09: null,
                    board_18_19: null,
                    board_19_20: null,
                }
            },
            busan: {
                name: 'ë¶€ì‚°',
                csvPath: 'https://roy-fild.github.io/file/metro_busan.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: 'board_07_08',
                    board_08_09: 'board_08_09',
                    alight_18_19: 'alight_18_19',
                    alight_19_20: 'alight_19_20',
                    alight_07_08: 'alight_07_08',
                    alight_08_09: 'alight_08_09',
                    board_18_19: 'board_18_19',
                    board_19_20: 'board_19_20',
                }
            },
            daejeon: {
                name: 'ëŒ€ì „',
                csvPath: 'https://roy-fild.github.io/file/metro_daejeon.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: 'board_07_08',
                    board_08_09: 'board_08_09',
                    alight_18_19: 'alight_18_19',
                    alight_19_20: 'alight_19_20',
                    alight_07_08: 'alight_07_08',
                    alight_08_09: 'alight_08_09',
                    board_18_19: 'board_18_19',
                    board_19_20: 'board_19_20',
                }
            },
            daegu: {
                name: 'ëŒ€êµ¬',
                // íŒŒì¼ ì´ë¦„ì€ ë„¤ê°€ ì‹¤ì œ ì˜¬ë¦° ì´ë¦„ì— ë§ê²Œ ë³€ê²½í•´ì¤˜ (ì˜ˆ: metro_daegu.csv vs metro-daegu.csv)
                csvPath: 'https://roy-fild.github.io/file/metro_daegu.csv',
                data: [],
                lastResult: [],
                loaded: false,
                monthField: null,
                lineField: null,
                stationField: null,
                timeFields: {
                    board_07_08: 'board_07_08',
                    board_08_09: 'board_08_09',
                    alight_18_19: 'alight_18_19',
                    alight_19_20: 'alight_19_20',
                    alight_07_08: 'alight_07_08',
                    alight_08_09: 'alight_08_09',
                    board_18_19: 'board_18_19',
                    board_19_20: 'board_19_20',
                }
            }
        };

        let activeCity = 'seoul'; // ê¸°ë³¸: ì„œìš¸

        $(function() {
            // ì´ˆê¸°: ì„œìš¸ ë°ì´í„° ë¡œë”©
            loadCityData('seoul');

            // ì¡°íšŒ ë²„íŠ¼
            $('#btnSearch').on('click', function() {
                applyFilterAndRender(activeCity);
            });

            // ì‚¬ìš©ì›” ë³€ê²½ ì‹œ í˜¸ì„  ì¬êµ¬ì„±
            $('#selMonth').on('change', function() {
                rebuildLineSelect(activeCity);
            });

            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
            $('.city-tab').on('click', function() {
                const city = $(this).data('city');
                if (city === activeCity) return;

                activeCity = city;

                $('.city-tab').removeClass('active');
                $(this).addClass('active');

                resetFilterUI();
                clearTables();

                if (!cityState[city].loaded) {
                    loadCityData(city);
                } else {
                    buildInitialSelects(city);
                    if (cityState[city].lastResult.length) {
                        renderTables(cityState[city].lastResult, city);
                    }
                }
            });
        });

        function findHeader(headers, keywords) {
            return headers.find(h => keywords.every(k => h.includes(k))) || null;
        }

        // ë„ì‹œë³„ ë°ì´í„° ë¡œë”©
        function loadCityData(city) {
            const state = cityState[city];
            $('#loading').text(state.name + ' ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            fetch(state.csvPath)
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    if (city === 'seoul') {
                        // ===== ì„œìš¸: CSV (UTF-8 / EUC-KR ìë™ ê°ì§€) =====
                        // - ìµœê·¼ CSVê°€ UTF-8(BOM í¬í•¨)ë¡œ ë°”ë€Œë©´ euc-krë¡œ ë””ì½”ë”© ì‹œ í•œê¸€ì´ ê¹¨ì§€ê³ ,
                        //   í—¤ë” ë§¤ì¹­ì´ ì‹¤íŒ¨í•´ì„œ í‘œê°€ ë¹„ì–´ ë³´ì¼ ìˆ˜ ìˆì–´ìš”.
                        // - ìš°ì„  UTF-8ë¡œ ë””ì½”ë”©í•´ë³´ê³ , ì •ìƒ í—¤ë”("ì‚¬ìš©ì›”")ê°€ ì•ˆ ë³´ì´ë©´ EUC-KRë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.
                        let textUtf8 = new TextDecoder('utf-8').decode(buffer);
                        const text =
                            (textUtf8.includes('ì‚¬ìš©ì›”') || textUtf8.includes('í˜¸ì„ ëª…') || textUtf8.includes('ì§€í•˜ì² ì—­'))
                            ? textUtf8.replace(/^\uFEFF/, '')   // BOM ì œê±°
                            : new TextDecoder('euc-kr').decode(buffer);

                        parseSeoulCsv(text);
                    } else {
                        // ===== ë¹„ì„œìš¸(ë¶€ì‚°/ëŒ€ì „/ëŒ€êµ¬): CSV/XLSX ëª¨ë‘ XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì²˜ë¦¬ =====
                        const bytes = new Uint8Array(buffer);

                        // HTML ë°©ì–´: GitHub ì•ˆë‚´ í˜ì´ì§€ê°€ ë‚´ë ¤ì˜¤ëŠ” ê²½ìš°
                        const firstChars = String.fromCharCode(
                            bytes[0] || 0,
                            bytes[1] || 0,
                            bytes[2] || 0,
                            bytes[3] || 0,
                            bytes[4] || 0,
                            bytes[5] || 0,
                        ).toLowerCase();

                        if (firstChars.startsWith('<!doct') || firstChars.startsWith('<html')) {
                            $('#loading').text('');
                            alert(state.name + ' ë°ì´í„° ê²½ë¡œì—ì„œ CSV/ì—‘ì…€ ëŒ€ì‹  HTML í˜ì´ì§€ê°€ ë‚´ë ¤ì˜¤ê³  ìˆì–´ìš”.\nGitHubì—ì„œ "raw" ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.');
                            return;
                        }

                        // CSVë“  XLSXë“  workbookìœ¼ë¡œ ì½ì–´ì„œ ì²« ì‹œíŠ¸ë§Œ ì‚¬ìš©
                        const wb = XLSX.read(buffer, {
                            type: 'array'
                        });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, {
                            defval: ""
                        });
                        parseNonSeoulRows(rows, city);
                    }

                    state.loaded = true;
                    $('#loading').text('');
                    buildInitialSelects(city);
                })
                .catch(err => {
                    console.error(err);
                    $('#loading').text(state.name + ' ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
                });
        }

        // ---------------- ì„œìš¸ íŒŒì„œ (ê¸°ì¡´ ë¡œì§) ----------------
        function parseSeoulCsv(csvText) {
            const state = cityState.seoul;

            const lines = csvText.trim().split(/\r?\n/);
            const headers = lines[0].split(',').map(h => h.trim());

            state.monthField = headers[0]; // "ì‚¬ìš©ì›”"
            state.lineField = findHeader(headers, ['í˜¸ì„ ']) || headers[1];
            state.stationField = findHeader(headers, ['ì—­']) || headers[2];

            state.timeFields.board_07_08 = findHeader(headers, ['07', 'ìŠ¹ì°¨']);
            state.timeFields.board_08_09 = findHeader(headers, ['08', 'ìŠ¹ì°¨']);
            state.timeFields.alight_18_19 = findHeader(headers, ['18', 'í•˜ì°¨']);
            state.timeFields.alight_19_20 = findHeader(headers, ['19', 'í•˜ì°¨']);

            state.timeFields.alight_07_08 = findHeader(headers, ['07', 'í•˜ì°¨']);
            state.timeFields.alight_08_09 = findHeader(headers, ['08', 'í•˜ì°¨']);
            state.timeFields.board_18_19 = findHeader(headers, ['18', 'ìŠ¹ì°¨']);
            state.timeFields.board_19_20 = findHeader(headers, ['19', 'ìŠ¹ì°¨']);

            state.data = lines.slice(1).map(line => {
                const cols = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h] = cols[i]);
                return obj;
            });
        }

        // ---------------- ë¹„ì„œìš¸(ë¶€ì‚°/ëŒ€ì „/ëŒ€êµ¬) íŒŒì„œ ----------------
        function parseNonSeoulRows(rows, city) {
            const state = cityState[city];

            if (!rows || !rows.length) {
                state.data = [];
                return;
            }

            const first = rows[0];
            const keys = Object.keys(first);

            // ë‚ ì§œ ì»¬ëŸ¼: "ë…„ì›”ì¼", "ì‚¬ìš©ì›”", "ë…„ì›”" ë“± í¬í•¨ëœ í‚¤ ì°¾ê¸°
            const COL_DATE =
                keys.find(k => k.includes('ë…„ì›”ì¼') || k.includes('ì‚¬ìš©ì›”') || k.includes('ë…„ì›”')) || keys[2];

            const COL_STATION = keys.find(k => k.includes('ì—­ëª…')) || 'ì—­ëª…';
            const COL_TYPE = keys.find(k => k.includes('êµ¬ë¶„')) || 'êµ¬ë¶„';

            // ë¶€ì‚° / ëŒ€êµ¬ëŠ” Aì—´(ë˜ëŠ” 'í˜¸ì„ ëª…'/'ë…¸ì„ ëª…' ë“±)ë¡œ í˜¸ì„  ì‚¬ìš©
            let COL_LINE = null;
            if (city === 'busan' || city === 'daegu') {
                COL_LINE =
                    keys.find(k =>
                        k.includes('í˜¸ì„ ') ||
                        k.includes('ë…¸ì„ ') ||
                        k.includes('ë¼ì¸') ||
                        k.includes('í˜¸')
                    ) || keys[0]; // ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì»¬ëŸ¼(Aì—´)
            } else if (city === 'daejeon') {
                COL_LINE = null; // ëŒ€ì „ì€ í˜¸ì„  ê°œë… ì—†ìŒ
            }

            const COL_B07 = keys.find(k => k.includes('07') && k.includes('ì‹œ')) || '07ì‹œ-08ì‹œ';
            const COL_B08 = keys.find(k => k.includes('08') && k.includes('ì‹œ')) || '08ì‹œ-09ì‹œ';
            const COL_B18 = keys.find(k => k.includes('18') && k.includes('ì‹œ')) || '18ì‹œ-19ì‹œ';
            const COL_B19 = keys.find(k => k.includes('19') && k.includes('ì‹œ')) || '19ì‹œ-20ì‹œ';

            const map = {};

            rows.forEach(r => {
                const rawDate = r[COL_DATE];

                // Cì—´ ê°’(ë…„ì›”ì¼/ì‚¬ìš©ì›”)ì„ ê·¸ëŒ€ë¡œ ë¬¸ìì—´ë¡œ ì‚¬ìš©
                let date;
                if (rawDate === null || rawDate === undefined) {
                    date = "";
                } else {
                    date = String(rawDate).trim();
                }

                const station = r[COL_STATION];
                const type = r[COL_TYPE];

                // â˜… ë¶€ì‚°/ëŒ€êµ¬: ì‹¤ì œ CSVì˜ í˜¸ì„ /ë…¸ì„ (Aì—´) ê°’ì„ ì‚¬ìš©
                let lineValue;
                if ((city === 'busan' || city === 'daegu') && COL_LINE) {
                    let rawLineVal = (r[COL_LINE] !== undefined && r[COL_LINE] !== null) ? r[COL_LINE] : '';
                    lineValue = String(rawLineVal).trim() || state.name;
                } else if (city === 'daejeon') {
                    lineValue = 'ëŒ€ì „ë„ì‹œì² ë„';
                } else {
                    lineValue = state.name;
                }

                if (!date || !station || !type) return;

                // keyì— í˜¸ì„ ëª…ì„ í¬í•¨í•´ì„œ ê·¸ë£¹í•‘
                const key = date + '|' + lineValue + '|' + station;

                if (!map[key]) {
                    map[key] = {
                        ì‚¬ìš©ì›”: date,
                        í˜¸ì„ ëª…: lineValue,
                        ì§€í•˜ì² ì—­: station,
                        board_07_08: 0,
                        board_08_09: 0,
                        alight_18_19: 0,
                        alight_19_20: 0,
                        alight_07_08: 0,
                        alight_08_09: 0,
                        board_18_19: 0,
                        board_19_20: 0
                    };
                }

                const obj = map[key];

                const n = v => {
                    if (typeof v === 'number') return v;
                    if (!v) return 0;
                    const num = parseInt(String(v).replace(/,/g, ''), 10);
                    return isNaN(num) ? 0 : num;
                };

                if (type === 'ìŠ¹ì°¨') {
                    obj.board_07_08 += n(r[COL_B07]);
                    obj.board_08_09 += n(r[COL_B08]);
                    obj.board_18_19 += n(r[COL_B18]);
                    obj.board_19_20 += n(r[COL_B19]);
                } else if (type === 'í•˜ì°¨') {
                    obj.alight_07_08 += n(r[COL_B07]);
                    obj.alight_08_09 += n(r[COL_B08]);
                    obj.alight_18_19 += n(r[COL_B18]);
                    obj.alight_19_20 += n(r[COL_B19]);
                }
            });

            state.data = Object.values(map);

            // ë¹„ì„œìš¸ìš© í•„ë“œ ì •ì˜
            state.monthField = 'ì‚¬ìš©ì›”';
            state.lineField = 'í˜¸ì„ ëª…';
            state.stationField = 'ì§€í•˜ì² ì—­';
        }

        // ---------------- ê³µí†µ: ì…€ë ‰íŠ¸/í•„í„°/ë Œë” ----------------
        function buildInitialSelects(city) {
            const state = cityState[city];

            const months = [...new Set(
                state.data
                .map(r => r[state.monthField])
                .filter(v => v !== null && v !== undefined && v !== '')
            )].sort();

            const lines = [...new Set(
                state.data
                .map(r => r[state.lineField])
                .filter(v => v !== null && v !== undefined && v !== '')
            )].sort();

            // ğŸ”¹ ì‚¬ìš©ì›” ì…€ë ‰íŠ¸ ìƒì„±
            $('#selMonth').html(
                months.length ?
                months.map((m, i) => `<option value="${m}" ${i === 0 ? 'selected' : ''}>${m}</option>`) :
                '<option value="">ì‚¬ìš©ì›” ì—†ìŒ</option>'
            );

            // ğŸ”¹ ì²« ë²ˆì§¸ ì‚¬ìš©ì›” ìë™ ì„ íƒ â†’ í˜¸ì„  ì¬êµ¬ì„±
            if (months.length > 0) {
                rebuildLineSelect(city);
            } else {
                $('#selLine').html('<option value="">ì „ì²´</option>');
            }
        }

        function rebuildLineSelect(city) {
            const state = cityState[city];
            const month = $('#selMonth').val();

            const lines = [...new Set(
                state.data
                .filter(r => String(r[state.monthField]) === month)
                .map(r => r[state.lineField])
            )];

            $('#selLine').html('<option value="">ì „ì²´</option>' + lines.map(l => `<option>${l}</option>`));
        }

        function dedupeRows(state, rows) {
            const seen = new Set();
            return rows.filter(r => {
                const key = [r[state.monthField], r[state.lineField], r[state.stationField]].join('|');
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function applyFilterAndRender(city) {
            const state = cityState[city];

            const month = $('#selMonth').val();
            const line = $('#selLine').val();
            const station = $('#txtStation').val();

            if (!month) {
                alert('ì‚¬ìš©ì›”ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }

            const filtered = state.data.filter(r =>
                String(r[state.monthField]) === month &&
                (!line || r[state.lineField] === line) &&
                (!station || String(r[state.stationField]).includes(station))
            );

            state.lastResult = dedupeRows(state, filtered);
            renderTables(state.lastResult, city);
        }

        function clearTables() {
            $('#tblBoarding tbody').empty();
            $('#tblAlighting tbody').empty();
        }

        function renderTables(rows, city) {
            const state = cityState[city];

            const left = $('#tblBoarding tbody').empty();
            const right = $('#tblAlighting tbody').empty();

            rows.forEach(r => {
                left.append(`<tr>
                    <td>${r[state.lineField]}</td><td>${r[state.stationField]}</td>
                    <td>${r[state.timeFields.board_07_08] || ''}</td>
                    <td>${r[state.timeFields.board_08_09] || ''}</td>
                    <td>${r[state.timeFields.alight_18_19] || ''}</td>
                    <td>${r[state.timeFields.alight_19_20] || ''}</td>
                </tr>`);

                right.append(`<tr>
                    <td>${r[state.lineField]}</td><td>${r[state.stationField]}</td>
                    <td>${r[state.timeFields.alight_07_08] || ''}</td>
                    <td>${r[state.timeFields.alight_08_09] || ''}</td>
                    <td>${r[state.timeFields.board_18_19] || ''}</td>
                    <td>${r[state.timeFields.board_19_20] || ''}</td>
                </tr>`);
            });
        }

        function exportToExcel() {
            const state = cityState[activeCity];

            if (!state.lastResult.length) {
                alert("ì¡°íšŒ í›„ ì‹¤í–‰í•˜ì„¸ìš”");
                return;
            }

            const wb = XLSX.utils.book_new();
            const rows = [];

            // 1í–‰ â”€ í™”ë©´ê³¼ ë™ì¼í•œ 2ì¤„ í—¤ë” êµ¬ì¡°
            rows.push([
                "", "",
                "ìŠ¹ì°¨", "",
                "í•˜ì°¨", "",
                "í•˜ì°¨", "",
                "ìŠ¹ì°¨", ""
            ]);

            // 2í–‰ â”€ ìƒì„¸ í—¤ë”
            rows.push([
                "í˜¸ì„ ëª…",
                "ì§€í•˜ì² ì—­",
                "07-08",
                "08-09",
                "18-19",
                "19-20",
                "07-08",
                "08-09",
                "18-19",
                "19-20"
            ]);

            state.lastResult.forEach(r => {
                rows.push([
                    r[state.lineField],
                    r[state.stationField],
                    r[state.timeFields.board_07_08],
                    r[state.timeFields.board_08_09],
                    r[state.timeFields.alight_18_19],
                    r[state.timeFields.alight_19_20],
                    r[state.timeFields.alight_07_08],
                    r[state.timeFields.alight_08_09],
                    r[state.timeFields.board_18_19],
                    r[state.timeFields.board_19_20]
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);

            ws['!merges'] = [{
                s: {
                    r: 0,
                    c: 2
                },
                e: {
                    r: 0,
                    c: 3
                }
            }, {
                s: {
                    r: 0,
                    c: 4
                },
                e: {
                    r: 0,
                    c: 5
                }
            }, {
                s: {
                    r: 0,
                    c: 6
                },
                e: {
                    r: 0,
                    c: 7
                }
            }, {
                s: {
                    r: 0,
                    c: 8
                },
                e: {
                    r: 0,
                    c: 9
                }
            }];

            XLSX.utils.book_append_sheet(wb, ws, "í™”ë©´_ê°™ì´_ì¶œë ¥");
            XLSX.writeFile(wb, `metro_${cityState[activeCity].name}_${$('#selMonth').val()}.xlsx`);
        }

        function resetFilterUI() {
            $('#selMonth').val('');
            $('#selLine').val('');
            $('#txtStation').val('');
        }
    </script>
</head>

<body>
    <div class="app">
        <div class="card">

            <div class="header-row">
                <div class="header-title">ì§€í•˜ì²  ì‹œê°„ëŒ€ë³„ ìŠ¹Â·í•˜ì°¨ ì¸ì› ì¡°íšŒ</div>
                <div class="header-meta"><i>by í•„ë””</i></div>
            </div>

            <!-- ë„ì‹œ íƒ­ -->
            <div class="city-tabs">
                <div class="city-tab active" data-city="seoul">ì„œìš¸</div>
                <div class="city-tab" data-city="busan">ë¶€ì‚°</div>
                <div class="city-tab" data-city="daejeon">ëŒ€ì „</div>
                <div class="city-tab" data-city="daegu">ëŒ€êµ¬</div>
            </div>

            <div class="filter-card">
                <div class="filter-grid">
                    <div class="filter-label">ì‚¬ìš©ì›”*</div>
                    <div>
                        <select id="selMonth">
                            <option>ë¡œë”©ì¤‘</option>
                        </select>
                    </div>

                    <div class="filter-label">í˜¸ì„ ëª…</div>
                    <div>
                        <select id="selLine">
                            <option>ì „ì²´</option>
                        </select>
                    </div>

                    <div class="filter-label">ì§€í•˜ì² ì—­</div>
                    <div>
                        <input id="txtStation" type="text" placeholder="ì—­ ì´ë¦„ ì¼ë¶€ ì…ë ¥ ê°€ëŠ¥">
                    </div>

                    <div>
                        <button id="btnSearch" class="btn-search">ì¡°íšŒ</button>
                    </div>
                </div>
                <div id="loading"></div>
            </div>

            <div class="tables-toolbar">
                <button class="btn-excel" onclick="exportToExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="tables-wrapper">

                <div class="table-card">
                    <div class="table-title">[A] ì¶œê·¼ ìŠ¹ì°¨ & í‡´ê·¼ í•˜ì°¨</div>
                    <div class="table-scroll">
                        <table id="tblBoarding">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">ìŠ¹ì°¨</th>
                                    <th colspan="2">í•˜ì°¨</th>
                                </tr>
                                <tr>
                                    <th>í˜¸ì„ ëª…</th>
                                    <th>ì§€í•˜ì² ì—­</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-title">[B] ì¶œê·¼ í•˜ì°¨ & í‡´ê·¼ ìŠ¹ì°¨</div>
                    <div class="table-scroll">
                        <table id="tblAlighting">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th colspan="2">í•˜ì°¨</th>
                                    <th colspan="2">ìŠ¹ì°¨</th>
                                </tr>
                                <tr>
                                    <th>í˜¸ì„ ëª…</th>
                                    <th>ì§€í•˜ì² ì—­</th>
                                    <th>07-08</th>
                                    <th>08-09</th>
                                    <th>18-19</th>
                                    <th>19-20</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>

</html>