<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아파트 교통 정보 비교 조회</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #eff6ff;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-sub: #4b5563;
            --danger: #ef4444;
            --radius-lg: 14px;
            --shadow-card: 0 10px 24px rgba(15, 23, 42, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .app {
            max-width: 1180px;
            margin: 0 auto;
        }

        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 18px 20px 22px;
        }

        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
        }

        .header-meta {
            font-size: 11px;
            color: var(--text-sub);
        }

        /* 검색 / 컨트롤 영역 */
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .select-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        select {
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #ffffff;
            min-width: 110px;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .excel-container {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }

        button {
            border-radius: 999px;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-excel {
            background: #16a34a;
            color: #ffffff;
            box-shadow: 0 2px 6px rgba(22, 163, 74, 0.35);
        }

        .btn-excel:hover {
            background: #15803d;
        }

        .btn-reset {
            background: #6b7280;
            color: #f9fafb;
        }

        .btn-reset:hover {
            background: #4b5563;
        }

        .note {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }

        /* 결과 테이블 카드 */
        .table-card {
            margin-top: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            overflow: hidden;
        }

        .table-scroll {
            max-height: 70vh;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead tr {
            background: #111827;
            color: #f9fafb;
        }

        th,
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            text-align: center;
        }

        th {
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            position: sticky;
            top: 0;
            background: #111827;
            z-index: 1;
        }

        tbody tr:nth-child(even) td {
            background: #f9fafb;
        }

        tbody tr:hover td {
            background: #eef2ff;
        }

        /* 삭제 셀 */
        td.delete-cell {
            color: var(--danger);
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        td.delete-cell span {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(239, 68, 68, 0.4);
            background: rgba(254, 226, 226, 0.7);
            font-size: 11px;
        }

        td.delete-cell span:hover {
            background: rgba(248, 113, 113, 0.9);
            color: #fff;
        }

        /* 등급 컬러는 JS에서 인라인 스타일로 유지 */

        /* 로딩 오버레이 */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.25);
            z-index: 9999;
            display: none;
        }

        .loading-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 18px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.4);
        }

        .spinner-gradient {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: conic-gradient(#2563eb, #9b59b6, #e74c3c, #2563eb);
            -webkit-mask: radial-gradient(farthest-side, transparent 65%, black 66%);
            mask: radial-gradient(farthest-side, transparent 65%, black 66%);
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-main);
            font-weight: 600;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .card {
                padding: 14px;
            }

            .header-title {
                font-size: 17px;
            }

            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .select-group {
                width: 100%;
            }

            select {
                flex: 1;
                min-width: 0;
            }

            .excel-container {
                justify-content: flex-end;
            }

            .table-scroll {
                max-height: 60vh;
            }

            table {
                font-size: 11px;
            }
        }
    </style>

    <script>
        $(document).ready(function () {

            // 컬럼 정렬
            $("th").css("cursor", "pointer");

            $("th").click(function () {
                var table = $(this).closest("table");
                var columnIndex = $(this).index();
                var rows = table.find("tbody tr").toArray();

                rows.sort(function (a, b) {
                    var cellA = $(a).children("td").eq(columnIndex).text();
                    var cellB = $(b).children("td").eq(columnIndex).text();

                    if ($.isNumeric(cellA) && $.isNumeric(cellB)) {
                        return cellB - cellA;
                    } else {
                        return cellB.localeCompare(cellA);
                    }
                });

                table.find("tbody").empty().append(rows);
            });

            $('#sel_si').change(function () {
                $('#sel_gu').empty().append('<option value="">----------</option>');
                $('#sel_dong').empty().append('<option value="">----------</option>');
                $('#sel_nm').empty().append('<option value="">----------</option>');
                onSearch();
            });
            $('#sel_gu').change(function () {
                $('#sel_dong').empty().append('<option value="">----------</option>');
                $('#sel_nm').empty().append('<option value="">----------</option>');
                onSearch();
            });
            $('#sel_dong').change(function () {
                $('#sel_nm').empty().append('<option value="">----------</option>');
                onSearch();
            });

            $('#sel_nm').change(function () {
                getTrafficData();
            });

            // 초기화
            $('#btn_init').on('click', function () {
                $('#sel_gu').empty().append('<option value="">----------</option>');
                $('#sel_dong').empty().append('<option value="">----------</option>');
                $('#sel_nm').empty().append('<option value="">----------</option>');
                $('#tbl_aptInfo tbody').empty();
            });

            // 특정 td 클릭 시 해당 tr 삭제
            $("table").on("click", "td.delete-cell", function () {
                $(this).closest("tr").remove();
            });

            // 엑셀 출력
            $('#excelDownload').on('click', function () {

                let table = document.getElementById('tbl_aptInfo');

                // 테이블에 데이터가 있는지 확인
                let tbody = table.querySelector('tbody');
                if (!tbody || tbody.rows.length === 0) {
                    alert("테이블에 데이터가 없습니다.");
                    return;
                }

                let wb = XLSX.utils.book_new();
                let ws = XLSX.utils.table_to_sheet(table, { sheetStubs: true });

                // 열 너비 자동 조정
                let colWidths = [];
                let range = XLSX.utils.decode_range(ws['!ref']);

                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let maxWidth = 10;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        let cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        let cell = ws[cell_address];

                        if (cell && cell.v) {
                            let cellValue = String(cell.v);
                            maxWidth = Math.max(maxWidth, cellValue.length + 2);
                        }
                    }
                    colWidths.push({ wch: maxWidth });
                }
                ws['!cols'] = colWidths;

                // 기본 폰트 스타일
                Object.keys(ws).forEach(cell => {
                    if (ws[cell] && ws[cell].t) {
                        ws[cell].s = {
                            font: { name: "Arial", sz: 10 }
                        };
                    }
                });
                XLSX.utils.book_append_sheet(wb, ws, "아파트 정보");

                var fileNm = '교통정보' + getNowDate() + '.xlsx'
                XLSX.writeFile(wb, fileNm);
            });
        });

        function getNowDate() {
            let today = new Date();
            let year = today.getFullYear();
            let month = String(today.getMonth() + 1).padStart(2, "0");
            let day = String(today.getDate()).padStart(2, "0");
            return `${year}${month}${day}`;
        }

        function showLoadingBar() {
            $("#loadingOverlay").fadeIn(100);
        }

        function hideLoadingBar() {
            $("#loadingOverlay").fadeOut(200);
        }

        function getTrafficData() {

            showLoadingBar();

            var id = $('#sel_nm').val();
            var nm = $('#sel_nm option:selected').text();

            $.getJSON('https://roy-fild.github.io/json/traffic_id_data.json', function (data) {

                var html = "";
                var cnt = 0;

                $.each(data, function (i, item) {
                    if (item.ID == id) {

                        html += '<tr>';
                        html += '<td class="delete-cell"><span>삭제</span></td>';
                        html += `<td>${nm}</td>`;
                        html += chkGrade(item.grade);
                        html += addTimeColor(item.gn);
                        html += addTimeColor(item.city);
                        html += addTimeColor(item.ye);
                        html += addTimeColor(item.fan);
                        html += addTimeColor(item.ge);
                        html += addTimeColor(item.mg);
                        html += addTimeColor(item.dmc);
                        html += '</tr>';

                        $('#tbl_aptInfo tbody').append(html);
                        cnt++;
                    }
                });

                if (cnt == 0) {
                    alert('등록된 교통정보가 없습니다.');
                }

                hideLoadingBar();
            });
        }

        function onSearch() {

            showLoadingBar();

            var si = $('#sel_si').val();
            var gu = $('#sel_gu').val();
            var dong = $('#sel_dong').val();
            var nm = $('#sel_nm').val();

            $.getJSON('https://roy-fild.github.io/json/sudo_apt_data.json', function (data) {

                $.each(data, function (i, item) {

                    var guSet = new Set();
                    var dongSet = new Set();

                    if (item.si.includes(si)) {
                        // si 값과 일치하는 gu만 추가
                        $.each(data, function (i, item) {
                            if (item.si.includes(si)) {
                                guSet.add(item.gu);
                            }
                        });

                        // 구
                        if (gu === "") {
                            $('#sel_gu').empty().append('<option value="">선택하세요</option>');
                            guSet.forEach(function (gu) {
                                $('#sel_gu').append(`<option value="${gu}">${gu}</option>`);
                            });
                        }

                        // 동
                        if (gu !== "" && dong === "") {
                            $.each(data, function (i, item) {
                                if (item.si.includes(si) && item.gu.includes(gu)) {
                                    dongSet.add(item.dong);
                                }
                            });

                            $('#sel_dong').empty().append('<option value="">선택하세요</option>');
                            dongSet.forEach(function (dong) {
                                $('#sel_dong').append(`<option value="${dong}">${dong}</option>`);
                            });
                        }

                        // 아파트
                        if (gu !== "" && dong !== "" && nm === "") {
                            $('#sel_nm').empty().append('<option value="">선택하세요</option>');
                            $.each(data, function (i, item) {
                                if (item.si.includes(si) && item.gu.includes(gu) && item.dong.includes(dong)) {
                                    $('#sel_nm').append(`<option value="${item.id}">${item.nm}</option>`);
                                }
                            });
                        }

                    }
                });

                hideLoadingBar();
            });
        }

        function chkGrade(g) {
            var html = "";

            if (g.match('S')) {
                html = "<td style='text-align: center; background-color:red; color:white'>" + g + "</td>";
            } else if (g.match('A')) {
                html = "<td style='text-align: center; background-color:green; color:white'>" + g + "</td>";
            } else if (g.match('B')) {
                html = "<td style='text-align: center; background-color:blue; color:white'>" + g + "</td>";
            } else {
                html = "<td style='text-align: center; background-color:grey; color:white'>" + g + "</td>";
            }
            return html;
        }

        function addTimeColor(t) {
            var html = "";
            if (Number(t) < 31) {
                html = "<td style='text-align: center; color:blue'>" + t + "</td>";
            } else if (Number(t) > 60) {
                html = "<td style='text-align: center; color:red'>" + t + "</td>";
            } else {
                html = "<td style='text-align: center;'>" + t + "</td>";
            }
            return html;
        }
    </script>
</head>

<body>
    <div class="app">
        <div class="card">
            <div class="header-row">
                <div class="header-title">아파트 교통 정보 비교 조회</div>
                <div class="header-meta"><i>by 필디</i></div>
            </div>

            <div class="control-row">
                <div class="select-group">
                    <select id="sel_si">
                        <option value="">시/도 선택</option>
                        <option value="서울">서울</option>
                        <option value="경기">경기</option>
                        <option value="인천">인천</option>
                    </select>
                    <select id="sel_gu">
                        <option value="">구 선택</option>
                    </select>
                    <select id="sel_dong">
                        <option value="">동 선택</option>
                    </select>
                    <select id="sel_nm">
                        <option value="">아파트 선택</option>
                    </select>
                </div>

                <div class="excel-container">
                    <button id="excelDownload" class="btn-excel">EXCEL</button>
                    <button id="btn_init" class="btn-reset">초기화</button>
                </div>
            </div>
            <div class="note">
                ※ 시/구/동을 차례대로 선택 후 아파트를 선택하면 아래에 교통 시간이 추가됩니다. (행의 삭제 버튼으로 개별 삭제 가능)
            </div>

            <div class="table-card">
                <div class="table-scroll">
                    <table id="tbl_aptInfo">
                        <thead>
                            <tr>
                                <th style="width:80px"></th>
                                <th>아파트</th>
                                <th style="width:80px;">등급</th>
                                <th>강남</th>
                                <th>도심</th>
                                <th>여의도</th>
                                <th>판교</th>
                                <th>G밸리</th>
                                <th>마곡</th>
                                <th>DMC</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay">
        <div class="loading-container">
            <div class="spinner-gradient"></div>
            <div class="loading-text">데이터 불러오는 중...</div>
        </div>
    </div>

</body>

</html>
