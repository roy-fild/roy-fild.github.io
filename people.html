<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>people.html</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.8/css/dataTables.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.8/js/dataTables.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            background: #fafafa;
        }
        
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px;
        }
        
        h1 {
            margin: 0 0 6px 0;
            font-size: 22px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }
        
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .col {
            flex: 1;
            min-width: 280px;
        }
        
        label {
            font-size: 12px;
            color: #555;
            display: block;
            margin-bottom: 6px;
        }
        
        select,
        input {
            width: 100%;
            padding: 10px 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #fff;
        }
        
        .kpis {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .kpi {
            flex: 1;
            min-width: 180px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 12px;
        }
        
        .kpi .t {
            font-size: 12px;
            color: #666;
        }
        
        .kpi .v {
            font-size: 20px;
            font-weight: 700;
            margin-top: 6px;
        }
        
        .kpi .s {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        .chartBox {
            height: 360px;
        }
        
        .muted {
            color: #888;
            font-size: 12px;
        }
        
        .status {
            margin-top: 8px;
            font-size: 12px;
        }
        
        .ok {
            color: #0a7a2f;
        }
        
        .err {
            color: #b00020;
        }
        
        table.dataTable {
            width: 100% !important;
        }
        /* ===== Heat Table (white background for <=avg) ===== */
        
        .heatWrap {
            overflow: auto;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
        }
        
        table.heat {
            border-collapse: collapse;
            min-width: 820px;
            width: 100%;
            background: #fff;
        }
        
        table.heat th,
        table.heat td {
            border: 1px solid #cfcfcf;
            padding: 6px 8px;
            font-size: 14px;
            white-space: nowrap;
        }
        
        table.heat th {
            background: #f2f2f2;
            color: #000;
            font-weight: 700;
            text-align: center;
        }
        
        table.heat td.name {
            background: #f2f2f2;
            color: #000;
            font-weight: 700;
        }
        
        table.heat td.hit {
            background: #ffd0d8;
            color: #c00000;
            text-align: right;
            font-weight: 800;
        }
        
        table.heat td.miss {
            background: #ffffff;
            color: #444;
            text-align: right;
            font-weight: 600;
        }
        
        table.heat tr.avg td {
            background: #e9edf2;
            color: #000;
            font-weight: 800;
            text-align: right;
        }
        
        table.heat tr.avg td.name {
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>인구 통계 그래프(25.12)</h1>

        <div class="panel">
            <div class="row">
                <div class="col">
                    <label>시/도</label>
                    <select id="sidoSelect"></select>
                </div>
                <div class="col">
                    <label>시/군/구</label>
                    <select id="sigunguSelect"></select>
                </div>
                <div class="col">
                    <label>읍/면/동 검색 (선택)</label>
                    <input id="emdFilter" placeholder="예: 서초동 / 해운대구 / 청운효자동 등" />
                </div>
            </div>
            <div class="status" id="loadStatus"></div>
        </div>

        <div class="kpis" id="kpiRow">
            <div class="kpi">
                <div class="t">선택 영역</div>
                <div class="v" id="kpiArea">-</div>
                <div class="s" id="kpiAreaSub">-</div>
            </div>
            <div class="kpi">
                <div class="t">총인구수</div>
                <div class="v" id="kpiPop">-</div>
                <div class="s">필터 적용 합계</div>
            </div>
            <div class="kpi">
                <div class="t">세대수</div>
                <div class="v" id="kpiHouse">-</div>
                <div class="s">필터 적용 합계</div>
            </div>
            <div class="kpi">
                <div class="t">세대당 인구</div>
                <div class="v" id="kpiPph">-</div>
                <div class="s">총인구수/세대수로 산출</div>
            </div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="font-weight:700;">상위 25 (필터 적용)</div>
                    <div class="muted">선택 상태에 따라 시/도 → 시/군/구 → 읍/면/동 단위로 자동 집계</div>
                </div>
                <div style="min-width:220px;">
                    <label>정렬 기준</label>
                    <select id="sortMetric">
                        <option value="pop">총인구수</option>
                        <option value="house">세대수</option>
                        <option value="pph">세대당 인구</option>
                    </select>
                </div>
            </div>
            <div class="chartBox"><canvas id="barChart"></canvas></div>
        </div>

        <!-- ✅ 연령대(%) 100% 누적 막대 + 표 -->
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="font-weight:700;">연령대 비중(%) 100% 누적 막대</div>
                    <div class="muted">(~10대/20/30/40/50/60대~) / 동 값 없는 행 제외</div>
                </div>
                <div style="min-width:240px;">
                    <label>정렬 기준</label>
                    <select id="ageSortMetric">
                        <option value="popDesc">총인구 (내림)</option>
                        <option value="nameAsc">동 이름 (오름)</option>
                    </select>
                </div>
            </div>

            <div class="kpis" style="margin-top:12px;">
                <div class="kpi">
                    <div class="t">연령 데이터 총인구 합</div>
                    <div class="v" id="kpiAgeTotal">-</div>
                    <div class="s">필터 적용 후 합계</div>
                </div>
                <div class="kpi">
                    <div class="t">표시된 동 개수</div>
                    <div class="v" id="kpiAgeDongCnt">-</div>
                    <div class="s">동 값 없는 행 제외</div>
                </div>
            </div>

            <div class="chartBox" style="height:520px; margin-top:10px;"><canvas id="ageStackChart"></canvas></div>

            <div style="font-weight:700; margin:14px 0 8px 0;">평균 기준 표 (평균 이상: 핑크 / 평균 이하: 흰색)</div>
            <div class="heatWrap">
                <table class="heat" id="ageHeatTable"></table>
            </div>

            <!-- ✅ 청소년(0-9 / 10-19) 그래프 추가 -->
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; margin-top:14px;">
                <div>
                    <div style="font-weight:700;">청소년(0~9 / 10~19) 인구</div>
                </div>
                <div style="min-width:240px;">
                    <label>정렬 기준</label>
                    <select id="youthSortMetric">
                        <option value="sumDesc">총합 (내림차순)</option>
                        <option value="a0_9Desc">0~9세 (내림차순)</option>
                        <option value="a10_19Desc">10~19세 (내림차순)</option>
                    </select>
                </div>
            </div>
            <div class="chartBox" style="height:420px; margin-top:10px;"><canvas id="youthChart"></canvas></div>
        </div>

        <div class="panel">
            <div style="font-weight:700; margin-bottom:10px;">상세 데이터</div>
            <table id="detailTable" class="display"></table>
        </div>

        <div class="panel">
            <div style="font-weight:700; margin-bottom:10px;">연령 데이터 </div>
            <table id="ageDetailTable" class="display"></table>
        </div>
    </div>

    <script>
        var DATA_URLS = [
            "https://roy-fild.github.io/file/people/ingu_202512.csv",
            "https://roy-fild.github.io/file/people/ingu_202512"
        ];

        var AGE_URLS = [
            "https://roy-fild.github.io/file/people/ingu_age_202512.csv",
            "https://roy-fild.github.io/file/people/ingu_age_202512"
        ];

        var rawRows = [];
        var rawAgeRows = [];
        var barChart = null;
        var ageChart = null;
        var youthChart = null;
        var dt = null;
        var ageDt = null;

        function renderAgeDetailTable() {
            var rows = filteredAgeRows();
            var data = [];

            for (var i = 0; i < rows.length; i++) {
                data.push({
                    시도: rows[i].sido,
                    시군구: rows[i].sigungu,
                    읍면동: rows[i].emd,
                    "0~9세": rows[i].a0_9,
                    "10~19세": rows[i].a10_19,
                    "20~29세": rows[i].a20_29,
                    "30~39세": rows[i].a30_39,
                    "40~49세": rows[i].a40_49,
                    "50~59세": rows[i].a50_59,
                    "60~69세": rows[i].a60_69,
                    "70~79세": rows[i].a70_79,
                    "80~89세": rows[i].a80_89,
                    "90~99세": rows[i].a90_99,
                    "100세 이상": rows[i].a100p
                });
            }

            var columns = [{
                title: "시/도",
                data: "시도"
            }, {
                title: "시/군/구",
                data: "시군구"
            }, {
                title: "읍/면/동",
                data: "읍면동"
            }, {
                title: "0~9세",
                data: "0~9세",
                render: fmt
            }, {
                title: "10~19세",
                data: "10~19세",
                render: fmt
            }, {
                title: "20~29세",
                data: "20~29세",
                render: fmt
            }, {
                title: "30~39세",
                data: "30~39세",
                render: fmt
            }, {
                title: "40~49세",
                data: "40~49세",
                render: fmt
            }, {
                title: "50~59세",
                data: "50~59세",
                render: fmt
            }, {
                title: "60~69세",
                data: "60~69세",
                render: fmt
            }, {
                title: "70~79세",
                data: "70~79세",
                render: fmt
            }, {
                title: "80~89세",
                data: "80~89세",
                render: fmt
            }, {
                title: "90~99세",
                data: "90~99세",
                render: fmt
            }, {
                title: "100세 이상",
                data: "100세 이상",
                render: fmt
            }];

            if (ageDt) {
                ageDt.clear();
                ageDt.rows.add(data);
                ageDt.draw();
                return;
            }

            ageDt = new DataTable("#ageDetailTable", {
                data: data,
                columns: columns,
                pageLength: 25,
                order: [
                    [3, "desc"]
                ],
                language: {
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "총 _TOTAL_개 중 _START_~_END_",
                    paginate: {
                        previous: "이전",
                        next: "다음"
                    },
                    emptyTable: "표시할 데이터가 없습니다."
                }
            });
        }

        function nf(x) {
            if (x === null || x === undefined || x === "") return 0;
            if (typeof x === "number") return x;
            return Number(String(x).replace(/,/g, "").trim()) || 0;
        }

        function fmt(n) {
            try {
                return (Number(n) || 0).toLocaleString("ko-KR");
            } catch (e) {
                return String(n);
            }
        }

        function safeText(s) {
            return (s === null || s === undefined) ? "" : String(s);
        }

        function setStatus(msg, ok) {
            $("#loadStatus").removeClass("ok err").addClass(ok ? "ok" : "err").text(msg);
        }

        function fetchTextWithEncoding(url, encoding) {
            return fetch(url, {
                    cache: "no-store"
                })
                .then(function(resp) {
                    if (!resp.ok) throw new Error("HTTP " + resp.status + " (" + url + ")");
                    return resp.arrayBuffer();
                })
                .then(function(buf) {
                    if (typeof TextDecoder === "undefined") throw new Error("TextDecoder not supported");
                    return new TextDecoder(encoding).decode(buf);
                });
        }

        function papaDownload(url) {
            return new Promise(function(resolve, reject) {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(res) {
                        if (res && res.data && res.data.length) resolve({
                            url: url,
                            encoding: "server/default",
                            data: res.data
                        });
                        else reject(new Error("Empty CSV (" + url + ")"));
                    },
                    error: function(err) {
                        reject(err || new Error("Papa download failed (" + url + ")"));
                    }
                });
            });
        }

        function tryFetchCsvFixedByUrls(urls) {
            return new Promise(function(resolve, reject) {
                var i = 0;

                function nextUrl() {
                    if (i >= urls.length) return reject(new Error("모든 URL에서 CSV를 불러오지 못했습니다."));
                    var u = urls[i++];
                    var encs = ["euc-kr", "windows-949", "utf-8"];
                    var j = 0;

                    function nextEnc() {
                        if (j >= encs.length) {
                            papaDownload(u).then(resolve).catch(function() {
                                nextUrl();
                            });
                            return;
                        }
                        var enc = encs[j++];
                        fetchTextWithEncoding(u, enc).then(function(text) {
                            var parsed = Papa.parse(text, {
                                header: true,
                                skipEmptyLines: true
                            });
                            if (parsed && parsed.data && parsed.data.length) resolve({
                                url: u,
                                encoding: enc,
                                data: parsed.data
                            });
                            else nextEnc();
                        }).catch(function() {
                            nextEnc();
                        });
                    }
                    nextEnc();
                }
                nextUrl();
            });
        }

        function normalizeRows(rows) {
            var cols = rows.length ? Object.keys(rows[0]) : [];
            var colSido = "행정구역";
            if ($.inArray(colSido, cols) < 0) colSido = cols[0];

            var colSigungu = null,
                colEmd = null;
            for (var k = 0; k < cols.length; k++) {
                if (!colSigungu && /Unnamed:\s*1/.test(cols[k])) colSigungu = cols[k];
                if (!colEmd && /Unnamed:\s*2/.test(cols[k])) colEmd = cols[k];
            }
            if (!colSigungu) colSigungu = cols[1];
            if (!colEmd) colEmd = cols[2];

            var colPop = null,
                colHouse = null,
                colPph = null;
            for (var k4 = 0; k4 < cols.length; k4++) {
                if (!colPop && (cols[k4] === "총인구수" || /총인구/.test(cols[k4]))) colPop = cols[k4];
                if (!colHouse && (cols[k4] === "세대수" || /세대수/.test(cols[k4]))) colHouse = cols[k4];
                if (!colPph && (cols[k4] === "세대당 인구" || /세대당/.test(cols[k4]))) colPph = cols[k4];
            }

            var out = [];
            for (var r = 0; r < rows.length; r++) {
                var row = rows[r];
                var sido = safeText(row[colSido]).trim();
                if (!sido) continue;
                out.push({
                    sido: sido,
                    sigungu: safeText(row[colSigungu]).trim(),
                    emd: safeText(row[colEmd]).trim(),
                    pop: nf(row[colPop]),
                    house: nf(row[colHouse]),
                    pph: nf(row[colPph])
                });
            }
            return out;
        }

        function uniq(arr) {
            var map = {},
                out = [];
            for (var i = 0; i < arr.length; i++) {
                var v = arr[i];
                if (v === null || v === undefined) continue;
                v = String(v).trim();
                if (!v) continue;
                if (!map[v]) {
                    map[v] = true;
                    out.push(v);
                }
            }
            return out;
        }

        function rebuildSelectors() {
            var sidos = uniq($.map(rawRows, function(r) {
                return r.sido;
            }));
            var $s = $("#sidoSelect");
            $s.empty().append('<option value="">(전체)</option>');
            for (var i = 0; i < sidos.length; i++) $s.append('<option value="' + sidos[i] + '">' + sidos[i] + '</option>');
            $("#sigunguSelect").empty().append('<option value="">(전체)</option>');
        }

        function refreshSigungu() {
            var sido = $("#sidoSelect").val();
            var list = [];
            for (var i = 0; i < rawRows.length; i++)
                if (!sido || rawRows[i].sido === sido) list.push(rawRows[i].sigungu);
            list = uniq(list);

            var $g = $("#sigunguSelect");
            var cur = $g.val();
            $g.empty().append('<option value="">(전체)</option>');
            for (var j = 0; j < list.length; j++) $g.append('<option value="' + list[j] + '">' + list[j] + '</option>');
            for (var j2 = 0; j2 < list.length; j2++)
                if (list[j2] === cur) {
                    $g.val(cur);
                    break;
                }
        }

        function filteredRows() {
            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();
            var q = $.trim($("#emdFilter").val());
            var qLower = q ? q.toLowerCase() : "";
            var hasQuery = !!qLower;
            var isGuSelected = !!sigungu;
            var out = [];

            for (var i = 0; i < rawRows.length; i++) {
                var r = rawRows[i];
                if (sido && r.sido !== sido) continue;
                if (sigungu && r.sigungu !== sigungu) continue;
                if (qLower) {
                    var hay = (r.sido + " " + r.sigungu + " " + r.emd).toLowerCase();
                    if (hay.indexOf(qLower) < 0) continue;
                }
                if ((isGuSelected || hasQuery) && /구$/.test(String(r.emd || "").trim())) continue;
                out.push(r);
            }
            return out;
        }

        function pickLevel() {
            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();
            if (sigungu) return "emd";
            if (sido) return "sigungu";
            return "sido";
        }

        function aggregate(rows, level) {
            var map = {};
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var key = "";

                if (level === "emd") {
                    if (!r.emd || !String(r.emd).trim()) continue;
                    key = r.emd;
                } else if (level === "sigungu") {
                    if (!r.sigungu || !String(r.sigungu).trim()) continue;
                    key = r.sigungu;
                } else {
                    if (!r.sido || !String(r.sido).trim()) continue;
                    key = r.sido;
                }

                if (!map[key]) map[key] = {
                    name: key,
                    pop: 0,
                    house: 0,
                    pphSum: 0,
                    pphCnt: 0
                };
                map[key].pop += r.pop;
                map[key].house += r.house;
                if (r.pph) {
                    map[key].pphSum += r.pph;
                    map[key].pphCnt += 1;
                }
            }

            var out = [];
            for (var k in map)
                if (map.hasOwnProperty(k)) out.push({
                    name: map[k].name,
                    pop: map[k].pop,
                    house: map[k].house,
                    pph: map[k].pphCnt ? (map[k].pphSum / map[k].pphCnt) : 0
                });
            return out;
        }

        function updateKpis(rows) {
            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();

            var area = "전체";
            var sub = "—";
            if (sido && sigungu) {
                area = sido + " / " + sigungu;
                sub = "선택 시/군/구 기준";
            } else if (sido) {
                area = sido;
                sub = "선택 시/도 기준";
            }

            var pop = 0,
                house = 0;
            for (var i = 0; i < rows.length; i++) {
                pop += rows[i].pop;
                house += rows[i].house;
            }
            var pph = house ? (pop / house) : 0;

            $("#kpiArea").text(area);
            $("#kpiAreaSub").text(sub);
            $("#kpiPop").text(fmt(pop));
            $("#kpiHouse").text(fmt(house));
            $("#kpiPph").text(pph ? pph.toFixed(2) : "-");
        }

        function renderBar() {
            var rows = filteredRows();
            updateKpis(rows);

            var level = pickLevel();
            var agg = aggregate(rows, level);

            var metric = $("#sortMetric").val();
            agg.sort(function(a, b) {
                if (metric === "house") return b.house - a.house;
                if (metric === "pph") return b.pph - a.pph;
                return b.pop - a.pop;
            });

            var top = agg.slice(0, 25);
            var labels = [],
                popData = [],
                houseData = [],
                pphData = [];

            for (var i = 0; i < top.length; i++) {
                labels.push(top[i].name);
                popData.push(top[i].pop);
                houseData.push(top[i].house);
                pphData.push(Number(top[i].pph ? top[i].pph.toFixed(2) : 0));
            }

            var lineValuePlugin = {
                id: "lineValuePlugin",
                afterDatasetsDraw: function(chart) {
                    var ctx = chart.ctx;
                    ctx.save();
                    ctx.font = "12px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "bottom";
                    var meta = chart.getDatasetMeta(2);
                    if (!meta || !meta.data) {
                        ctx.restore();
                        return;
                    }
                    for (var j = 0; j < meta.data.length; j++) {
                        var pt = meta.data[j];
                        if (!pt) continue;
                        var v = pphData[j];
                        if (v === null || v === undefined) continue;
                        ctx.fillText(String(v), pt.x, pt.y - 6);
                    }
                    ctx.restore();
                }
            };

            if (barChart) barChart.destroy();
            barChart = new Chart(document.getElementById("barChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        type: "bar",
                        label: "총인구수",
                        data: popData,
                        yAxisID: "y"
                    }, {
                        type: "bar",
                        label: "세대수",
                        data: houseData,
                        yAxisID: "y"
                    }, {
                        type: "line",
                        label: "세대당 인구",
                        data: pphData,
                        yAxisID: "y1",
                        tension: 0.25,
                        pointRadius: 3,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    var label = ctx.dataset.label || "";
                                    var v = ctx.raw;
                                    if (ctx.dataset.yAxisID === "y1") return label + ": " + v;
                                    return label + ": " + fmt(v);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            position: "left",
                            ticks: {
                                callback: function(v) {
                                    return fmt(v);
                                }
                            }
                        },
                        y1: {
                            position: "right",
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(v) {
                                    return v;
                                }
                            }
                        }
                    }
                },
                plugins: [lineValuePlugin]
            });
        }

        function renderTable() {
            var rows = filteredRows();
            var data = [];
            for (var i = 0; i < rows.length; i++) data.push({
                시도: rows[i].sido,
                시군구: rows[i].sigungu,
                읍면동: rows[i].emd,
                총인구수: rows[i].pop,
                세대수: rows[i].house,
                "세대당 인구": rows[i].pph
            });

            var columns = [{
                title: "시/도",
                data: "시도"
            }, {
                title: "시/군/구",
                data: "시군구"
            }, {
                title: "읍/면/동",
                data: "읍면동"
            }, {
                title: "총인구수",
                data: "총인구수",
                render: function(d) {
                    return fmt(d);
                }
            }, {
                title: "세대수",
                data: "세대수",
                render: function(d) {
                    return fmt(d);
                }
            }, {
                title: "세대당 인구",
                data: "세대당 인구",
                render: function(d) {
                    return d ? Number(d).toFixed(2) : "-";
                }
            }];

            if (dt) {
                dt.clear();
                dt.rows.add(data);
                dt.draw();
                return;
            }

            dt = new DataTable("#detailTable", {
                data: data,
                columns: columns,
                pageLength: 25,
                order: [
                    [3, "desc"]
                ],
                language: {
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "총 _TOTAL_개 중 _START_~_END_",
                    paginate: {
                        previous: "이전",
                        next: "다음"
                    },
                    emptyTable: "표시할 데이터가 없습니다."
                }
            });
        }

        function renderAll() {
            renderBar();
            renderTable();
        }

        /* ========================= AGE ========================= */

        function normalizeAgeRows(rows) {
            var cols = rows.length ? Object.keys(rows[0]) : [];
            var colSido = "행정구역";
            if ($.inArray(colSido, cols) < 0) colSido = cols[0];

            var colSigungu = null,
                colEmd = null;
            for (var k = 0; k < cols.length; k++) {
                if (!colSigungu && /Unnamed:\s*1/.test(cols[k])) colSigungu = cols[k];
                if (!colEmd && /Unnamed:\s*2/.test(cols[k])) colEmd = cols[k];
            }
            if (!colSigungu) colSigungu = cols[1];
            if (!colEmd) colEmd = cols[2];

            function findCol(regex) {
                for (var i = 0; i < cols.length; i++)
                    if (regex.test(cols[i])) return cols[i];
                return null;
            }

            var c0_9 = findCol(/^0\s*~\s*9\s*세/);
            var c10_19 = findCol(/^10\s*~\s*19\s*세/);
            var c20_29 = findCol(/^20\s*~\s*29\s*세/);
            var c30_39 = findCol(/^30\s*~\s*39\s*세/);
            var c40_49 = findCol(/^40\s*~\s*49\s*세/);
            var c50_59 = findCol(/^50\s*~\s*59\s*세/);
            var c60_69 = findCol(/^60\s*~\s*69\s*세/);
            var c70_79 = findCol(/^70\s*~\s*79\s*세/);
            var c80_89 = findCol(/^80\s*~\s*89\s*세/);
            var c90_99 = findCol(/^90\s*~\s*99\s*세/);
            var c100p = findCol(/^100\s*세\s*이상/);

            if (!c100p) {
                for (var i2 = 0; i2 < cols.length; i2++) {
                    if (cols[i2].indexOf("100") >= 0 && cols[i2].indexOf("이상") >= 0) {
                        c100p = cols[i2];
                        break;
                    }
                }
            }

            var out = [];
            for (var r = 0; r < rows.length; r++) {
                var row = rows[r];
                var sido = safeText(row[colSido]).trim();
                if (!sido) continue;

                out.push({
                    sido: sido,
                    sigungu: safeText(row[colSigungu]).trim(),
                    emd: safeText(row[colEmd]).trim(),
                    a0_9: nf(row[c0_9]),
                    a10_19: nf(row[c10_19]),
                    a20_29: nf(row[c20_29]),
                    a30_39: nf(row[c30_39]),
                    a40_49: nf(row[c40_49]),
                    a50_59: nf(row[c50_59]),
                    a60_69: nf(row[c60_69]),
                    a70_79: nf(row[c70_79]),
                    a80_89: nf(row[c80_89]),
                    a90_99: nf(row[c90_99]),
                    a100p: nf(row[c100p])
                });
            }
            return out;
        }

        function filteredAgeRows() {
            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();
            var q = $.trim($("#emdFilter").val());
            var qLower = q ? q.toLowerCase() : "";
            var hasQuery = !!qLower;
            var isGuSelected = !!sigungu;
            var out = [];

            for (var i = 0; i < rawAgeRows.length; i++) {
                var r = rawAgeRows[i];
                if (sido && r.sido !== sido) continue;
                if (sigungu && r.sigungu !== sigungu) continue;
                if (!r.emd || !String(r.emd).trim()) continue;

                if (qLower) {
                    var hay = (r.sido + " " + r.sigungu + " " + r.emd).toLowerCase();
                    if (hay.indexOf(qLower) < 0) continue;
                }
                if ((isGuSelected || hasQuery) && /구$/.test(String(r.emd || "").trim())) continue;
                out.push(r);
            }
            return out;
        }

        function aggregateAgeByDong(rows) {
            var map = {};
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var key = r.emd;
                if (!key) continue;

                if (!map[key]) map[key] = {
                    name: key,
                    teen: 0,
                    a20: 0,
                    a30: 0,
                    a40: 0,
                    a50: 0,
                    a60p: 0,
                    total: 0,
                    pTeen: 0,
                    p20: 0,
                    p30: 0,
                    p40: 0,
                    p50: 0,
                    p60p: 0,
                    pFamily: 0
                };

                var teen = r.a0_9 + r.a10_19;
                var a20 = r.a20_29;
                var a30 = r.a30_39;
                var a40 = r.a40_49;
                var a50 = r.a50_59;
                var a60p = r.a60_69 + r.a70_79 + r.a80_89 + r.a90_99 + r.a100p;

                map[key].teen += teen;
                map[key].a20 += a20;
                map[key].a30 += a30;
                map[key].a40 += a40;
                map[key].a50 += a50;
                map[key].a60p += a60p;

                map[key].total += (teen + a20 + a30 + a40 + a50 + a60p);
            }

            var out = [];
            for (var k in map) {
                if (!map.hasOwnProperty(k)) continue;
                var o = map[k];
                if (!o.total) continue;

                o.pTeen = (o.teen / o.total) * 100;
                o.p20 = (o.a20 / o.total) * 100;
                o.p30 = (o.a30 / o.total) * 100;
                o.p40 = (o.a40 / o.total) * 100;
                o.p50 = (o.a50 / o.total) * 100;
                o.p60p = (o.a60p / o.total) * 100;

                o.pFamily = ((o.teen + o.a30 + o.a40 + o.a50) / o.total) * 100;

                out.push(o);
            }
            return out;
        }

        function updateAgeKpis(agg) {
            var totalPop = 0;
            for (var i = 0; i < agg.length; i++) totalPop += agg[i].total;
            $("#kpiAgeTotal").text(fmt(totalPop));
            $("#kpiAgeDongCnt").text(fmt(agg.length));
        }

        function buildAgeHeatTable(agg) {
            var cols = [{
                key: "pTeen",
                title: "~10대"
            }, {
                key: "p20",
                title: "20대"
            }, {
                key: "p30",
                title: "30대"
            }, {
                key: "p40",
                title: "40대"
            }, {
                key: "p50",
                title: "50대"
            }, {
                key: "p60p",
                title: "60대"
            }, {
                key: "pFamily",
                title: "완성형"
            }];

            if (!agg.length) {
                $("#ageHeatTable").html("");
                return;
            }

            var avg = {};
            for (var c = 0; c < cols.length; c++) avg[cols[c].key] = 0;
            for (var i = 0; i < agg.length; i++) {
                for (var c2 = 0; c2 < cols.length; c2++) avg[cols[c2].key] += agg[i][cols[c2].key];
            }
            for (var c3 = 0; c3 < cols.length; c3++) avg[cols[c3].key] = avg[cols[c3].key] / agg.length;

            var html = "";
            html += "<thead><tr><th></th>";
            for (var h = 0; h < cols.length; h++) html += "<th>" + cols[h].title + "</th>";
            html += "</tr></thead><tbody>";

            for (var r = 0; r < agg.length; r++) {
                html += "<tr>";
                html += "<td class='name'>" + agg[r].name + "</td>";

                for (var cc = 0; cc < cols.length; cc++) {
                    var k = cols[cc].key;
                    var v = Number(agg[r][k] || 0);
                    var txt = Math.round(v) + "%";
                    if (v >= avg[k]) html += "<td class='hit'>" + txt + "</td>";
                    else html += "<td class='miss'>" + txt + "</td>";
                }
                html += "</tr>";
            }

            html += "<tr class='avg'>";
            html += "<td class='name'> </td>";
            for (var a = 0; a < cols.length; a++) html += "<td>" + Math.round(avg[cols[a].key]) + "%</td>";
            html += "</tr>";

            html += "</tbody>";
            $("#ageHeatTable").html(html);
        }

        // ✅ 청소년(0-9 / 10-19) 집계 + 그래프
        function aggregateYouthByDong(rows) {
            var map = {};
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var key = r.emd;
                if (!key) continue;

                if (!map[key]) map[key] = {
                    name: key,
                    a0_9: 0,
                    a10_19: 0,
                    sum: 0
                };

                map[key].a0_9 += (r.a0_9 || 0);
                map[key].a10_19 += (r.a10_19 || 0);
                map[key].sum += ((r.a0_9 || 0) + (r.a10_19 || 0));
            }

            var out = [];
            for (var k in map) {
                if (!map.hasOwnProperty(k)) continue;
                out.push(map[k]);
            }
            return out;
        }

        function renderYouthChart() {
            var rows = filteredAgeRows();
            var agg = aggregateYouthByDong(rows);

            var m = $("#youthSortMetric").val();
            agg.sort(function(a, b) {
                if (m === "a0_9Desc") return (b.a0_9 - a.a0_9);
                if (m === "a10_19Desc") return (b.a10_19 - a.a10_19);
                return (b.sum - a.sum);
            });

            var maxN = 25;
            if (agg.length > maxN) agg = agg.slice(0, maxN);

            var labels = [];
            var d0_9 = [];
            var d10_19 = [];

            for (var i = 0; i < agg.length; i++) {
                labels.push(agg[i].name);
                d0_9.push(agg[i].a0_9);
                d10_19.push(agg[i].a10_19);
            }

            if (youthChart) youthChart.destroy();
            youthChart = new Chart(document.getElementById("youthChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "0~9세",
                        data: d0_9
                    }, {
                        label: "10~19세",
                        data: d10_19
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ": " + fmt(ctx.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(v) {
                                    return fmt(v);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAgeChartAndTable() {
            var rows = filteredAgeRows();
            var agg = aggregateAgeByDong(rows);

            var m = $("#ageSortMetric").val();
            agg.sort(function(a, b) {
                if (m === "nameAsc") return String(a.name).localeCompare(String(b.name), "ko");
                return b.total - a.total;
            });

            var maxN = 25;
            if (agg.length > maxN) agg = agg.slice(0, maxN);

            updateAgeKpis(agg);
            buildAgeHeatTable(agg);

            var labels = [];
            var dTeen = [],
                d20 = [],
                d30 = [],
                d40 = [],
                d50 = [],
                d60p = [];
            for (var i = 0; i < agg.length; i++) {
                labels.push(agg[i].name);
                dTeen.push(Number(agg[i].pTeen.toFixed(0)));
                d20.push(Number(agg[i].p20.toFixed(0)));
                d30.push(Number(agg[i].p30.toFixed(0)));
                d40.push(Number(agg[i].p40.toFixed(0)));
                d50.push(Number(agg[i].p50.toFixed(0)));
                d60p.push(Number(agg[i].p60p.toFixed(0)));
            }

            var percentLabelPlugin = {
                id: "percentLabelPlugin",
                afterDatasetsDraw: function(c) {
                    var ctx = c.ctx;
                    ctx.save();
                    ctx.font = "12px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    for (var di = 0; di < c.data.datasets.length; di++) {
                        var meta = c.getDatasetMeta(di);
                        if (!meta || !meta.data) continue;
                        for (var j = 0; j < meta.data.length; j++) {
                            var el = meta.data[j];
                            if (!el) continue;
                            var v = c.data.datasets[di].data[j];
                            if (!v || v < 3) continue;
                            var p = el.getProps(["x", "y"], true);
                            ctx.fillText(String(v) + "%", p.x, p.y);
                        }
                    }
                    ctx.restore();
                }
            };

            if (ageChart) ageChart.destroy();
            ageChart = new Chart(document.getElementById("ageStackChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "~10대",
                        data: dTeen,
                        stack: "s",
                        backgroundColor: "#4472C4"
                    }, {
                        label: "20대",
                        data: d20,
                        stack: "s",
                        backgroundColor: "#ED7D31"
                    }, {
                        label: "30대",
                        data: d30,
                        stack: "s",
                        backgroundColor: "#A5A5A5"
                    }, {
                        label: "40대",
                        data: d40,
                        stack: "s",
                        backgroundColor: "#FFC000"
                    }, {
                        label: "50대",
                        data: d50,
                        stack: "s",
                        backgroundColor: "#5B9BD5"
                    }, {
                        label: "60대~",
                        data: d60p,
                        stack: "s",
                        backgroundColor: "#70AD47"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ": " + ctx.raw + "%";
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(v) {
                                    return v + "%";
                                }
                            }
                        }
                    }
                },
                plugins: [percentLabelPlugin]
            });

            renderYouthChart();
            renderAgeDetailTable();
        }

        function loadData() {
            setStatus("데이터 불러오는 중…", true);

            tryFetchCsvFixedByUrls(DATA_URLS).then(function(res1) {
                rawRows = normalizeRows(res1.data);
                rebuildSelectors();
                refreshSigungu();

                return tryFetchCsvFixedByUrls(AGE_URLS).then(function(res2) {
                    rawAgeRows = normalizeAgeRows(res2.data);
                    renderAll();
                    renderAgeChartAndTable();
                });
            }).catch(function(e) {
                console.log(e);
                setStatus("오류: " + (e && e.message ? e.message : e), false);
            });
        }

        $(function() {
            $("#sidoSelect").on("change", function() {
                refreshSigungu();
                renderAll();
                renderAgeChartAndTable();
            });

            $("#sigunguSelect").on("change", function() {
                renderAll();
                renderAgeChartAndTable();
            });

            $("#sortMetric").on("change", function() {
                renderAll();
                renderAgeChartAndTable();
            });

            $("#ageSortMetric").on("change", function() {
                renderAgeChartAndTable();
            });

            $("#youthSortMetric").on("change", function() {
                renderYouthChart();
            });

            $("#emdFilter").on("input", function() {
                if (window.__t) clearTimeout(window.__t);
                window.__t = setTimeout(function() {
                    renderAll();
                    renderAgeChartAndTable();
                }, 200);
            });

            loadData();
        });
    </script>
</body>

</html>
