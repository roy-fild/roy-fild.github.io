<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>people.html</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- html2canvas (표를 이미지로 복사) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.8/css/dataTables.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.8/js/dataTables.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            background: #fafafa;
        }
        
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px;
        }
        
        h1 {
            margin: 0 0 6px 0;
            font-size: 22px;
        }
        
        .panel {
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }
        
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .col {
            flex: 1;
            min-width: 280px;
        }
        
        label {
            font-size: 12px;
            color: #555;
            display: block;
            margin-bottom: 6px;
        }
        
        select,
        input {
            width: 100%;
            padding: 10px 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #fff;
        }
        
        .kpis {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .kpi {
            flex: 1;
            min-width: 180px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 12px;
        }
        
        .kpi .t {
            font-size: 12px;
            color: #666;
        }
        
        .kpi .v {
            font-size: 20px;
            font-weight: 700;
            margin-top: 6px;
        }
        
        .kpi .s {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        .chartBox {
            height: 360px;
        }
        
        .muted {
            color: #888;
            font-size: 12px;
        }
        
        .status {
            margin-top: 8px;
            font-size: 12px;
        }
        
        .ok {
            color: #0a7a2f;
        }
        
        .err {
            color: #b00020;
        }
        
        table.dataTable {
            width: 100% !important;
        }
        /* ===== Copy Buttons ===== */
        
        .btnCopy {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid #d7d7d7;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            user-select: none;
        }
        
        .btnCopy:active {
            transform: translateY(1px);
        }
        
        .btnCopy[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* ===== Heat Table (white background for <=avg) ===== */
        
        .heatWrap {
            overflow: auto;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
        }
        
        table.heat {
            border-collapse: collapse;
            min-width: 820px;
            width: 100%;
            background: #fff;
        }
        
        table.heat th,
        table.heat td {
            border: 1px solid #cfcfcf;
            padding: 6px 8px;
            font-size: 14px;
            white-space: nowrap;
        }
        
        table.heat th {
            background: #f2f2f2;
            color: #000;
            font-weight: 700;
            text-align: center;
        }
        
        table.heat td.name {
            background: #f2f2f2;
            color: #000;
            font-weight: 700;
        }
        
        table.heat td.hit {
            background: #ffd0d8;
            color: #c00000;
            text-align: right;
            font-weight: 800;
        }
        
        table.heat td.miss {
            background: #ffffff;
            color: #444;
            text-align: right;
            font-weight: 600;
        }
        
        table.heat tr.avg td {
            background: #e9edf2;
            color: #000;
            font-weight: 800;
            text-align: right;
        }
        
        table.heat tr.avg td.name {
            text-align: left;
        }
        
        .top5Table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .top5Table th,
        .top5Table td {
            border-bottom: 1px solid #eee;
            padding: 8px 10px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .top5Table th {
            background: #f7f7f7;
            text-align: left;
            font-weight: 800;
        }
        
        .top5Table td.rank {
            width: 46px;
            text-align: right;
            font-weight: 800;
            color: #666;
        }
        
        .top5Table td.val {
            text-align: right;
            font-weight: 800;
        }
        
        .top5Table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>인구 통계 그래프(25.12)
            <div class="muted">by 필디</div>
        </h1>

        <div class="panel">
            <div class="row">
                <div class="col">
                    <label>시/도</label>
                    <select id="sidoSelect"></select>
                </div>
                <div class="col">
                    <label>시/군/구</label>
                    <select id="sigunguSelect"></select>
                </div>
                <div class="col">
                    <label>구/읍/면/동 검색 (선택)</label>
                    <input id="emdFilter" placeholder="예: 서초동 / 해운대구 / 청운효자동 등" />
                </div>
            </div>
            <div class="status" id="loadStatus"></div>
        </div>

        <div class="kpis" id="kpiRow">
            <div class="kpi">
                <div class="t">선택 영역</div>
                <div class="v" id="kpiArea">-</div>
                <div class="s" id="kpiAreaSub">-</div>
            </div>
            <div class="kpi">
                <div class="t">총인구수</div>
                <div class="v" id="kpiPop">-</div>
                <div class="s">그래프 표시 항목 합계(Top N)</div>
            </div>
            <div class="kpi">
                <div class="t">세대수</div>
                <div class="v" id="kpiHouse">-</div>
                <div class="s">그래프 표시 항목 합계(Top N)</div>
            </div>
            <div class="kpi">
                <div class="t">세대당 인구</div>
                <div class="v" id="kpiPph">-</div>
                <div class="s">총인구수/세대수로 산출</div>
            </div>
        </div>

        <div class="panel" id="panelBar">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div style="min-width:140px;">
                            <label>상위 N</label>
                            <input id="topNInput" type="number" min="1" max="50" step="1" value="25" style="width:100%; padding:10px 10px; border:1px solid #ddd; border-radius:10px; background:#fff;">
                        </div>
                        <div style="min-width:220px;">
                            <label>정렬 기준</label>
                            <select id="sortMetric">
                                <option value="pop">총인구수</option>
                                <option value="house">세대수</option>
                                <option value="pph">세대당 인구</option>
                            </select>
                        </div>

                        <div style="padding-top:18px;">
                            <button class="btnCopy" id="copyBarBtn" type="button">복사</button>
                        </div>
                    </div>

                    <div class="muted">선택 상태에 따라 시/도 → 시/군/구 → 읍/면/동 단위로 자동 집계</div>
                </div>
            </div>
            <div class="chartBox"><canvas id="barChart"></canvas></div>
        </div>

        <div class="panel" id="panelAge">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div>
                            <div style="font-weight:700;">연령대 비중(%) 100% 누적 막대</div>
                            <div class="muted">상단 그래프 집계 단위(시/도 or 시/군/구 or 동)와 동일 단위로 표시</div>
                        </div>

                        <div style="min-width:240px;">
                            <label>정렬 기준</label>
                            <select id="ageSortMetric">
                                <option value="popDesc">총인구 (내림)</option>
                                <option value="nameAsc">이름 (오름)</option>
                            </select>
                        </div>

                        <div style="padding-top:18px;">
                            <button class="btnCopy" id="copyAgeStackBtn" type="button">복사</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpis" style="margin-top:12px;">
                <div class="kpi">
                    <div class="t">연령 데이터 총인구 합</div>
                    <div class="v" id="kpiAgeTotal">-</div>
                    <div class="s">표시 항목 합계(Top N)</div>
                </div>
                <div class="kpi">
                    <div class="t">표시된 항목 개수</div>
                    <div class="v" id="kpiAgeDongCnt">-</div>
                    <div class="s">상단과 동일 단위</div>
                </div>
            </div>

            <div class="chartBox" style="height:520px; margin-top:10px;"><canvas id="ageStackChart"></canvas></div>

            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; margin-top:14px;">
                <div>
                    <div style="font-weight:700; margin:0 0 6px 0;">평균 기준 표 (평균 이상: 핑크 / 평균 이하: 흰색)</div>
                    <div class="muted">완성형 = 10 +30 + 40 + 50</div>
                </div>
                <div style="padding-top:6px;">
                    <button class="btnCopy" id="copyHeatBtn" type="button">복사</button>
                </div>
            </div>

            <div class="heatWrap" id="heatWrap">
                <table class="heat" id="ageHeatTable"></table>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; margin-top:14px;">
                <div>
                    <div style="font-weight:700;">청소년(0~9 / 10~19) 인구</div>
                    <div class="muted">상단 그래프 집계 단위와 동일 단위로 표시</div>
                </div>
                <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                    <div style="min-width:240px;">
                        <label>정렬 기준</label>
                        <select id="youthSortMetric">
                            <option value="sumDesc">총합 (내림차순)</option>
                            <option value="a0_9Desc">0~9세 (내림차순)</option>
                            <option value="a10_19Desc">10~19세 (내림차순)</option>
                        </select>
                    </div>
                    <div style="padding-top:18px;">
                        <button class="btnCopy" id="copyYouthBtn" type="button">복사</button>
                    </div>
                </div>
            </div>
            <div class="chartBox" style="height:420px; margin-top:10px;"><canvas id="youthChart"></canvas></div>
        </div>

        <!-- ✅ (추가) 아래 "상세 데이터(원천)" 나오기 직전에 그대로 삽입 -->
        <div class="panel" id="panelTop5">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="font-weight:700;">TOP 5 요약</div>
                    <div class="muted">상단 그래프(Top N)와 동일한 집계 단위/동일 항목 기준</div>
                </div>
            </div>

            <div class="row" style="margin-top:10px;">
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">인구 TOP 5</div>
                    <div id="top5_pop"></div>
                </div>
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">세대수 TOP 5</div>
                    <div id="top5_house"></div>
                </div>
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">세대당 인구 TOP 5</div>
                    <div id="top5_pph"></div>
                </div>
            </div>

            <div class="row" style="margin-top:12px;">
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">완성형 가족 비율 TOP 5</div>
                    <div id="top5_family"></div>
                </div>
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">0~9세 TOP 5</div>
                    <div id="top5_0_9"></div>
                </div>
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">10~19세 TOP 5</div>
                    <div id="top5_10_19"></div>
                </div>
            </div>

            <div class="row" style="margin-top:12px;">
                <div class="col">
                    <div style="font-weight:700; margin:0 0 6px 0;">(0~9 + 10~19) 총합 TOP 5</div>
                    <div id="top5_teen_sum"></div>
                </div>
                <div class="col"></div>
                <div class="col"></div>
            </div>
        </div>


        <!--  원천데이터 영역은 복사 기능 제외 -->
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div style="font-weight:700; margin-bottom:10px;">상세 데이터(원천)</div>
            <button class="btnCopy" id="excelDetailBtn" type="button">Excel</button>
        </div>
        <table id="detailTable" class="display"></table>


        <!-- (2)  "연령 데이터(원천)" 패널 제목줄 우측에 Excel 버튼 추가 -->
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div style="font-weight:700; margin-bottom:10px;">연령 데이터(원천)</div>
            <button class="btnCopy" id="excelAgeDetailBtn" type="button">Excel</button>
        </div>
        <table id="ageDetailTable" class="display"></table>

    </div>

    <script>
        var DATA_URLS = [
            "https://roy-fild.github.io/file/people/ingu_202512.csv",
            "https://roy-fild.github.io/file/people/ingu_202512"
        ];

        var AGE_URLS = [
            "https://roy-fild.github.io/file/people/ingu_age_202512.csv",
            "https://roy-fild.github.io/file/people/ingu_age_202512"
        ];

        // 그룹 옵션 값
        var SIDO_GROUP_METRO = "__GROUP_METRO__";
        var SIDO_GROUP_SMALL = "__GROUP_SMALL__";

        // 광역시(서울 제외) + 세종 포함
        var METRO_SIDOS = [
            "부산광역시", "대구광역시", "인천광역시", "광주광역시", "대전광역시", "울산광역시", "세종특별자치시"
        ];

        // 중소도시(경기도 제외) - 시군구 기준 매칭
        var SMALL_CITIES = ["창원", "청주", "천안", "전주", "김해", "포항"];

        var rawRows = [];
        var rawAgeRows = [];
        var barChart = null;
        var ageChart = null;
        var youthChart = null;
        var dt = null;
        var ageDt = null;

        // ✅ 상단 그래프(Top N) 기준으로 하단도 동일 단위/동일 항목으로 맞추기 위한 상태
        //    level: "sido" | "sigungu" | "emd"
        //    keys:  상단 그래프 라벨(Top N)
        var TOP_SCOPE = {
            level: "",
            keys: []
        };

        /* (3) ✅ CSV 다운로드 유틸 추가 (script 아무데나) */
        function csvEscape(v) {
            if (v === null || v === undefined) return "";
            var s = String(v);
            if (s.indexOf('"') >= 0) s = s.replace(/"/g, '""');
            if (/[",\n\r]/.test(s)) s = '"' + s + '"';
            return s;
        }

        function downloadCsv(filename, headers, rows) {
            // Excel 한글 깨짐 방지: UTF-8 BOM
            var lines = [];
            lines.push(headers.map(csvEscape).join(","));
            for (var i = 0; i < rows.length; i++) {
                lines.push(rows[i].map(csvEscape).join(","));
            }
            var csv = "\ufeff" + lines.join("\r\n");
            var blob = new Blob([csv], {
                type: "text/csv;charset=utf-8"
            });

            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * DataTables 인스턴스에서 "현재 필터/검색 적용된 전체 행"을 CSV로 다운로드
         * - 현재 페이지가 아니라, 필터된 전체(search applied) 기준
         */
        function exportDataTableToCsv(dtInstance, filename) {
            if (!dtInstance) return;

            var cols = dtInstance.settings()[0].aoColumns || [];
            var headers = [];
            for (var c = 0; c < cols.length; c++) headers.push(cols[c].sTitle || "");

            // 필터된 전체 행
            var data = dtInstance.rows({
                search: "applied"
            }).data().toArray();

            // 객체 → 컬럼 순서대로 배열화
            var rows = [];
            for (var i = 0; i < data.length; i++) {
                var rowObj = data[i];
                var rowArr = [];
                for (var c2 = 0; c2 < cols.length; c2++) {
                    var key = cols[c2].mData; // data key
                    var v = (key && rowObj && rowObj[key] !== undefined) ? rowObj[key] : "";
                    rowArr.push(v);
                }
                rows.push(rowArr);
            }

            downloadCsv(filename, headers, rows);
        }


        function shouldUseSummaryRows(rows, level) {
            var cnt = 0;

            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var sg = String(r.sigungu || "").trim();
                var emd = String(r.emd || "").trim();
                var sd = String(r.sido || "").trim();

                if (level === "sido") {
                    if (sd && !sg && !emd) cnt++;
                } else if (level === "sigungu") {
                    if (sg && !emd) cnt++;
                } else { // emd
                    if (emd) cnt++;
                }
            }

            // sido는 보통 10개 이상, sigungu는 10개 이상이면 합계행이 "있다"고 판단
            if (level === "sido") return cnt >= 10;
            if (level === "sigungu") return cnt >= 10;
            return true;
        }

        /**
         * ✅ 연령/청소년 집계용: level별로 "집계에 사용할 원천행"만 true
         * - 요약행이 충분하면 요약행(emd 빈 행)을 사용
         * - 요약행이 부족하면 하위행(emd 있는 동행)을 사용해서 상위로 roll-up
         */
        function isAgeSourceRowForLevel(r, level, useSummary) {
            var sg = String(r.sigungu || "").trim();
            var emd = String(r.emd || "").trim();
            var sd = String(r.sido || "").trim();

            if (level === "emd") return !!emd;

            if (level === "sigungu") {
                if (useSummary) return !!sg && !emd; // 구 합계행
                return !!sg && !!emd; // 동행을 모아 구로 집계
            }

            // level === "sido"
            if (useSummary) return !!sd && !sg && !emd; // 시도 합계행
            return !!sd && !!sg; // 구/동행을 모아 시도로 집계(둘 다 OK)
        }


        function getTopN() {
            var v = Number($("#topNInput").val());
            if (!v || v < 1) v = 25;
            if (v > 50) v = 50;
            return Math.floor(v);
        }

        function nf(x) {
            if (x === null || x === undefined || x === "") return 0;
            if (typeof x === "number") return x;
            return Number(String(x).replace(/,/g, "").trim()) || 0;
        }

        function fmt(n) {
            try {
                return (Number(n) || 0).toLocaleString("ko-KR");
            } catch (e) {
                return String(n);
            }
        }

        function safeText(s) {
            return (s === null || s === undefined) ? "" : String(s);
        }

        function setStatus(msg, ok) {
            $("#loadStatus").removeClass("ok err").addClass(ok ? "ok" : "err").text(msg);
        }

        function fetchTextWithEncoding(url, encoding) {
            return fetch(url, {
                    cache: "no-store"
                })
                .then(function(resp) {
                    if (!resp.ok) throw new Error("HTTP " + resp.status + " (" + url + ")");
                    return resp.arrayBuffer();
                })
                .then(function(buf) {
                    if (typeof TextDecoder === "undefined") throw new Error("TextDecoder not supported");
                    return new TextDecoder(encoding).decode(buf);
                });
        }

        function papaDownload(url) {
            return new Promise(function(resolve, reject) {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(res) {
                        if (res && res.data && res.data.length) resolve({
                            url: url,
                            encoding: "server/default",
                            data: res.data
                        });
                        else reject(new Error("Empty CSV (" + url + ")"));
                    },
                    error: function(err) {
                        reject(err || new Error("Papa download failed (" + url + ")"));
                    }
                });
            });
        }

        function tryFetchCsvFixedByUrls(urls) {
            return new Promise(function(resolve, reject) {
                var i = 0;

                function nextUrl() {
                    if (i >= urls.length) return reject(new Error("모든 URL에서 CSV를 불러오지 못했습니다."));
                    var u = urls[i++];
                    var encs = ["euc-kr", "windows-949", "utf-8"];
                    var j = 0;

                    function nextEnc() {
                        if (j >= encs.length) {
                            papaDownload(u).then(resolve).catch(function() {
                                nextUrl();
                            });
                            return;
                        }
                        var enc = encs[j++];
                        fetchTextWithEncoding(u, enc).then(function(text) {
                            var parsed = Papa.parse(text, {
                                header: true,
                                skipEmptyLines: true
                            });
                            if (parsed && parsed.data && parsed.data.length) resolve({
                                url: u,
                                encoding: enc,
                                data: parsed.data
                            });
                            else nextEnc();
                        }).catch(function() {
                            nextEnc();
                        });
                    }
                    nextEnc();
                }
                nextUrl();
            });
        }

        function normalizeRows(rows) {
            var cols = rows.length ? Object.keys(rows[0]) : [];
            var colSido = "행정구역";
            if ($.inArray(colSido, cols) < 0) colSido = cols[0];

            var colSigungu = null,
                colEmd = null;
            for (var k = 0; k < cols.length; k++) {
                if (!colSigungu && /Unnamed:\s*1/.test(cols[k])) colSigungu = cols[k];
                if (!colEmd && /Unnamed:\s*2/.test(cols[k])) colEmd = cols[k];
            }
            if (!colSigungu) colSigungu = cols[1];
            if (!colEmd) colEmd = cols[2];

            var colPop = null,
                colHouse = null,
                colPph = null;
            for (var k4 = 0; k4 < cols.length; k4++) {
                if (!colPop && (cols[k4] === "총인구수" || /총인구/.test(cols[k4]))) colPop = cols[k4];
                if (!colHouse && (cols[k4] === "세대수" || /세대수/.test(cols[k4]))) colHouse = cols[k4];
                if (!colPph && (cols[k4] === "세대당 인구" || /세대당/.test(cols[k4]))) colPph = cols[k4];
            }

            var out = [];
            for (var r = 0; r < rows.length; r++) {
                var row = rows[r];
                var sido = safeText(row[colSido]).trim();
                if (!sido) continue;
                out.push({
                    sido: sido,
                    sigungu: safeText(row[colSigungu]).trim(),
                    emd: safeText(row[colEmd]).trim(),
                    pop: nf(row[colPop]),
                    house: nf(row[colHouse]),
                    pph: nf(row[colPph])
                });
            }
            return out;
        }

        function uniq(arr) {
            var map = {},
                out = [];
            for (var i = 0; i < arr.length; i++) {
                var v = arr[i];
                if (v === null || v === undefined) continue;
                v = String(v).trim();
                if (!v) continue;
                if (!map[v]) {
                    map[v] = true;
                    out.push(v);
                }
            }
            return out;
        }

        // 그룹 필터 판정
        function getSidoGroupMode() {
            var v = $("#sidoSelect").val();
            if (v === SIDO_GROUP_METRO) return "metro";
            if (v === SIDO_GROUP_SMALL) return "small";
            return "";
        }

        // 그룹 기준으로 row 통과 여부
        function passSidoGroupFilter(row) {
            var mode = getSidoGroupMode();
            if (!mode) return true;

            if (mode === "metro") return $.inArray(row.sido, METRO_SIDOS) >= 0;

            if (row.sido === "경기도") return false;
            var sg = String(row.sigungu || "").trim();
            for (var i = 0; i < SMALL_CITIES.length; i++) {
                var c = SMALL_CITIES[i];
                if (sg.indexOf(c) === 0) return true;
            }
            return false;
        }

        function rebuildSelectors() {
            var sidos = uniq($.map(rawRows, function(r) {
                return r.sido;
            }));
            var $s = $("#sidoSelect");
            $s.empty();
            $s.append('<option value="">(전체)</option>');
            $s.append('<option value="' + SIDO_GROUP_METRO + '">광역시</option>');
            $s.append('<option value="' + SIDO_GROUP_SMALL + '">중소도시</option>');
            for (var i = 0; i < sidos.length; i++) $s.append('<option value="' + sidos[i] + '">' + sidos[i] + '</option>');
            $("#sigunguSelect").empty().append('<option value="">(전체)</option>');
        }

        function refreshSigungu() {
            var mode = getSidoGroupMode();
            if (mode) {
                $("#sigunguSelect").prop("disabled", true).html('<option value="">(전체)</option>').val("");
                return;
            }
            $("#sigunguSelect").prop("disabled", false);

            var sido = $("#sidoSelect").val();
            var list = [];
            for (var i = 0; i < rawRows.length; i++) {
                var r = rawRows[i];
                if (sido && r.sido !== sido) continue;
                list.push(r.sigungu);
            }
            list = uniq(list);

            var $g = $("#sigunguSelect");
            var cur = $g.val();
            $g.empty().append('<option value="">(전체)</option>');
            for (var j = 0; j < list.length; j++) $g.append('<option value="' + list[j] + '">' + list[j] + '</option>');
            for (var j2 = 0; j2 < list.length; j2++)
                if (list[j2] === cur) {
                    $g.val(cur);
                    break;
                }
        }

        function passTopScope(row, level) {
            if (!TOP_SCOPE || !TOP_SCOPE.level || !TOP_SCOPE.keys || !TOP_SCOPE.keys.length) return true;
            if (TOP_SCOPE.level !== level) return true;
            var key = (level === "sido") ? row.sido : (level === "sigungu") ? row.sigungu : row.emd;
            key = String(key || "").trim();
            if (!key) return false;
            return TOP_SCOPE.keys.indexOf(key) >= 0;
        }

        function filteredRows() {
            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();
            var mode = getSidoGroupMode();

            var q = $.trim($("#emdFilter").val());
            var qLower = q ? q.toLowerCase() : "";
            var hasQuery = !!qLower;
            var isGuSelected = !!sigungu;

            var out = [];
            for (var i = 0; i < rawRows.length; i++) {
                var r = rawRows[i];

                if (mode) {
                    if (!passSidoGroupFilter(r)) continue;
                } else {
                    if (sido && r.sido !== sido) continue;
                }

                if (!mode && sigungu && r.sigungu !== sigungu) continue;

                if (qLower) {
                    var hay = (r.sido + " " + r.sigungu + " " + r.emd).toLowerCase();
                    if (hay.indexOf(qLower) < 0) continue;
                }

                if ((isGuSelected || hasQuery) && /구$/.test(String(r.emd || "").trim())) continue;

                out.push(r);
            }
            return out;
        }

        function pickLevel() {
            var mode = getSidoGroupMode();
            var sigungu = $("#sigunguSelect").val();

            if (mode === "metro") return "sido";
            if (mode === "small") return "sigungu";

            if (sigungu) return "emd";
            var sido = $("#sidoSelect").val();
            if (sido) return "sigungu";
            return "sido";
        }

        function isBlank(v) {
            return v === null || v === undefined || String(v).trim() === "";
        }

        function isSourceRowForLevel(r, level) {
            var sg = String(r.sigungu || "").trim();
            var emd = String(r.emd || "").trim();
            if (level === "sido") return !isBlank(r.sido) && isBlank(sg) && isBlank(emd);
            if (level === "sigungu") return !isBlank(sg) && isBlank(emd);
            return !isBlank(emd);
        }

        function aggregate(rows, level) {
            var map = {};
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                if (!isSourceRowForLevel(r, level)) continue;

                var key = "";
                if (level === "emd") key = String(r.emd || "").trim();
                else if (level === "sigungu") key = String(r.sigungu || "").trim();
                else key = String(r.sido || "").trim();
                if (!key) continue;

                if (!map[key]) map[key] = {
                    name: key,
                    pop: 0,
                    house: 0,
                    pphSum: 0,
                    pphCnt: 0
                };
                map[key].pop += (r.pop || 0);
                map[key].house += (r.house || 0);
                if (r.pph) {
                    map[key].pphSum += r.pph;
                    map[key].pphCnt += 1;
                }
            }

            var out = [];
            for (var k in map)
                if (map.hasOwnProperty(k)) out.push({
                    name: map[k].name,
                    pop: map[k].pop,
                    house: map[k].house,
                    pph: map[k].pphCnt ? (map[k].pphSum / map[k].pphCnt) : 0
                });
            return out;
        }

        function renderBar() {
            var rows = filteredRows();
            var level = pickLevel();
            var agg = aggregate(rows, level);

            var metric = $("#sortMetric").val();
            agg.sort(function(a, b) {
                if (metric === "house") return b.house - a.house;
                if (metric === "pph") return b.pph - a.pph;
                return b.pop - a.pop;
            });

            var topN = getTopN();
            var top = agg.slice(0, topN);

            TOP_SCOPE.level = level;
            TOP_SCOPE.keys = $.map(top, function(x) {
                return x.name;
            });

            var popSum = 0,
                houseSum = 0;
            for (var ti = 0; ti < top.length; ti++) {
                popSum += (top[ti].pop || 0);
                houseSum += (top[ti].house || 0);
            }
            var pphSum = houseSum ? (popSum / houseSum) : 0;

            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();
            var mode = getSidoGroupMode();

            var area = "전체";
            var sub = "—";
            if (mode === "metro") {
                area = "광역시";
                sub = "서울 제외 광역시 (시 단위)";
            } else if (mode === "small") {
                area = "중소도시";
                sub = "경기도 제외: 창원/청주/천안/전주/김해/포항 (시 단위)";
            } else if (sido && sigungu) {
                area = sido + " / " + sigungu;
                sub = "선택 시/군/구 기준";
            } else if (sido) {
                area = sido;
                sub = "선택 시/도 기준";
            }

            $("#kpiArea").text(area);
            $("#kpiAreaSub").text(sub);
            $("#kpiPop").text(fmt(popSum));
            $("#kpiHouse").text(fmt(houseSum));
            $("#kpiPph").text(pphSum ? pphSum.toFixed(2) : "-");

            var labels = [],
                popData = [],
                houseData = [],
                pphData = [];
            for (var i = 0; i < top.length; i++) {
                labels.push(top[i].name);
                popData.push(top[i].pop);
                houseData.push(top[i].house);
                pphData.push(Number(top[i].pph ? top[i].pph.toFixed(2) : 0));
            }

            var lineValuePlugin = {
                id: "lineValuePlugin",
                afterDatasetsDraw: function(chart) {
                    var ctx = chart.ctx;
                    ctx.save();
                    ctx.font = "12px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "bottom";
                    var meta = chart.getDatasetMeta(2);
                    if (!meta || !meta.data) {
                        ctx.restore();
                        return;
                    }
                    for (var j = 0; j < meta.data.length; j++) {
                        var pt = meta.data[j];
                        if (!pt) continue;
                        var v = pphData[j];
                        if (v === null || v === undefined) continue;
                        ctx.fillText(String(v), pt.x, pt.y - 6);
                    }
                    ctx.restore();
                }
            };

            if (barChart) barChart.destroy();
            barChart = new Chart(document.getElementById("barChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        type: "bar",
                        label: "총인구수",
                        data: popData,
                        yAxisID: "y"
                    }, {
                        type: "bar",
                        label: "세대수",
                        data: houseData,
                        yAxisID: "y"
                    }, {
                        type: "line",
                        label: "세대당 인구",
                        data: pphData,
                        yAxisID: "y1",
                        tension: 0.25,
                        pointRadius: 3,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    var label = ctx.dataset.label || "";
                                    var v = ctx.raw;
                                    if (ctx.dataset.yAxisID === "y1") return label + ": " + v;
                                    return label + ": " + fmt(v);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            position: "left",
                            ticks: {
                                callback: function(v) {
                                    return fmt(v);
                                }
                            }
                        },
                        y1: {
                            position: "right",
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(v) {
                                    return v;
                                }
                            }
                        }
                    }
                },
                plugins: [lineValuePlugin]
            });
        }

        function renderTable() {
            var base = filteredRows();
            var level = pickLevel();

            var rows = [];
            for (var i = 0; i < base.length; i++) {
                if (!passTopScope(base[i], level)) continue;
                rows.push(base[i]);
            }

            var data = [];
            for (var i = 0; i < rows.length; i++) data.push({
                시도: rows[i].sido,
                시군구: rows[i].sigungu,
                읍면동: rows[i].emd,
                총인구수: rows[i].pop,
                세대수: rows[i].house,
                "세대당 인구": rows[i].pph
            });

            var columns = [{
                title: "시/도",
                data: "시도"
            }, {
                title: "시/군/구",
                data: "시군구"
            }, {
                title: "읍/면/동",
                data: "읍면동"
            }, {
                title: "총인구수",
                data: "총인구수",
                render: function(d) {
                    return fmt(d);
                }
            }, {
                title: "세대수",
                data: "세대수",
                render: function(d) {
                    return fmt(d);
                }
            }, {
                title: "세대당 인구",
                data: "세대당 인구",
                render: function(d) {
                    return d ? Number(d).toFixed(2) : "-";
                }
            }];

            if (dt) {
                dt.clear();
                dt.rows.add(data);
                dt.draw();
                return;
            }

            dt = new DataTable("#detailTable", {
                data: data,
                columns: columns,
                pageLength: 25,
                order: [
                    [3, "desc"]
                ],
                language: {
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "총 _TOTAL_개 중 _START_~_END_",
                    paginate: {
                        previous: "이전",
                        next: "다음"
                    },
                    emptyTable: "표시할 데이터가 없습니다."
                }
            });
        }

        function renderAll() {
            renderBar();
            renderTable();
            renderTop5Summary();
        }

        /* ========================= AGE ========================= */

        function normalizeAgeRows(rows) {
            var cols = rows.length ? Object.keys(rows[0]) : [];
            var colSido = "행정구역";
            if ($.inArray(colSido, cols) < 0) colSido = cols[0];

            var colSigungu = null,
                colEmd = null;
            for (var k = 0; k < cols.length; k++) {
                if (!colSigungu && /Unnamed:\s*1/.test(cols[k])) colSigungu = cols[k];
                if (!colEmd && /Unnamed:\s*2/.test(cols[k])) colEmd = cols[k];
            }
            if (!colSigungu) colSigungu = cols[1];
            if (!colEmd) colEmd = cols[2];

            function findCol(regex) {
                for (var i = 0; i < cols.length; i++)
                    if (regex.test(cols[i])) return cols[i];
                return null;
            }

            var c0_9 = findCol(/^0\s*~\s*9\s*세/);
            var c10_19 = findCol(/^10\s*~\s*19\s*세/);
            var c20_29 = findCol(/^20\s*~\s*29\s*세/);
            var c30_39 = findCol(/^30\s*~\s*39\s*세/);
            var c40_49 = findCol(/^40\s*~\s*49\s*세/);
            var c50_59 = findCol(/^50\s*~\s*59\s*세/);
            var c60_69 = findCol(/^60\s*~\s*69\s*세/);
            var c70_79 = findCol(/^70\s*~\s*79\s*세/);
            var c80_89 = findCol(/^80\s*~\s*89\s*세/);
            var c90_99 = findCol(/^90\s*~\s*99\s*세/);
            var c100p = findCol(/^100\s*세\s*이상/);
            if (!c100p) {
                for (var i2 = 0; i2 < cols.length; i2++) {
                    if (cols[i2].indexOf("100") >= 0 && cols[i2].indexOf("이상") >= 0) {
                        c100p = cols[i2];
                        break;
                    }
                }
            }

            var out = [];
            for (var r = 0; r < rows.length; r++) {
                var row = rows[r];
                var sido = safeText(row[colSido]).trim();
                if (!sido) continue;

                out.push({
                    sido: sido,
                    sigungu: safeText(row[colSigungu]).trim(),
                    emd: safeText(row[colEmd]).trim(),
                    a0_9: nf(row[c0_9]),
                    a10_19: nf(row[c10_19]),
                    a20_29: nf(row[c20_29]),
                    a30_39: nf(row[c30_39]),
                    a40_49: nf(row[c40_49]),
                    a50_59: nf(row[c50_59]),
                    a60_69: nf(row[c60_69]),
                    a70_79: nf(row[c70_79]),
                    a80_89: nf(row[c80_89]),
                    a90_99: nf(row[c90_99]),
                    a100p: nf(row[c100p])
                });
            }
            return out;
        }

        function filteredAgeRows() {
            var sido = $("#sidoSelect").val();
            var sigungu = $("#sigunguSelect").val();
            var mode = getSidoGroupMode();

            var q = $.trim($("#emdFilter").val());
            var qLower = q ? q.toLowerCase() : "";
            var hasQuery = !!qLower;
            var isGuSelected = !!sigungu;

            var out = [];
            for (var i = 0; i < rawAgeRows.length; i++) {
                var r = rawAgeRows[i];

                if (mode) {
                    if (!passSidoGroupFilter(r)) continue;
                } else {
                    if (sido && r.sido !== sido) continue;
                }

                if (!mode && sigungu && r.sigungu !== sigungu) continue;

                if (qLower) {
                    var hay = (r.sido + " " + r.sigungu + " " + r.emd).toLowerCase();
                    if (hay.indexOf(qLower) < 0) continue;
                }

                if ((isGuSelected || hasQuery) && /구$/.test(String(r.emd || "").trim())) continue;

                out.push(r);
            }
            return out;
        }

        function aggregateAge(rows, level) {
            var map = {};
            var useSummary = shouldUseSummaryRows(rows, level);
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                if (!isAgeSourceRowForLevel(r, level, useSummary)) continue;
                var key = "";
                if (level === "sido") key = String(r.sido || "").trim();
                else if (level === "sigungu") key = String(r.sigungu || "").trim();
                else key = String(r.emd || "").trim();
                if (!key) continue;

                if (!map[key]) map[key] = {
                    name: key,
                    teen: 0,
                    a20: 0,
                    a30: 0,
                    a40: 0,
                    a50: 0,
                    a60p: 0,
                    total: 0,
                    pTeen: 0,
                    p20: 0,
                    p30: 0,
                    p40: 0,
                    p50: 0,
                    p60p: 0,
                    pFamily: 0
                };

                var teen = (r.a0_9 || 0) + (r.a10_19 || 0);
                var a20 = (r.a20_29 || 0);
                var a30 = (r.a30_39 || 0);
                var a40 = (r.a40_49 || 0);
                var a50 = (r.a50_59 || 0);
                var a60p = (r.a60_69 || 0) + (r.a70_79 || 0) + (r.a80_89 || 0) + (r.a90_99 || 0) + (r.a100p || 0);

                map[key].teen += teen;
                map[key].a20 += a20;
                map[key].a30 += a30;
                map[key].a40 += a40;
                map[key].a50 += a50;
                map[key].a60p += a60p;
                map[key].total += (teen + a20 + a30 + a40 + a50 + a60p);
            }

            var out = [];
            for (var k in map) {
                if (!map.hasOwnProperty(k)) continue;
                var o = map[k];
                if (!o.total) continue;

                o.pTeen = (o.teen / o.total) * 100;
                o.p20 = (o.a20 / o.total) * 100;
                o.p30 = (o.a30 / o.total) * 100;
                o.p40 = (o.a40 / o.total) * 100;
                o.p50 = (o.a50 / o.total) * 100;
                o.p60p = (o.a60p / o.total) * 100;
                o.pFamily = ((o.teen + o.a30 + o.a40 + o.a50) / o.total) * 100;

                out.push(o);
            }

            var scoped = [];
            for (var i2 = 0; i2 < out.length; i2++) {
                if (TOP_SCOPE && TOP_SCOPE.level === level && TOP_SCOPE.keys && TOP_SCOPE.keys.length) {
                    if (TOP_SCOPE.keys.indexOf(out[i2].name) < 0) continue;
                }
                scoped.push(out[i2]);
            }
            return scoped;
        }

        function updateAgeKpis(agg) {
            var totalPop = 0;
            for (var i = 0; i < agg.length; i++) totalPop += agg[i].total;
            $("#kpiAgeTotal").text(fmt(totalPop));
            $("#kpiAgeDongCnt").text(fmt(agg.length));
        }

        function buildAgeHeatTable(agg) {
            var cols = [{
                key: "pTeen",
                title: "~10대"
            }, {
                key: "p20",
                title: "20대"
            }, {
                key: "p30",
                title: "30대"
            }, {
                key: "p40",
                title: "40대"
            }, {
                key: "p50",
                title: "50대"
            }, {
                key: "p60p",
                title: "60대~"
            }, {
                key: "pFamily",
                title: "완성형"
            }];

            if (!agg.length) {
                $("#ageHeatTable").html("");
                return;
            }

            var avg = {};
            for (var c = 0; c < cols.length; c++) avg[cols[c].key] = 0;
            for (var i = 0; i < agg.length; i++)
                for (var c2 = 0; c2 < cols.length; c2++) avg[cols[c2].key] += agg[i][cols[c2].key];
            for (var c3 = 0; c3 < cols.length; c3++) avg[cols[c3].key] = avg[cols[c3].key] / agg.length;

            var html = "";
            html += "<thead><tr><th></th>";
            for (var h = 0; h < cols.length; h++) html += "<th>" + cols[h].title + "</th>";
            html += "</tr></thead><tbody>";

            for (var r = 0; r < agg.length; r++) {
                html += "<tr>";
                html += "<td class='name'>" + agg[r].name + "</td>";
                for (var cc = 0; cc < cols.length; cc++) {
                    var k = cols[cc].key;
                    var v = Number(agg[r][k] || 0);
                    var txt = Math.round(v) + "%";
                    if (v >= avg[k]) html += "<td class='hit'>" + txt + "</td>";
                    else html += "<td class='miss'>" + txt + "</td>";
                }
                html += "</tr>";
            }

            html += "<tr class='avg'>";
            html += "<td class='name'> </td>";
            for (var a = 0; a < cols.length; a++) html += "<td>" + Math.round(avg[cols[a].key]) + "%</td>";
            html += "</tr>";

            html += "</tbody>";
            $("#ageHeatTable").html(html);
        }

        function aggregateYouth(rows, level) {
            var map = {};
            var useSummary = shouldUseSummaryRows(rows, level);
            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                if (!isAgeSourceRowForLevel(r, level, useSummary)) continue;

                var key = "";
                if (level === "sido") key = String(r.sido || "").trim();
                else if (level === "sigungu") key = String(r.sigungu || "").trim();
                else key = String(r.emd || "").trim();
                if (!key) continue;

                if (!map[key]) map[key] = {
                    name: key,
                    a0_9: 0,
                    a10_19: 0,
                    sum: 0
                };
                map[key].a0_9 += (r.a0_9 || 0);
                map[key].a10_19 += (r.a10_19 || 0);
                map[key].sum += ((r.a0_9 || 0) + (r.a10_19 || 0));
            }

            var out = [];
            for (var k in map)
                if (map.hasOwnProperty(k)) out.push(map[k]);

            var scoped = [];
            for (var i2 = 0; i2 < out.length; i2++) {
                if (TOP_SCOPE && TOP_SCOPE.level === level && TOP_SCOPE.keys && TOP_SCOPE.keys.length) {
                    if (TOP_SCOPE.keys.indexOf(out[i2].name) < 0) continue;
                }
                scoped.push(out[i2]);
            }
            return scoped;
        }

        function renderYouthChart() {
            var rows0 = filteredAgeRows();
            var level = pickLevel();
            var agg = aggregateYouth(rows0, level);

            var m = $("#youthSortMetric").val();
            agg.sort(function(a, b) {
                if (m === "a0_9Desc") return (b.a0_9 - a.a0_9);
                if (m === "a10_19Desc") return (b.a10_19 - a.a10_19);
                return (b.sum - a.sum);
            });

            var maxN = getTopN();
            if (agg.length > maxN) agg = agg.slice(0, maxN);

            var labels = [],
                d0_9 = [],
                d10_19 = [];
            for (var i = 0; i < agg.length; i++) {
                labels.push(agg[i].name);
                d0_9.push(agg[i].a0_9);
                d10_19.push(agg[i].a10_19);
            }

            if (youthChart) youthChart.destroy();
            youthChart = new Chart(document.getElementById("youthChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "0~9세",
                        data: d0_9
                    }, {
                        label: "10~19세",
                        data: d10_19
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ": " + fmt(ctx.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(v) {
                                    return fmt(v);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAgeDetailTable() {
            var base = filteredAgeRows();
            var level = pickLevel();

            var rows = [];
            for (var i = 0; i < base.length; i++) {
                var rr = base[i];
                if (TOP_SCOPE && TOP_SCOPE.level === level && TOP_SCOPE.keys && TOP_SCOPE.keys.length) {
                    var key = (level === "sido") ? rr.sido : (level === "sigungu") ? rr.sigungu : rr.emd;
                    key = String(key || "").trim();
                    if (TOP_SCOPE.keys.indexOf(key) < 0) continue;
                }
                rows.push(rr);
            }

            var data = [];
            for (var i = 0; i < rows.length; i++) {
                data.push({
                    시도: rows[i].sido,
                    시군구: rows[i].sigungu,
                    읍면동: rows[i].emd,
                    "0~9세": rows[i].a0_9,
                    "10~19세": rows[i].a10_19,
                    "20~29세": rows[i].a20_29,
                    "30~39세": rows[i].a30_39,
                    "40~49세": rows[i].a40_49,
                    "50~59세": rows[i].a50_59,
                    "60~69세": rows[i].a60_69,
                    "70~79세": rows[i].a70_79,
                    "80~89세": rows[i].a80_89,
                    "90~99세": rows[i].a90_99,
                    "100세 이상": rows[i].a100p
                });
            }

            var columns = [{
                title: "시/도",
                data: "시도"
            }, {
                title: "시/군/구",
                data: "시군구"
            }, {
                title: "읍/면/동",
                data: "읍면동"
            }, {
                title: "0~9세",
                data: "0~9세",
                render: fmt
            }, {
                title: "10~19세",
                data: "10~19세",
                render: fmt
            }, {
                title: "20~29세",
                data: "20~29세",
                render: fmt
            }, {
                title: "30~39세",
                data: "30~39세",
                render: fmt
            }, {
                title: "40~49세",
                data: "40~49세",
                render: fmt
            }, {
                title: "50~59세",
                data: "50~59세",
                render: fmt
            }, {
                title: "60~69세",
                data: "60~69세",
                render: fmt
            }, {
                title: "70~79세",
                data: "70~79세",
                render: fmt
            }, {
                title: "80~89세",
                data: "80~89세",
                render: fmt
            }, {
                title: "90~99세",
                data: "90~99세",
                render: fmt
            }, {
                title: "100세 이상",
                data: "100세 이상",
                render: fmt
            }];

            if (ageDt) {
                ageDt.clear();
                ageDt.rows.add(data);
                ageDt.draw();
                return;
            }

            ageDt = new DataTable("#ageDetailTable", {
                data: data,
                columns: columns,
                pageLength: 25,
                order: [
                    [3, "desc"]
                ],
                language: {
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "총 _TOTAL_개 중 _START_~_END_",
                    paginate: {
                        previous: "이전",
                        next: "다음"
                    },
                    emptyTable: "표시할 데이터가 없습니다."
                }
            });
        }

        function renderAgeChartAndTable() {
            var rows0 = filteredAgeRows();
            var level = pickLevel();
            var agg = aggregateAge(rows0, level);

            var m = $("#ageSortMetric").val();
            agg.sort(function(a, b) {
                if (m === "nameAsc") return String(a.name).localeCompare(String(b.name), "ko");
                return b.total - a.total;
            });

            var maxN = getTopN();
            if (agg.length > maxN) agg = agg.slice(0, maxN);

            updateAgeKpis(agg);
            buildAgeHeatTable(agg);

            var labels = [];
            var dTeen = [],
                d20 = [],
                d30 = [],
                d40 = [],
                d50 = [],
                d60p = [];
            for (var i = 0; i < agg.length; i++) {
                labels.push(agg[i].name);
                dTeen.push(Number(agg[i].pTeen.toFixed(0)));
                d20.push(Number(agg[i].p20.toFixed(0)));
                d30.push(Number(agg[i].p30.toFixed(0)));
                d40.push(Number(agg[i].p40.toFixed(0)));
                d50.push(Number(agg[i].p50.toFixed(0)));
                d60p.push(Number(agg[i].p60p.toFixed(0)));
            }

            var percentLabelPlugin = {
                id: "percentLabelPlugin",
                afterDatasetsDraw: function(c) {
                    var ctx = c.ctx;
                    ctx.save();
                    ctx.font = "12px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    for (var di = 0; di < c.data.datasets.length; di++) {
                        var meta = c.getDatasetMeta(di);
                        if (!meta || !meta.data) continue;

                        for (var j = 0; j < meta.data.length; j++) {
                            var el = meta.data[j];
                            if (!el) continue;

                            var v = c.data.datasets[di].data[j];
                            if (!v || v < 3) continue;

                            var props = el.getProps(["x", "y", "base"], true);
                            var midY = (props.y + props.base) / 2;
                            ctx.fillText(String(v) + "%", props.x, midY);
                        }
                    }
                    ctx.restore();
                }
            };

            if (ageChart) ageChart.destroy();
            ageChart = new Chart(document.getElementById("ageStackChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "~10대",
                        data: dTeen,
                        stack: "s",
                        backgroundColor: "#4472C4"
                    }, {
                        label: "20대",
                        data: d20,
                        stack: "s",
                        backgroundColor: "#ED7D31"
                    }, {
                        label: "30대",
                        data: d30,
                        stack: "s",
                        backgroundColor: "#A5A5A5"
                    }, {
                        label: "40대",
                        data: d40,
                        stack: "s",
                        backgroundColor: "#FFC000"
                    }, {
                        label: "50대",
                        data: d50,
                        stack: "s",
                        backgroundColor: "#5B9BD5"
                    }, {
                        label: "60대~",
                        data: d60p,
                        stack: "s",
                        backgroundColor: "#70AD47"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ": " + ctx.raw + "%";
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(v) {
                                    return v + "%";
                                }
                            }
                        }
                    }
                },
                plugins: [percentLabelPlugin]
            });

            renderYouthChart();
            renderAgeDetailTable();
        }

        /* ========================= COPY (PPT Ctrl+V) ========================= */

        function setCopyBusy($btn, busy) {
            if (!$btn || !$btn.length) return;
            $btn.prop("disabled", !!busy);
            $btn.text(busy ? "복사중..." : "복사");
        }

        function canvasToBlob(canvas, mime, quality) {
            return new Promise(function(resolve) {
                if (canvas.toBlob) {
                    canvas.toBlob(function(blob) {
                        resolve(blob);
                    }, mime || "image/png", quality || 0.92);
                } else {
                    // fallback
                    var dataUrl = canvas.toDataURL(mime || "image/png", quality || 0.92);
                    var bin = atob(dataUrl.split(",")[1]);
                    var len = bin.length;
                    var arr = new Uint8Array(len);
                    for (var i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
                    resolve(new Blob([arr], {
                        type: mime || "image/png"
                    }));
                }
            });
        }

        function upscaleCanvas(sourceCanvas, scale) {
            scale = scale || 2;
            var w = sourceCanvas.width || sourceCanvas.clientWidth;
            var h = sourceCanvas.height || sourceCanvas.clientHeight;

            var out = document.createElement("canvas");
            out.width = Math.round(w * scale);
            out.height = Math.round(h * scale);

            var ctx = out.getContext("2d");
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = "high";
            ctx.drawImage(sourceCanvas, 0, 0, out.width, out.height);
            return out;
        }

        function copyBlobToClipboard(blob) {
            if (!navigator.clipboard || !window.ClipboardItem) {
                return Promise.reject(new Error("Clipboard API not supported"));
            }
            return navigator.clipboard.write([new ClipboardItem({
                "image/png": blob
            })]);
        }

        function copyChartCanvasById(canvasId, $btn) {
            setCopyBusy($btn, true);
            try {
                var canvas = document.getElementById(canvasId);
                if (!canvas) throw new Error("Canvas not found: " + canvasId);

                var hi = upscaleCanvas(canvas, 2);
                return canvasToBlob(hi, "image/png", 0.98)
                    .then(copyBlobToClipboard)
                    .then(function() {
                        setStatus("복사 완료: PPT에서 Ctrl+V", true);
                    })
                    .catch(function(e) {
                        console.log(e);
                        setStatus("복사 실패(브라우저 권한/보안 설정 확인): " + (e && e.message ? e.message : e), false);
                    })
                    .finally(function() {
                        setCopyBusy($btn, false);
                    });
            } catch (e) {
                console.log(e);
                setStatus("복사 실패: " + (e && e.message ? e.message : e), false);
                setCopyBusy($btn, false);
                return Promise.resolve();
            }
        }

        function copyElementAsImage(el, $btn) {
            setCopyBusy($btn, true);
            return html2canvas(el, {
                backgroundColor: "#ffffff",
                scale: 2,
                useCORS: true
            }).then(function(canvas) {
                return canvasToBlob(canvas, "image/png", 0.98);
            }).then(copyBlobToClipboard).then(function() {
                setStatus("복사 완료: PPT에서 Ctrl+V", true);
            }).catch(function(e) {
                console.log(e);
                setStatus("복사 실패(브라우저 권한/보안 설정 확인): " + (e && e.message ? e.message : e), false);
            }).finally(function() {
                setCopyBusy($btn, false);
            });
        }

        function loadData() {
            tryFetchCsvFixedByUrls(DATA_URLS).then(function(res1) {
                rawRows = normalizeRows(res1.data);
                rebuildSelectors();
                refreshSigungu();

                return tryFetchCsvFixedByUrls(AGE_URLS).then(function(res2) {
                    rawAgeRows = normalizeAgeRows(res2.data);
                    renderAll();
                    renderAgeChartAndTable();
                    setStatus("로드 완료", true);
                });
            }).catch(function(e) {
                console.log(e);
                setStatus("오류: " + (e && e.message ? e.message : e), false);
            });
        }


        /* ✅ (추가) script 영역 아무데나(예: aggregateAge 아래) 그대로 추가 */
        function topN(arr, n, getValue) {
            var a = arr.slice(0);
            a.sort(function(x, y) {
                return (getValue(y) - getValue(x));
            });
            return a.slice(0, n);
        }

        function renderTop5Table($elId, titleValueLabel, items, valueFormatter) {
            var html = "";
            html += "<table class='top5Table'>";
            html += "<thead><tr><th style='width:46px;'>#</th><th>이름</th><th style='text-align:right;'>" + titleValueLabel + "</th></tr></thead>";
            html += "<tbody>";
            if (!items || !items.length) {
                html += "<tr><td class='rank'>-</td><td colspan='2' style='color:#888;'>표시할 데이터가 없습니다.</td></tr>";
            } else {
                for (var i = 0; i < items.length; i++) {
                    html += "<tr>";
                    html += "<td class='rank'>" + (i + 1) + "</td>";
                    html += "<td>" + safeText(items[i].name) + "</td>";
                    html += "<td class='val'>" + valueFormatter(items[i]) + "</td>";
                    html += "</tr>";
                }
            }
            html += "</tbody></table>";
            $("#" + $elId).html(html);
        }

        function renderTop5Summary() {
            // 상단(인구/세대/pph) 기준: 상단 그래프와 동일 단위/동일 항목
            var rows = filteredRows();
            var level = pickLevel();
            var agg = aggregate(rows, level);

            // TOP_SCOPE 반영(상단 그래프 Top N과 동일 항목)
            if (TOP_SCOPE && TOP_SCOPE.level === level && TOP_SCOPE.keys && TOP_SCOPE.keys.length) {
                var scoped = [];
                for (var i = 0; i < agg.length; i++) {
                    if (TOP_SCOPE.keys.indexOf(agg[i].name) >= 0) scoped.push(agg[i]);
                }
                agg = scoped;
            }

            // 인구/세대/pph TOP5
            var popTop = topN(agg, 5, function(o) {
                return o.pop || 0;
            });
            var houseTop = topN(agg, 5, function(o) {
                return o.house || 0;
            });
            var pphTop = topN(agg, 5, function(o) {
                return o.pph || 0;
            });

            renderTop5Table("top5_pop", "총인구수", popTop, function(o) {
                return fmt(o.pop || 0);
            });
            renderTop5Table("top5_house", "세대수", houseTop, function(o) {
                return fmt(o.house || 0);
            });
            renderTop5Table("top5_pph", "세대당", pphTop, function(o) {
                return (o.pph ? Number(o.pph).toFixed(2) : "0.00");
            });

            // 연령/완성가족/0-9/10-19/청소년합 TOP5: 연령 집계(상단과 동일 단위/동일 항목)
            var ageRows = filteredAgeRows();
            var ageAgg = aggregateAge(ageRows, level);

            // (이미 aggregateAge에서 TOP_SCOPE 반영하지만, 안전하게 한번 더)
            if (TOP_SCOPE && TOP_SCOPE.level === level && TOP_SCOPE.keys && TOP_SCOPE.keys.length) {
                var a2 = [];
                for (var j = 0; j < ageAgg.length; j++) {
                    if (TOP_SCOPE.keys.indexOf(ageAgg[j].name) >= 0) a2.push(ageAgg[j]);
                }
                ageAgg = a2;
            }

            // 완성가족(비율), 0-9(명), 10-19(명), 청소년합(명)
            var famTop = topN(ageAgg, 5, function(o) {
                return o.pFamily || 0;
            });
            var a0Top = topN(ageAgg, 5, function(o) {
                return (o.teen - (o.a10 || 0));
            }); // ❌ 잘못계산 방지 위해 아래에서 다시 정의
            // 위 줄은 쓰지 않고 아래에서 정확히 계산용 배열 생성

            var ageAgg2 = [];
            for (var k = 0; k < ageAgg.length; k++) {
                var o = ageAgg[k];
                ageAgg2.push({
                    name: o.name,
                    pFamily: o.pFamily || 0,
                    a0_9: Math.max(0, (o.teen || 0) - (o._a10_19 || 0)), // placeholder(없음) -> 아래에서 원천으로 다시 계산
                    a10_19: 0,
                    teenSum: o.teen || 0
                });
            }

            // 원천(동/구)에서 0-9, 10-19를 직접 집계(aggregateYouth가 이미 합계만 갖고있어서 별도 집계)
            // 같은 level / 동일 TOP_SCOPE 항목만
            var useSummary = shouldUseSummaryRows(ageRows, level);
            var map = {};
            for (var r = 0; r < ageRows.length; r++) {
                var rr = ageRows[r];
                if (!isAgeSourceRowForLevel(rr, level, useSummary)) continue;

                var key = (level === "sido") ? String(rr.sido || "").trim() :
                    (level === "sigungu") ? String(rr.sigungu || "").trim() :
                    String(rr.emd || "").trim();
                if (!key) continue;
                if (TOP_SCOPE && TOP_SCOPE.level === level && TOP_SCOPE.keys && TOP_SCOPE.keys.length) {
                    if (TOP_SCOPE.keys.indexOf(key) < 0) continue;
                }
                if (!map[key]) map[key] = {
                    name: key,
                    a0_9: 0,
                    a10_19: 0,
                    teenSum: 0,
                    pFamily: 0
                };
                map[key].a0_9 += (rr.a0_9 || 0);
                map[key].a10_19 += (rr.a10_19 || 0);
                map[key].teenSum += ((rr.a0_9 || 0) + (rr.a10_19 || 0));
            }

            // pFamily는 aggregateAge 결과에서 가져오기
            var famMap = {};
            for (var t = 0; t < ageAgg.length; t++) famMap[ageAgg[t].name] = (ageAgg[t].pFamily || 0);

            var ageList = [];
            for (var kk in map)
                if (map.hasOwnProperty(kk)) {
                    ageList.push({
                        name: map[kk].name,
                        a0_9: map[kk].a0_9,
                        a10_19: map[kk].a10_19,
                        teenSum: map[kk].teenSum,
                        pFamily: famMap[kk] || 0
                    });
                }

            var a0Top2 = topN(ageList, 5, function(o) {
                return o.a0_9 || 0;
            });
            var a10Top2 = topN(ageList, 5, function(o) {
                return o.a10_19 || 0;
            });
            var teenTop2 = topN(ageList, 5, function(o) {
                return o.teenSum || 0;
            });
            var famTop2 = topN(ageList, 5, function(o) {
                return o.pFamily || 0;
            });

            renderTop5Table("top5_family", "비율", famTop2, function(o) {
                return Math.round(o.pFamily || 0) + "%";
            });
            renderTop5Table("top5_0_9", "인구", a0Top2, function(o) {
                return fmt(o.a0_9 || 0);
            });
            renderTop5Table("top5_10_19", "인구", a10Top2, function(o) {
                return fmt(o.a10_19 || 0);
            });
            renderTop5Table("top5_teen_sum", "인구", teenTop2, function(o) {
                return fmt(o.teenSum || 0);
            });
        }


        $(function() {
            $("#sidoSelect").on("change", function() {
                $("#sigunguSelect").val("");
                refreshSigungu();
                renderAll();
                renderAgeChartAndTable();
            });

            $("#sigunguSelect").on("change", function() {
                renderAll();
                renderAgeChartAndTable();
            });

            $("#sortMetric").on("change", function() {
                renderAll();
                renderAgeChartAndTable();
            });

            $("#ageSortMetric").on("change", function() {
                renderAgeChartAndTable();
            });

            $("#youthSortMetric").on("change", function() {
                renderYouthChart();
            });

            $("#emdFilter").on("input", function() {
                if (window.__t) clearTimeout(window.__t);
                window.__t = setTimeout(function() {
                    renderAll();
                    renderAgeChartAndTable();
                }, 200);
            });

            $("#topNInput").on("input change", function() {
                if (window.__topn_t) clearTimeout(window.__topn_t);
                window.__topn_t = setTimeout(function() {
                    renderAll();
                    renderAgeChartAndTable();
                }, 120);
            });

            // ✅ 복사 버튼들 (원천데이터 제외)
            $("#copyBarBtn").on("click", function() {
                copyChartCanvasById("barChart", $("#copyBarBtn"));
            });

            $("#copyAgeStackBtn").on("click", function() {
                copyChartCanvasById("ageStackChart", $("#copyAgeStackBtn"));
            });

            $("#copyYouthBtn").on("click", function() {
                copyChartCanvasById("youthChart", $("#copyYouthBtn"));
            });

            $("#copyHeatBtn").on("click", function() {
                var el = document.getElementById("heatWrap");
                copyElementAsImage(el, $("#copyHeatBtn"));
            });

            $("#excelDetailBtn").on("click", function() {
                exportDataTableToCsv(dt, "ingu_detail.csv");
            });

            $("#excelAgeDetailBtn").on("click", function() {
                exportDataTableToCsv(ageDt, "ingu_age_detail.csv");
            });


            loadData();
        });
    </script>
</body>

</html>