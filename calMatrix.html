<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>매매가 대비 투자금 장표 생성기</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #eff4ff;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-sub: #4b5563;
            --radius-lg: 12px;
            --shadow-card: 0 8px 20px rgba(15, 23, 42, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            padding: 16px 20px 20px;
        }

        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
        }

        .header-meta {
            font-size: 11px;
            color: var(--text-sub);
        }

        .option-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            margin: 8px 0 10px;
        }

        .option-row label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .hint-text {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .file-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            margin-bottom: 6px;
        }

        input[type="file"] {
            font-size: 12px;
        }

        .version-text {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }

        /* 결과 영역 */
        .result-wrapper {
            margin-top: 16px;
        }

        .result-toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }

        .btn-primary {
            border: none;
            border-radius: 999px;
            background: var(--primary);
            color: #ffffff;
            font-size: 12px;
            padding: 6px 14px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(37, 99, 235, 0.4);
        }

        .btn-primary::before {
            content: "⬇";
            font-size: 11px;
        }

        .table-container {
            width: 100%;
            max-height: 75vh;          /* 한 모니터 안에 들어오도록 높이 제한 */
            overflow: auto;            /* 가로/세로 스크롤 */
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #ffffff;
        }

        table.result-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;       /* 열 너비 균등 분배 */
            font-size: 11px;
        }

        table.result-table thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        table.result-table th,
        table.result-table td {
            border: 1px solid var(--border);
            padding: 4px 6px;
            text-align: center;
            vertical-align: top;
            white-space: normal;
            word-break: keep-all;
        }

        table.result-table thead th {
            background: #f9fafb;
            color: var(--text-sub);
            font-weight: 600;
        }

        table.result-table tbody tr:nth-child(even) {
            background: #fdfdfd;
        }

        table.result-table tbody tr:hover {
            background: #eef2ff;
        }

        /* 헤더(첫 행) 고정 스타일: 실제로는 <thead>로 캐치 */
        .first-row-header th {
            position: sticky;
            top: 0;
        }

        @media (max-width: 768px) {
            .app {
                padding: 10px;
            }

            .card {
                padding: 14px;
            }

            .header-title {
                font-size: 16px;
            }

            .option-row {
                font-size: 13px;
            }

            table.result-table {
                font-size: 10px;
            }
        }
    </style>

    <script>
        // 결과 테이블 데이터 & 파일명을 전역으로 저장
        var currentTableData = null;
        var currentFileName = null;

        $(function () {
            // 기존 코드 유지 (txt_region이 없어도 에러는 안 남)
            $('#txt_region').val && $('#txt_region').val('S,A,B,C');
        });

        // 엑셀 자료 추출
        function excelExport(event) {

            var aptArr = [];
            let fileName = event.target.files[0].name.split(".").shift();
            let input = event.target;
            let reader = new FileReader();
            reader.onload = function () {
                let data = reader.result;
                let workBook = XLSX.read(data, { type: 'binary' });
                workBook.SheetNames.forEach(function (sheetName) {
                    console.log('SheetName: ' + sheetName);
                    let rows = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
                    var keys = Object.keys(rows);

                    for (var i = 0; i < keys.length; i++) {
                        var key = keys[i];
                        var subKeys = Object.keys(rows[key]);

                        var me = rows[key][subKeys[0]];    // 매매가
                        var ju = rows[key][subKeys[1]];    // 전세가
                        var label = rows[key][subKeys[2]]; // 라벨

                        var txt = me + "|" + ju + "|" + label;
                        aptArr.push(txt);
                    }

                    convertAptInfo(aptArr, fileName);

                })
            };
            reader.readAsBinaryString(input.files[0]);
        }

        function convertAptInfo(aptArr, fileName) {

            var selectedValue = $('input[name="option"]:checked').val();  

            var price = 20;    // 매매가 
            var contentsArr = [];

            var titArr = [];       // 투자금
            titArr.push(" ");

            // 수도권
            if (selectedValue === '1') {
                for (var i = 1; i <= 15; i++) {
                    var tit = i + '억대';
                    titArr.push(tit)
                }
            // 지방
            } else {
                for (var i = 0.1; i <= 3; i += 0.1) {
                    var tit = (i * 10).toFixed(0) + '천';
                    console.log(tit);
                    titArr.push(tit);
                }
            }

            contentsArr.push(titArr);

            // 수도권
            if (selectedValue === '1') {
                while (price > 1.4) {

                    var rowArr = [];
                    rowArr.push(price);

                    if (price == 20) {
                        rowArr = chkHighPrice(aptArr, rowArr);
                    } else {
                        rowArr = chkPrice(price, aptArr, rowArr);
                    }

                    price = price - 0.1;
                    price = price.toFixed(1);

                    contentsArr.push(rowArr);

                }
            // 지방
            } else {
                price = 10;
                while (price > 1.4) {

                    var rowArr = [];
                    rowArr.push(price);

                    if (price == 10) {
                        rowArr = chkHighPriceForSmall(aptArr, rowArr);
                    } else {
                        rowArr = chkPriceForSmall(price, aptArr, rowArr);
                    }

                    price = price - 0.1;
                    price = price.toFixed(1);

                    contentsArr.push(rowArr);

                } 
            }

            // 전역 변수에 저장 후 화면에 테이블과 버튼을 그린다.
            currentTableData = contentsArr;
            currentFileName = fileName;
            renderTable(contentsArr);
        }

        /******************수도권*********************/
        // 고가
        function chkHighPrice(aptArr, rowArr) {

            for (var j = 1; j <= 15; j++) {
                var label = "";
                for (var i = 0; i < aptArr.length; i++) {
                    var info = aptArr[i].split('|');

                    var me = info[0]; // 매매가
                    var ju = info[1]; // 전세가
                    var la = info[2]; // 라벨                        

                    // 차액
                    var s = Number(me) - Number(ju);
                    s = s.toFixed(0);

                    // 투자금 일치 가격이 높을경우
                    if (j == s && Number(me) > 19.9) {
                        if (label != '') {
                            label += "\n"
                        }
                        label += la;
                    }
                }
                rowArr.push(label);
            }

            return rowArr;
        }

        function chkPrice(price, aptArr, rowArr) {

            for (var j = 1; j <= 15; j++) {
                var label = "";
                for (var i = 0; i < aptArr.length; i++) {
                    var info = aptArr[i].split('|');

                    var me = info[0]; // 매매가
                    var ju = info[1]; // 전세가
                    var la = info[2]; // 라벨        

                    // 차액
                    var s = Number(me) - Number(ju);
                    s = s.toFixed(0);

                    // 투자금 일치 가격이 같을경우
                    if (j == s && Number(me).toFixed(1) == Number(price)) {
                        if (label != '') {
                            label += "\n"
                        }
                        label += la;
                    }
                }
                rowArr.push(label);
            }
            return rowArr;
        }

        /******************지방*********************/
        // 고가
        function chkHighPriceForSmall(aptArr, rowArr) {

            for (var j = 0.1; j <= 3; j += 0.1) {
                var label = "";
                for (var i = 0; i < aptArr.length; i++) {
                    var info = aptArr[i].split('|');

                    var me = info[0]; // 매매가
                    var ju = info[1]; // 전세가
                    var la = info[2]; // 라벨                        

                    // 차액
                    var s = Number(me) - Number(ju);
                    s = s.toFixed(1);

                    // 투자금 일치 가격이 높을경우
                    if (j == s && Number(me) > 9.9) {
                        if (label != '') {
                            label += "\n"
                        }
                        label += la;
                    }
                }
                rowArr.push(label);
            }

            return rowArr;
        }

        function chkPriceForSmall(price, aptArr, rowArr) {

            for (var j = 0.1; j <= 3; j += 0.1) {
                var label = "";
                for (var i = 0; i < aptArr.length; i++) {
                    var info = aptArr[i].split('|');

                    var me = info[0]; // 매매가
                    var ju = info[1]; // 전세가
                    var la = info[2]; // 라벨        

                    // 차액
                    var s = Number(me) - Number(ju);
                    s = s.toFixed(1);

                    // 투자금 일치 가격이 같을경우
                    if (j == s && Number(me).toFixed(1) == Number(price)) {
                        if (label != '') {
                            label += "\n"
                        }
                        label += la;
                    }
                }
                rowArr.push(label);
            }
            return rowArr;
        }

        // 화면에 테이블과 엑셀 버튼 렌더링
        function renderTable(contentsArr) {
            var html = "";

            if (!contentsArr || contentsArr.length === 0) {
                html = "<p style='font-size:13px; color:#6b7280;'>표시할 데이터가 없습니다.</p>";
                $('#resultArea').html(html);
                return;
            }

            html += '<div class="result-toolbar">';
            html += '  <button id="btnDownloadExcel" class="btn-primary" type="button" onclick="downloadExcel()">Excel 다운로드</button>';
            html += '</div>';

            html += '<div class="table-container">';
            html += '<table class="result-table">';

            for (var i = 0; i < contentsArr.length; i++) {
                // 첫 행을 thead로 분리해서 sticky header 적용
                if (i === 0) {
                    html += '<thead><tr class="first-row-header">';
                } else if (i === 1) {
                    html += '<tbody><tr>';
                } else {
                    html += '<tr>';
                }

                for (var j = 0; j < contentsArr[i].length; j++) {
                    var rawValue = contentsArr[i][j] == null ? "" : String(contentsArr[i][j]);
                    // 개행 문자(\n)를 <br>로 치환해서 UI에서도 줄바꿈으로 보이게
                    var cellValue = rawValue.replace(/\r?\n/g, '<br/>');

                    if (i === 0) {
                        html += '<th>' + cellValue + '</th>';
                    } else {
                        html += '<td>' + cellValue + '</td>';
                    }
                }

                html += '</tr>';
            }

            if (contentsArr.length > 1) {
                html += '</tbody>';
            }

            html += '</table>';
            html += '</div>';

            $('#resultArea').html(html);
        }

        // 엑셀 버튼 클릭 시 호출
        function downloadExcel() {
            if (!currentTableData || !currentFileName) {
                alert("다운로드할 데이터가 없습니다.");
                return;
            }
            downloadCSV(currentTableData, currentFileName);
        }

        function downloadCSV(contentsArr, f) {

            const worksheet = XLSX.utils.aoa_to_sheet(contentsArr);

            // 스타일 설정: 폰트 크기 9
            Object.keys(worksheet).forEach(cell => {
                if (cell[0] !== '!') {
                    worksheet[cell].s = {
                        font: { sz: 9 },
                        alignment: { wrapText: true }
                    };
                }
            });

            // 열 너비 자동 조정 (개행 문자 및 한글 고려)
            const colWidths = contentsArr[0].map((_, colIndex) => {
                const maxWidth = contentsArr.reduce((max, row) => {
                    const cellValue = row[colIndex] ? String(row[colIndex]) : "";
                    const lines = cellValue.split(/\r?\n/); // 개행 문자 기준 분할
                    const maxLineWidth = Math.max(...lines.map(line => {
                        return line.split('').reduce((acc, char) => {
                            return acc + (char.match(/[가-힣]/) ? 2 : 1); // 한글은 2배 너비로 계산
                        }, 0);
                    }));
                    return Math.max(max, maxLineWidth);
                }, 10); // 최소 너비 10 설정
                return { wch: maxWidth + 2 }; // 여백을 추가하여 가독성 향상
            });
            worksheet['!cols'] = colWidths;

            // 엑셀 파일 생성
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

            const fileName = f + "_result.xlsx";
            XLSX.writeFile(workbook, fileName);
        }
    </script>
</head>
<body>
    <div class="app">
        <div class="card">
            <div class="header-row">
                <div class="header-title">매매가 대비 투자금 장표 생성기</div>
                <div class="header-meta"><i>by 필디 · 2025.02.18 version</i></div>
            </div>

            <div class="option-row">
                <span class="hint-text">지역 선택</span>
                <label>
                    <input type="radio" name="option" value="1" checked> 수도권
                </label>
                <label>
                    <input type="radio" name="option" value="2"> 지방
                </label>
            </div>

            <div class="hint-text">엑셀 형식: 매매가 / 전세가 / 라벨 (3열)</div>
            <div class="file-row">
                <span>엑셀 파일 선택</span>
                <input type="file" id="excelFile" onchange="excelExport(event)" />
            </div>

            <div class="result-wrapper">
                <!-- 결과 테이블 & 엑셀 버튼이 들어갈 영역 -->
                <div id="resultArea"></div>
            </div>
        </div>
    </div>
</body>
</html>
