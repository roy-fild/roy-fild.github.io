<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>네이버 시세트레킹</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --thead-h: 0px;
            /* JS에서 동적으로 계산해서 채움 */
            --bg: #f5f5f5;
            --text: #73685d;
            --thead: #73685d;
            --thead-text: #fff;
            --radius: 4px;
            /* 둥근 정도도 살짝 줄임 */
            --shadow: 0 1px 3px rgba(0, 0, 0, .2);
            --toolbar-h: 30px;
            /* 툴바 높이 더 축소 */
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            padding: .35rem;
            /* .5rem → .35rem */
            background: var(--bg);
            font-size: .85rem;
            /* 전체 기본 폰트도 약간 축소 */
        }



        #loadingBar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #f3f3f3;
            z-index: 9999
        }

        #loadingProgress {
            height: 100%;
            width: 0;
            background: #4caf50;
            transition: width .4s ease
        }

        /* 버튼 색상 기존 유지 */
        .red_btn {
            background: red;
            color: #e5e5e5
        }

        .orange_btn {
            background: #FFA500
        }

        .lightSalmon_btn {
            background: lightsalmon;
        }

        .yellow_btn {
            background: yellow
        }

        .green_btn {
            background: green;
            color: #e5e5e5
        }

        .skyblue_btn {
            background: skyblue
        }

        .purple_btn {
            background: rgb(128, 0, 128);
            color: #e5e5e5
        }

        .darkslategrey_btn {
            background: rgb(47, 79, 79);
            color: #e5e5e5
        }

        .darkgoldenrod_btn {
            background: rgb(233, 172, 17)
        }

        .olivedrab_btn {
            background: rgb(107, 142, 35);
            color: #e5e5e5
        }

        .ligthseagreen_btn {
            background: rgb(32, 178, 170)
        }

        .grey_btn {
            background: rgb(128, 128, 128);
            color: #fff
        }

        .table-badges {
            position: absolute;
            top: 3px;
            left: 8px;
            display: flex;
            align-items: center;
            gap: .4rem;
            /* 배지 간 간격 */
            pointer-events: none;
            /* 배지 밑의 표 클릭 방해 안 함 */
        }


        button {
            border: 0;
            padding: .25rem .4rem;
            /* .35 .5 → .25 .4 */
            border-radius: 4px;
            /* 6px → 4px */
            margin: 1px;
            font-size: .8rem;
            /* .85rem → .8rem */
        }

        button:active {
            transform: translateY(1px)
        }

        .btn-row {
            gap: .2rem;
            /* .25rem → .2rem */
            margin: .2rem 0 .35rem;
            /* .25rem 0 .5rem → .2rem 0 .35rem */
        }

        .excel-container {
            display: flex;
            /* 추가 */
            align-items: center;
            /* 추가 */
            justify-content: space-between;
            /* 추가 */
            flex-wrap: nowrap;
            /* 추가: 줄바꿈 방지 */
            gap: .35rem;
            padding: .2rem .2rem;
            min-height: var(--toolbar-h);
            white-space: nowrap;
            /* 추가: 내부 요소 줄바꿈 방지 */
        }


        .left-span {
            flex: 1;
            /* 추가: 오른쪽 버튼 밀어내기 */
            min-width: 0;
            /* 추가: ellipsis 작동 */
            overflow: hidden;
            /* 추가 */
            text-overflow: ellipsis;
            /* 추가 */
            white-space: nowrap;
            /* 추가 */
            font-size: .95rem;
            color: #333;
        }

        .right-btns {
            margin-left: auto;
            /* 추가: 우측 정렬 */
            display: flex;
            /* 추가 */
            align-items: center;
            /* 추가 */
            gap: .35rem;
            /* 추가 */
            white-space: nowrap;
            /* 추가 */
        }

        .table-wrap {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        table {
            min-width: 1040px;
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: var(--toolbar-h);
            z-index: 5;
            background: var(--thead);
            color: var(--thead-text);
        }

        #tbl_aptInfo tbody::before {
            content: "";
            display: block;
            height: calc(var(--thead-h) + 4px);
            /* 약간 여유 */
        }


        th,
        td {
            padding: .35rem .35rem;
            /* .5 .45 → .35 .35 */
            font-size: .82rem;
            /* .93rem → .82rem */
        }

        td {
            background: #fff;
            color: #222
        }

        a {
            color: var(--text);
            text-decoration: none
        }

        a:hover {
            text-decoration: underline
        }

        thead input {
            max-width: 140px;
            /* 160px → 140px */
            padding: .25rem .3rem;
            /* .3 .35 → .25 .3 */
            font-size: .8rem;
            /* .88rem → .8rem */
        }

        .table-wrap {
            position: relative;
            /* 배지 절대배치 기준 */
        }

        /* TOTAL 배지 */
        #aptCntBadge,
        #update {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: .15rem .45rem;
            font-size: .78rem;
            color: #555;
            box-shadow: var(--shadow);
        }


        @media (max-width: 768px) {
            body {
                padding: .35rem;
            }

            /* .75rem → .5rem */

            table {
                min-width: 960px
            }
        }

        @media (max-width: 480px) {
            table {
                min-width: 900px
            }
        }

        /* ▼ 모바일(≤768px): 겹침 방지 - 가로 스크롤 허용 + 줄바꿈 */
        @media (max-width: 768px) {
            .table-wrap {
                overflow-x: auto;
                /* 필요할 때만 가로 스크롤 */
            }

            table {
                min-width: 0 !important;
                /* 강제 최소폭 제거 */
                width: auto;
                /* 내용에 맞게 */
                table-layout: auto;
                /* 글자 길이에 따라 폭 자동 */
            }

            th,
            td {
                padding: .36rem .34rem;
                font-size: .82rem;
                line-height: 1.3;
                vertical-align: top;
                white-space: nowrap;
                /* 기본은 줄바꿈 안 함 */
            }

            /* 동, 단지명은 줄바꿈 허용 */
            #tbl_aptInfo thead tr th:nth-child(3),
            #tbl_aptInfo thead tr th:nth-child(4),
            #tbl_aptInfo tbody tr td:nth-child(3),
            #tbl_aptInfo tbody tr td:nth-child(4) {
                white-space: normal;
                word-break: keep-all;
            }

            /* ─ 숨길 칼럼은 그대로 유지 ─ */
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(1),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(2),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(8),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(9),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(14),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(15),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(16),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(17),
            #tbl_aptInfo thead tr:not(.filter-row) th:nth-child(18),
            #tbl_aptInfo tbody tr td:nth-child(1),
            #tbl_aptInfo tbody tr td:nth-child(2),
            #tbl_aptInfo tbody tr td:nth-child(8),
            #tbl_aptInfo tbody tr td:nth-child(9),
            #tbl_aptInfo tbody tr td:nth-child(14),
            #tbl_aptInfo tbody tr td:nth-child(15),
            #tbl_aptInfo tbody tr td:nth-child(16),
            #tbl_aptInfo tbody tr td:nth-child(17),
            #tbl_aptInfo tbody tr td:nth-child(18) {
                display: none;
            }

            #tbl_aptInfo thead tr.filter-row th:nth-child(1),
            #tbl_aptInfo thead tr.filter-row th:nth-child(2),
            #tbl_aptInfo thead tr.filter-row th:nth-child(8),
            #tbl_aptInfo thead tr.filter-row th:nth-child(9),
            #tbl_aptInfo thead tr.filter-row th:nth-child(14),
            #tbl_aptInfo thead tr.filter-row th:nth-child(15),
            #tbl_aptInfo thead tr.filter-row th:nth-child(16),
            #tbl_aptInfo thead tr.filter-row th:nth-child(17),
            #tbl_aptInfo thead tr.filter-row th:nth-child(18) {
                display: none;
            }

            /* 동 */
            #tbl_aptInfo thead tr th:nth-child(3),
            #tbl_aptInfo tbody tr td:nth-child(3) {
                width: 60px;
                /* 기본 폭 */
                max-width: 70px;
                /* 상한 */
                white-space: normal;
                /* 줄바꿈 허용 */
                word-break: keep-all;
                text-align: center;
            }

            /* 단지명: 조금 더 좁게, 최대 2줄 */
            #tbl_aptInfo thead tr th:nth-child(4),
            #tbl_aptInfo tbody tr td:nth-child(4) {
                width: 110px;
                /* 이전보다 더 줄임 */
                max-width: 120px;
                white-space: normal;
                word-break: keep-all;
            }

            #tbl_aptInfo tbody tr td:nth-child(4) a {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                /* 최대 2줄 */
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* 세대 */
            #tbl_aptInfo thead tr th:nth-child(6),
            #tbl_aptInfo tbody tr td:nth-child(6) {
                width: 50px;
                /* 좁게 */
                max-width: 50px;
                text-align: right;
                /* 숫자 우측정렬 */
                white-space: nowrap;
                text-align: center;
            }

            /* 타입 */
            #tbl_aptInfo thead tr th:nth-child(7),
            #tbl_aptInfo tbody tr td:nth-child(7) {
                width: 56px;
                /* 더 좁게 */
                max-width: 64px;
                text-align: center;
                white-space: nowrap;
                /* 타입은 한 줄 유지 */
            }

            /* thead 필터 input 공통 */
            #tbl_aptInfo thead input {
                font-size: .75rem;
                /* 글자 크기 살짝 축소 */
                padding: .2rem .25rem;
                /* 안쪽 여백 줄임 */
            }

            /* 동 */
            #filterDong {
                max-width: 60px !important;
            }

            /* 단지명 */
            #filterAptNm {
                max-width: 120px !important;
            }

            /* 타입 */
            #filterSize {
                max-width: 50px !important;
            }

            /* 매매가 */
            #filterPrice {
                max-width: 60px !important;
            }

            /* 차액 */
            #filterGap {
                max-width: 60px !important;
            }

            #update {
                font-size: .65rem;
            }

            #aptCnt {
                font-size: .65rem;
            }

            #aptCntBadge,
            #update {
                font-size: .7rem;
            }

        }
    </style>
</head>

<body>
    <div id="loadingBar" style="display:none;">
        <div id="loadingProgress"></div>
    </div>

    <div id="btn-wrapper">
        <div class="btn-row">
            <label><input type="radio" name="option" value="t" checked> Tracking</label>
            <label><input type="radio" name="option" value="c"> Compare</label>
            <button id="btn_new_window" class="grey_btn">새창</button>
            <label><input id="chkBigType" type="checkbox">59~84</label>
        </div>

        <div class="btn-row">
            <b>전체</b>
            <button id="btn_all_seoul" class="lightSalmon_btn">서울</button>
            <button id="btn_all_sudo" class="lightSalmon_btn">수도권</button>
            <button id="btn_all_jibang" class="lightSalmon_btn">지방</button>
        </div>

        <div class="btn-row">
            <b>정찰기</b>
            <button id="btn_observer-sudo" class="purple_btn">수도권</button>
            <button id="btn_observer-jibang" class="purple_btn">지방</button>
        </div>

        <!-- 서울/수도권/광역시/지방 버튼 영역 (생략 없이 기존과 동일하게 추가) -->
        <div class="btn-row" id="div_seoul">
            <b></b>
            <input type="hidden" id="hdn_sel-gu" />
            <button id="btn_songpa-gu" class="red_btn">송파구</button>
            <button id="btn_seongdong-gu" class="orange_btn">성동구</button>
            <button id="btn_yangcheon-gu" class="orange_btn">양천구</button>
            <button id="btn_bundang-gu" class="orange_btn">분당구</button>
            <button id="btn_jongno-jung-gu" class="yellow_btn">종로/중구</button>
            <button id="btn_dongjak-gu" class="yellow_btn">동작구</button>
            <button id="btn_yeongdeungpo-gu" class="yellow_btn">영등포구</button>
            <button id="btn_seong-buk-gu" class="green_btn">성북구</button>
            <button id="btn_dongdaemun-gu" class="green_btn">동대문구</button>
            <button id="btn_seodaemun-gu" class="green_btn">서대문구</button>
            <button id="btn_gwanak-gu" class="green_btn">관악구</button>
            <button id="btn_eunpyeong-gu" class="skyblue_btn">은평구</button>
            <button id="btn_jungnang-gu" class="skyblue_btn">중랑구</button>
            <button id="btn_guro-gu" class="skyblue_btn">구로구</button>
        </div>
        <div class="btn-row" id="div_suedo">
            <b></b>
            <button id="btn_suji-gu" class="darkslategrey_btn">수지구</button>
            <button id="btn_dongtan" class="darkslategrey_btn">동탄</button>
            <button id="btn_sujeong-jungwon-gu" class="darkslategrey_btn">수정/중원구</button>
            <button id="btn_anyang-si-dongan-gu" class="darkslategrey_btn">안양시-동안구</button>
            <button id="btn_suwon-si-yeongtong-gu" class="darkslategrey_btn">수원시-영통구</button>
        </div>
        <div class="btn-row" id="div_metro">
            <b></b>
            <b>대전[145만]</b>
            <button id="btn_daejeon-seo-gu" class="darkgoldenrod_btn">서구</button>
            <button id="btn_daejeon-yuseong-gu" class="darkgoldenrod_btn">유성구</button>
            <b>광주[143만]</b>
            <button id="btn_gwangju-buk-gu" class="darkgoldenrod_btn">북구</button>
        </div>
        <div class="btn-row" id="div_jibang">
            <b></b>
            <button id="btn_cheongju" class="ligthseagreen_btn">청주[85만]흥덕구/청원구/상당구</button>
            <button id="btn_jeonju" class="ligthseagreen_btn">전주[65만]덕진구/완산구</button>
            <button id="btn_cheonan" class="ligthseagreen_btn">천안[66만]서북구/동남구</button>
            <button id="btn_pohang-si-buk-gu" class="ligthseagreen_btn">포항-북구[27만]</button>
        </div>
        <!-- ... 버튼 코드들은 그대로 두시면 됩니다 ... -->
    </div>
    <div class="excel-container">
        <div class="left-span">
            <button id="btn_toggle" class="grey_btn" data-no-loading="true">▲ 접기</button>
            <button id="btn_sort" class="grey_btn" data-no-loading="true">정렬 ▼</button>

        </div>
        <div class="right-btns">
            <button id="excelDownload" class="green_btn">EXCEL</button>
            <button id="btn_init" class="grey_btn" data-no-loading="true">초기화</button>

        </div>
    </div>

    <div id="result" class="table-wrap">
        <div class="table-badges">
            <div id="aptCntBadge"></div>
            <span id="update"></span>
        </div>
        <table id="tbl_aptInfo">
            <thead> <!-- ▼ 필터 입력 행 (복구됨) -->
                <tr class="filter-row">
                    <th style="width:80px"><label style="display:flex;align-items:center;gap:.35rem;"></th>
                    <th></th>
                    <th><input id="filterDong" type="text" placeholder="동" style="max-width:80px;"></th>
                    <th><input id="filterAptNm" type="text" placeholder="단지명" style="max-width:180px;"></th>
                    <th></th>
                    <th style="width:90px"><label style="display:flex;align-items:center;gap:.35rem;"><input
                                id="filter300" type="checkbox">300^</label></th>
                    <th style="width:90px">
                        <input id="filterSize" type="text" inputmode="numeric" pattern="\\d*\\.?\\d*"
                            oninput="this.value=this.value.replace(/[^0-9.]/g,'');" placeholder="타입"
                            style="max-width:70px;" maxlength="3">
                    </th>
                    <th></th>
                    <th></th>
                    <th>
                        <input id="filterPrice" type="text" inputmode="decimal" pattern="\\d*\\.?\\d*"
                            oninput="this.value=this.value.replace(/[^0-9.]/g,'');" placeholder="매매가"
                            style="max-width:70px;" maxlength="4">
                    </th>
                    <th></th>
                    <th>
                        <input id="filterGap" type="text" inputmode="decimal" pattern="\\d*\\.?\\d*"
                            oninput="this.value=this.value.replace(/[^0-9.]/g,'');" placeholder="차액"
                            style="max-width:70px;" maxlength="4">
                    </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                <!-- ▼ 컬럼 헤더 행 -->
                <tr>
                    <th>ID</th>
                    <th>구</th>
                    <th>동</th>
                    <th>단지명</th>
                    <th>연식</th>
                    <th>세대</th>
                    <th>타입</th>
                    <th>유형</th>
                    <th>방</th>
                    <th>매매</th>
                    <th>전세</th>
                    <th>차액</th>
                    <th>전세가율</th>
                    <th>매매</th>
                    <th>전세</th>
                    <th>매/층</th>
                    <th>전/층</th>
                    <th>설명</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>


        function getLatestFile(baseName) {
            const listUrl = "https://roy-fild.github.io/tracking/result/fileList.json";
            const baseUrl = "https://roy-fild.github.io/tracking/result/";

            return $.getJSON(listUrl)
                .then(function (files) {
                    // baseName 으로 시작하고 .xlsx 로 끝나는 파일만 필터
                    let matchedFiles = files.filter(f => f.startsWith(baseName) && f.endsWith(".xlsx"));

                    if (matchedFiles.length === 0) {
                        alert(baseName + " 관련 파일이 없습니다.");
                        return null;
                    }

                    // 최신 날짜 기준 정렬 (yyyymmdd 비교)
                    matchedFiles.sort(function (a, b) {
                        let dateA = (a.match(/_(\d{8})\.xlsx$/) || [, ''])[1];
                        let dateB = (b.match(/_(\d{8})\.xlsx$/) || [, ''])[1];
                        return dateB.localeCompare(dateA); // 내림차순
                    });

                    // 최신 파일
                    let latestFile = matchedFiles[0];
                    // console.log(latestFile);
                    return baseUrl + latestFile;
                })
                .catch(function () {
                    alert("파일 목록을 불러올 수 없습니다.");
                    return null;
                });
        }

        $(document).ready(function () {

            // ✅ thead 전체 높이를 계산해서 CSS 변수 --thead-h 로 반영
            function updateTheadHeight() {
                const thead = document.querySelector('#tbl_aptInfo thead');
                const h = thead ? thead.getBoundingClientRect().height : 0;
                document.documentElement.style.setProperty('--thead-h', `${Math.round(h)}px`);
            }

            // 최초 1회
            updateTheadHeight();

            // 창 크기 변경 시(모바일/PC 전환, 확대/축소 등)
            window.addEventListener('resize', updateTheadHeight);

            // thead 내부 입력창 변화(줄바꿈, 글꼴 크기 변화 등)에도 대응
            const theadObserver = new MutationObserver(updateTheadHeight);
            theadObserver.observe(document.querySelector('#tbl_aptInfo thead'), { childList: true, subtree: true });

            // 필터/정렬/데이터 로딩 끝날 때도 갱신
            $(document).ajaxStop(updateTheadHeight);
            $('#filter300, #chkBigType, #filterPrice, #filterGap, #filterSize, #filterAptNm, #filterDong')
                .on('input change', updateTheadHeight);
            $('#btn_sort, #btn_toggle').on('click', updateTheadHeight);


            // 버튼 토글 (접기/펼치기)
            $('#btn_toggle').on('click', function () {
                $('#btn-wrapper').toggle();
                if ($('#btn-wrapper').is(':visible')) {
                    $(this).text('▲ 접기');
                } else {
                    $(this).text('▼ 펼치기');
                }
            });
            // 버튼 개수 세기
            var btnSeoulCnt = $("#div_seoul button").length;
            var btnSuedoCnt = $("#div_suedo button").length;
            var btnMetroCnt = $("#div_metro button").length;
            var btnJibangCnt = $("#div_jibang button").length;

            // <b> 태그 내용 업데이트
            $("#div_seoul > b").text("서울시(" + btnSeoulCnt + ")");    // 서울시
            $("#div_suedo > b").text("수도권(" + btnSuedoCnt + ")");    // 수도권
            $("#div_metro > b").eq(0).text("광역시(" + btnMetroCnt + ")");    // 광역시
            $("#div_jibang > b").text("지방(" + btnJibangCnt + ")");    // 지방

            // 새창 띄우기
            $('#btn_new_window').on('click', function (e) {
                e.preventDefault();
                var currentUrl = window.location.href;
                window.open(currentUrl, '_blank');
            });


            // 정찰기(수도권)
            $('#btn_observer-sudo').on('click', function () {
                $('#hdn_sel-gu').val('정찰기-수도권');
                let gu = "tracking-list";
                $('#chk').prop('checked', false);
                beforeSearch(gu);
            });

            // 정찰기(지방)
            $('#btn_observer-jibang').on('click', function () {
                $('#hdn_sel-gu').val('정찰기-지방');
                let gu = "tracking-jibang";
                $('#chk').prop('checked', false);
                beforeSearch(gu);
            });

            /************************************
             *  수도권
             ************************************/

            // 송파구
            $('#btn_songpa-gu').on('click', function () {
                $('#hdn_sel-gu').val('송파구');
                let gu = "songpa-gu";
                beforeSearch(gu);
            });

            // 성동구           
            $('#btn_seongdong-gu').on('click', function () {
                $('#hdn_sel-gu').val('성동구');
                let gu = "seongdong-gu";
                beforeSearch(gu);
            });

            // 양천구
            $('#btn_yangcheon-gu').on('click', function () {
                $('#hdn_sel-gu').val('양천구');
                let gu = "yangcheon-gu";
                beforeSearch(gu);
            });

            // 종로/중구
            $('#btn_jongno-jung-gu').on('click', function () {
                $('#hdn_sel-gu').val('종로중구');
                let gu = "jongno-jung-gu";
                beforeSearch(gu);
            });

            // 분당구
            $('#btn_bundang-gu').on('click', function () {
                $('#hdn_sel-gu').val('분당구');
                let gu = "bundang-gu";
                beforeSearch(gu);
            });

            // 동작구
            $('#btn_dongjak-gu').on('click', function () {
                $('#hdn_sel-gu').val('동작구');
                let gu = "dongjak-gu";
                beforeSearch(gu);
            });
            // 영등포구
            $('#btn_yeongdeungpo-gu').on('click', function () {
                $('#hdn_sel-gu').val('영등포구');
                let gu = "yeongdeungpo-gu";
                beforeSearch(gu);
            });

            // 서대문구
            $('#btn_seodaemun-gu').on('click', function () {
                $('#hdn_sel-gu').val('서대문구');
                let gu = "seodaemun-gu";
                beforeSearch(gu);
            });

            // 성북구
            $('#btn_seong-buk-gu').on('click', function () {
                $('#hdn_sel-gu').val('성북구');
                let gu = "seong-buk-gu";
                beforeSearch(gu);
            });

            // 동대문구
            $('#btn_dongdaemun-gu').on('click', function () {
                $('#hdn_sel-gu').val('동대문구');
                let gu = "dongdaemun-gu";
                beforeSearch(gu);
            });

            // 관악구
            $('#btn_gwanak-gu').on('click', function () {
                $('#hdn_sel-gu').val('관악구');
                let gu = "gwanak-gu";
                beforeSearch(gu);
            });

            // 은평구
            $('#btn_eunpyeong-gu').on('click', function () {
                $('#hdn_sel-gu').val('은평구');
                let gu = "eunpyeong-gu";
                beforeSearch(gu);
            });

            // 중랑구
            $('#btn_jungnang-gu').on('click', function () {
                $('#hdn_sel-gu').val('중랑구');
                let gu = "jungnang-gu";
                beforeSearch(gu);
            });

            // 구로구
            $('#btn_guro-gu').on('click', function () {
                $('#hdn_sel-gu').val('구로구');
                let gu = "guro-gu";
                beforeSearch(gu);
            });


            /************************************
             * 경기도
             ************************************/

            // 수지구
            $('#btn_suji-gu').on('click', function () {
                $('#hdn_sel-gu').val('수지구');
                let gu = "suji-gu";
                beforeSearch(gu);
            });

            // 동탄
            $('#btn_dongtan').on('click', function () {
                $('#hdn_sel-gu').val('동탄');
                let gu = "dongtan";
                beforeSearch(gu);
            });

            // 수정/중원구
            $('#btn_sujeong-jungwon-gu').on('click', function () {
                $('#hdn_sel-gu').val('수정-중원구');
                let gu = "sujeong-jungwon-gu";
                beforeSearch(gu);
            });

            // 안양시-동안구
            $('#btn_anyang-si-dongan-gu').on('click', function () {
                $('#hdn_sel-gu').val('동안구');
                let gu = "anyang-si-dongan-gu";
                beforeSearch(gu);
            });

            // 수원시-영통구
            $('#btn_suwon-si-yeongtong-gu').on('click', function () {
                $('#hdn_sel-gu').val('영통구');
                let gu = "suwon-si-yeongtong-gu";
                beforeSearch(gu);
            });

            /************************************
             *  지방 (광역시)
             ************************************/

            // 대전

            // 서구
            $('#btn_daejeon-seo-gu').on('click', function () {
                $('#hdn_sel-gu').val('대전-서구');
                let gu = "daejeon-seo-gu";
                beforeSearch(gu);
            });

            // 유성구
            $('#btn_daejeon-yuseong-gu').on('click', function () {
                $('#hdn_sel-gu').val('대전-유성구');
                let gu = "daejeon-yuseong-gu";
                beforeSearch(gu);
            });


            // 광주

            // 북구
            $('#btn_gwangju-buk-gu').on('click', function () {
                $('#hdn_sel-gu').val('광주-북구');
                let gu = "gwangju-buk-gu";
                beforeSearch(gu);
            });


            /************************************
            *  지방 (중소도시)
            ************************************/

            // 청주
            $('#btn_cheongju').on('click', function () {
                $('#hdn_sel-gu').val('청주');
                let gu = "cheongju";
                beforeSearch(gu);
            });

            // 전주
            $('#btn_jeonju').on('click', function () {
                $('#hdn_sel-gu').val('전주');
                let gu = "jeonju";
                beforeSearch(gu);
            });

            // 천안
            $('#btn_cheonan').on('click', function () {
                $('#hdn_sel-gu').val('천안');
                let gu = "cheonan";
                beforeSearch(gu);
            });

            // 포항 북구
            $('#btn_pohang-si-buk-gu').on('click', function () {
                $('#hdn_sel-gu').val('포항-북구');
                let gu = "pohang-si-buk-gu";
                beforeSearch(gu);
            });


            // Table 내용 엑셀 다운로드
            $('#excelDownload').on('click', function () {

                let table = document.getElementById('tbl_aptInfo');

                // 테이블에 데이터가 있는지 확인
                let tbody = table.querySelector('tbody');
                if (!tbody || tbody.rows.length === 0) {
                    alert("테이블에 데이터가 없습니다.");
                    return;
                }

                let wb = XLSX.utils.book_new();
                let ws = XLSX.utils.table_to_sheet(table, { sheetStubs: true });  // table을 시트로 변환하면서 stub을 추가

                // 열 너비 자동 조정
                let colWidths = [];
                let range = XLSX.utils.decode_range(ws['!ref']);

                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let maxWidth = 10;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        let cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        let cell = ws[cell_address];

                        if (cell && cell.v) {
                            let cellValue = String(cell.v);
                            maxWidth = Math.max(maxWidth, cellValue.length + 2);
                        }
                    }
                    colWidths.push({ wch: maxWidth });
                }
                ws['!cols'] = colWidths;

                // 스타일 적용 (기본 적용 확인)
                Object.keys(ws).forEach(cell => {
                    if (ws[cell] && ws[cell].t) {
                        ws[cell].s = {
                            font: { name: "Arial", sz: 10 }  // Arial 폰트 + 크기 10
                        };
                    }
                });
                XLSX.utils.book_append_sheet(wb, ws, "아파트 정보");  // 시트 추가

                // #update에서 숫자만 추출
                let updateText = $('#update').text();
                let dateStr = updateText.replace(/\D/g, '');  // 숫자만 추출

                var fileNm = $('#hdn_sel-gu').val() + '_시세_트래킹_' + dateStr + '.xlsx'
                // 엑셀 파일로 저장
                XLSX.writeFile(wb, fileNm);
            });

            // 정렬 토글 상태: desc(내림차순) 시작
            $('#btn_sort').data('order', 'desc');

            function parsePrice(text) {
                const n = parseFloat(String(text).replace(/,/g, ''));
                return isNaN(n) ? -Infinity : n; // 숫자 아님은 제일 뒤로
            }

            $('#btn_sort').on('click', function () {
                const $btn = $(this);
                const current = $btn.data('order') || 'desc';
                const next = current === 'desc' ? 'asc' : 'desc';
                $btn.data('order', next);
                $btn.text(next === 'desc' ? '정렬 ▼' : '정렬 ▲');

                const $tbody = $('#tbl_aptInfo tbody');
                const rows = $tbody.find('tr').get();

                rows.sort(function (a, b) {
                    const aPrice = parsePrice($(a).find('td').eq(9).text());
                    const bPrice = parsePrice($(b).find('td').eq(9).text());
                    return next === 'desc' ? (bPrice - aPrice) : (aPrice - bPrice);
                });

                // 현재 화면에 나온(필터로 숨겨진 것도 포함) 행들을 정렬 순서대로 재배치
                $.each(rows, function (_, row) { $tbody.append(row); });
            });

            // 기존 코드에 로딩바 추가
            $('button').on('click', function () {
                if ($(this).data('no-loading')) return;
                showLoadingBar();
            });

            // 데이터 로딩이 완료된 후 로딩바 숨기기
            $(document).ajaxStop(function () {
                hideLoadingBar();
            });

            function toNum(v) {
                if (v === null || v === undefined) return NaN;
                const s = String(v).replace(/[^\d.\-]/g, '').trim();
                const n = parseFloat(s);
                return isNaN(n) ? NaN : n;
            }

            // 숫자 매칭: '3.' => 정수부 프리픽스(3.*), '3.2' => 소수부 자리수만큼 정확히, '3' => 정수부 프리픽스
            function numMatch(valueNum, rawInput) {
                if (rawInput == null) return true;
                const s = String(rawInput).trim();
                if (s === '') return true;
                if (isNaN(valueNum)) return false;

                const cleaned = s.replace(/,/g, ''); // 소수점은 유지
                if (cleaned.endsWith('.')) {
                    // "3." => 정수부가 3인 모든 값(3, 3.0, 3.1, 3.2...)
                    const intPart = parseInt(cleaned.slice(0, -1), 10);
                    if (isNaN(intPart)) return true;
                    return Math.floor(valueNum) === intPart;
                }
                if (cleaned.includes('.')) {
                    // "3.2" => 소수점 자리수 맞춰 비교(반올림해 자리수만큼 동일하면 매칭)
                    const parts = cleaned.split('.');
                    const decLen = (parts[1] || '').length;
                    const target = parseFloat(cleaned);
                    if (isNaN(target)) return true;
                    const factor = Math.pow(10, decLen);
                    return Math.round(valueNum * factor) === Math.round(target * factor);
                }
                // "3" => 정수부가 3인 모든 값
                const intPart = parseInt(cleaned, 10);
                if (isNaN(intPart)) return true;
                return Math.floor(valueNum) === intPart;
            }

            // Table 필터 
            function applyFilters() {
                const filter300Checked = $('#filter300').is(':checked');

                const priceRaw = $('#filterPrice').val();
                const gapRaw = $('#filterGap').val();

                const filterSizeInput = $('#filterSize').val().trim();
                const filterAptNmInput = $('#filterAptNm').val().trim();
                const filterDongInput = $('#filterDong').val().trim();
                const chkBigType = $('#chkBigType').is(':checked');

                $('#tbl_aptInfo tbody tr').each(function () {
                    const units = toNum($(this).find('td:nth-child(6)').text()); // 세대
                    const price = toNum($(this).find('td').eq(9).text());        // 매매
                    const gap = toNum($(this).find('td').eq(11).text());       // 차액 ★
                    const size = $(this).find('td').eq(6).text().trim();
                    const aptNm = $(this).find('td').eq(3).text().trim();
                    const dong = $(this).find('td').eq(2).text().trim();

                    let showRow = true;

                    if (filter300Checked && units < 300) showRow = false;

                    if (showRow && priceRaw) {
                        if (!numMatch(price, priceRaw)) showRow = false;
                    }
                    if (showRow && gapRaw) {
                        if (!numMatch(gap, gapRaw)) showRow = false;
                    }

                    if (showRow && filterSizeInput && !size.includes(filterSizeInput)) showRow = false;
                    if (showRow && filterAptNmInput && !aptNm.includes(filterAptNmInput)) showRow = false;
                    if (showRow && filterDongInput && !dong.includes(filterDongInput)) showRow = false;

                    if (showRow && chkBigType) {
                        const v = parseInt(extractNumbers(size), 10);
                        if (v > 84 || v < 51) showRow = false;
                    }

                    $(this).toggle(showRow);
                });
            }

            $('#filter300, #chkBigType').change(applyFilters);
            $('#filterPrice, #filterGap, #filterSize, #filterAptNm, #filterDong').on("input", applyFilters);


            $('#btn_init').on('click', function () {
                filterInit();
                applyFilters();
            });

            $('#tbl_aptInfo').on('click', 'tr td:nth-child(16), tr td:nth-child(17)', function () {
                const text = $(this).attr('title');
                if (!text) return;

                const temp = $('<textarea>');
                $('body').append(temp);
                temp.val(text).select();
                document.execCommand('copy');
                temp.remove();

                alert(text);
            });

            // 작은 유틸: 숫자 추출(모바일 필터에서 사용)
            function extractNumbers(s) { const m = String(s || '').match(/\d+/); return m ? m[0] : '0'; }

            /////////////////////////// 전체 조회용 function 


            // ▼ 배치 로딩 공통 함수 (APPEND)
            function loadBatch(keys, label) {
                filterInit();                          // 필터 초기화
                $('#hdn_sel-gu').val(label);           // 파일명/타이틀용 라벨
                $('#tbl_aptInfo tbody').empty();       // 한 번만 비우고
                $('#update').text(`(${label}) 로딩중...`);

                const mode = $("input[name='option']:checked").val(); // 't' or 'c'
                keys.forEach(k => {
                    if (mode === 't') {  // Tracking 모드 → APPEND
                        getTrackingResult(k, /*append=*/true);
                    } else {             // Compare 모드 → APPEND
                        getCompareList(k, /*append=*/true);
                    }
                });
            }

            // ▼ 버튼: 서울(전체)
            $('#btn_all_seoul').on('click', function () {
                const seoulKeys = getKeysFromButtons('#div_seoul');

                // 중복 제거 + DOM 순서 그대로 유지
                const SEOUL_ALL = Array.from(new Set([...seoulKeys]));
                loadBatch(SEOUL_ALL, '서울 전체');
            });

            // ▼ 버튼: 수도권(전체)
            $('#btn_all_sudo').on('click', function () {
                const suedoKeys = getKeysFromButtons('#div_suedo');

                // 중복 제거 + DOM 순서 그대로 유지
                const SUDO_ALL = Array.from(new Set([...suedoKeys]));
                loadBatch(SUDO_ALL, '수도권 전체');
            });

            // ▼ 버튼: 지방(전체)
            $('#btn_all_jibang').on('click', function () {
                const JIBANG_ALL = Array.from(new Set([
                    ...getKeysFromButtons('#div_metro'),
                    ...getKeysFromButtons('#div_jibang')
                ]));
                loadBatch(JIBANG_ALL, '지방 전체');
            });

            // 컨테이너(#div_seoul, #div_suedo 등) 안의 "btn_*" 버튼에서 이름만 추출해 배열로 반환
            function getKeysFromButtons(containerSelector) {
                return $(`${containerSelector} button[id^="btn_"]`).map(function () {
                    // 'btn_songpa-gu' → 'songpa-gu'
                    return this.id.replace(/^btn_/, '');
                }).get();
            }


            /// 전체 조회 END        

        });

        function showLoadingBar() {
            $('#loadingBar').show();
            $('#loadingProgress').css('width', '0');
            $('#loadingProgress').animate({ width: '100%' }, 1000); // 로딩바 애니메이션
        }

        function hideLoadingBar() {
            $('#loadingProgress').css('width', '100%');
            setTimeout(function () {
                $('#loadingBar').hide();
            }, 500); // 로딩바 숨김
        }

        function getNowDate() {
            let today = new Date();
            let year = today.getFullYear();
            let month = String(today.getMonth() + 1).padStart(2, "0"); // 1월 = 0이므로 +1
            let day = String(today.getDate()).padStart(2, "0");
            return currentDate = `${year}${month}${day}`;
        }

        // 트래킹 / 비교 선택
        function beforeSearch(gu) {
            filterInit();
            var selectedVal = $("input[name='option']:checked").val();
            if (selectedVal === 't') {
                getTrackingResult(gu);
            } else {
                getCompareList(gu);
            }
        }

        function filterInit() {
            $('#filterPrice, #filterGap, #filterSize, #filterAptNm, #filterDong').val('');
            $('#filter300, #chkBigType').prop('checked', false);
        }

        /**
         * 트래킹 내용 검색
         */
        function getTrackingResult(gu, append = false) {
            getLatestFile(gu).then(function (fileUrl) {
                var formattedDate = extractFormattedDate(fileUrl);
                // append=false 일 때만 초기화/타이틀/업데이트 표시
                if (!append) {
                    $('#update').text(`(${$('#hdn_sel-gu').val()})최종업데이트: ${formattedDate}`);
                    document.title = `(${$('#hdn_sel-gu').val()})시세 트래킹`;
                    $('#tbl_aptInfo tbody').empty();
                }
                $.ajax({
                    url: fileUrl,
                    method: "GET",
                    xhrFields: {
                        responseType: "blob" // 바이너리 데이터로 가져오기
                    },
                    success: function (data) {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            let arrayBuffer = e.target.result;
                            let workBook = XLSX.read(arrayBuffer, { type: "array" });

                            workBook.SheetNames.forEach(function (sheetName) {
                                // console.log('SheetName: ' + sheetName);
                                let rows = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
                                var keys = Object.keys(rows);


                                for (var i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    var subKeys = Object.keys(rows[key]);

                                    var id = rows[key][subKeys[0]];         // ID
                                    var gu = rows[key][subKeys[1]];         // 구
                                    var dong = rows[key][subKeys[2]];       // 동
                                    var nm = rows[key][subKeys[3]];         // 아파트명
                                    var yr = rows[key][subKeys[4]];         // 연식
                                    var sd = rows[key][subKeys[5]];         // 세대
                                    var tp = rows[key][subKeys[6]];         // 타입
                                    var tp2 = rows[key][subKeys[7]];       // 유형
                                    var bang = rows[key][subKeys[8]];      // 방개수
                                    var me = rows[key][subKeys[9]];           // 매매가
                                    var ju = rows[key][subKeys[10]];        // 전세가
                                    var mj = rows[key][subKeys[11]];         // 차액

                                    var mCnt = rows[key][subKeys[12]];     // 매매개수
                                    var jCnt = rows[key][subKeys[13]];      // 전세개수
                                    var mFr = rows[key][subKeys[14]];       // 매/층
                                    var jFr = rows[key][subKeys[15]];       // 전/층
                                    var desc = rows[key][subKeys[16]];      // 설명
                                    var szKey = rows[key][subKeys[17]];      // key

                                    var rate = "0.0%";       // 전세가율

                                    // console.log(me, ju);

                                    if (me !== '' && ju !== '') {

                                        var m = parseFloat(me);
                                        var j = parseFloat(ju);


                                        rate = (j / m) * 100;
                                        rate = (Math.round(rate * 10) / 10) + '%'; // 소수점 1자리 반올림
                                    }

                                    createTableList(id, gu, dong, nm, yr, sd, tp, tp2, bang, me, ju, mj, rate, mCnt, jCnt, mFr, jFr, desc, szKey);
                                }
                            })

                            aptRowCnt();

                        };

                        reader.readAsArrayBuffer(data);
                    },
                    error: function () {
                        alert("엑셀 파일을 다운로드하는 중 오류가 발생했습니다.");
                    }
                });
            });
        }


        /** 
         *  비교용 내역을 Excel 에서 가져옴
         */
        function getCompareList(gu, append = false) {
            var compareList = [];
            var cmpfileUrl = "https://roy-fild.github.io/tracking/compare/" + gu + ".xlsx";

            // 요청 토큰(뒤에서 결과 렌더 시 최신 요청만 통과)
            window.__REQ_TOKEN__ = (window.__REQ_TOKEN__ || 0) + 1;
            const myToken = window.__REQ_TOKEN__;

            $.ajax({
                url: cmpfileUrl,
                method: "GET",
                xhrFields: { responseType: "blob" },
                success: function (data) {
                    let reader = new FileReader();
                    reader.onload = function (e) {
                        let arrayBuffer = e.target.result;
                        let wb = XLSX.read(arrayBuffer, { type: "array" });

                        // 시트를 "배열"로 읽어 순서 100% 보장
                        wb.SheetNames.forEach(function (sheetName) {
                            const aoa = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {
                                header: 1,   // 배열로
                                defval: ""   // 빈칸도 빈 문자열
                            });
                            // 1행이 헤더라면 1행부터 데이터 시작(필요 시 0으로)
                            for (let r = 1; r < aoa.length; r++) {
                                const row = aoa[r];
                                // [0]=ID, [1]=아파트명, [2]=타입  ← compare 엑셀 컬럼 순서에 맞춰 인덱스 지정
                                const id = row[0];
                                const nm = row[1];
                                const tp = row[2];
                                if (!id) continue; // 빈줄 스킵
                                compareList.push({ id, nm, tp });
                            }
                        });

                        // 최신 요청만 허용
                        if (myToken === window.__REQ_TOKEN__) {
                            getCompareResult(gu, compareList, myToken, append);
                        }
                    };
                    reader.readAsArrayBuffer(data);
                },
                error: function () {
                    alert("엑셀 파일을 다운로드하는 중 오류가 발생했습니다.");
                }
            });
        }


        /**
         * Excel 파일에서 내용 가져오기
         */
        function getCompareResult(gu, compareList, reqToken, append = false) {
            getLatestFile(gu).then(function (fileUrl) {
                if (reqToken && reqToken !== window.__REQ_TOKEN__) return; // 이전 요청 무시

                var formattedDate = extractFormattedDate(fileUrl);
                if (!append) {
                    $('#update').text(`최종업데이트: ${formattedDate}`);
                    document.title = `(${$('#hdn_sel-gu').val()})네이버 시세 트래킹`;
                    $('#tbl_aptInfo tbody').empty();
                }


                var resultList = [];

                $.ajax({
                    url: fileUrl,
                    method: "GET",
                    xhrFields: { responseType: "blob" },
                    success: function (data) {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            let arrayBuffer = e.target.result;
                            let wb = XLSX.read(arrayBuffer, { type: "array" });

                            wb.SheetNames.forEach(function (sheetName) {
                                const aoa = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {
                                    header: 1,
                                    defval: ""
                                });
                                // ✅ AOA 인덱싱: 아래 인덱스는 "트래킹 결과" 엑셀의 실제 순서를 맞춰줘야 함
                                // 0:ID, 1:구, 2:동, 3:단지명, 4:연식, 5:세대, 6:타입, 7:유형, 8:방,
                                // 9:매매, 10:전세, 11:차액, 12:매매개수, 13:전세개수, 14:매/층, 15:전/층, 16:설명, 17:key
                                for (let r = 1; r < aoa.length; r++) {
                                    const row = aoa[r];
                                    if (!row[0]) continue; // ID 없으면 스킵
                                    resultList.push({
                                        id: row[0],
                                        gu: row[1],
                                        dong: row[2],
                                        nm: row[3],
                                        yr: row[4],
                                        sd: row[5],
                                        tp: row[6],
                                        tp2: row[7],
                                        bang: row[8],
                                        me: row[9],
                                        ju: row[10],
                                        rate: '',
                                        mj: '',
                                        mCnt: row[13],
                                        jCnt: row[14],
                                        mFr: row[15],
                                        jFr: row[16],
                                        desc: row[17],
                                        szKey: row[18]
                                    });
                                }
                            });

                            if (!reqToken || reqToken === window.__REQ_TOKEN__) {
                                comparing(compareList, resultList);
                            }
                        };
                        reader.readAsArrayBuffer(data);
                    },
                    error: function () {
                        alert("엑셀 파일을 다운로드하는 중 오류가 발생했습니다.");
                    }
                });
            });
        }

        // 비교 출력 (매매/전세 각각 최저가, 매매 우선 병합 출력)
        function comparing(compareList, resultList) {
            console.log(compareList);
            console.log(resultList);

            $('#tbl_aptInfo tbody').empty();

            const toNum = (v) => {
                if (v === null || v === undefined) return NaN;
                const s = String(v).replace(/,/g, '').trim();
                const n = parseFloat(s);
                return isNaN(n) ? NaN : n;
            };

            const tpMatches = (rowTp, cmpTp) => {
                if (!cmpTp) return true;
                if (!rowTp) return false;
                return String(rowTp).includes(String(cmpTp)); // 필요시 완전일치(===)로
            };

            const idMatches = (rowId, cmpId) =>
                String(rowId).trim() === String(cmpId).trim();

            for (let i = 0; i < compareList.length; i++) {
                const { id: cmpId, tp: cmpTp, nm: cmpNm } = compareList[i];

                // 후보군
                const saleCandidates = resultList.filter(row =>
                    idMatches(row.id, cmpId) && tpMatches(row.tp, cmpTp) && !isNaN(toNum(row.me))
                );
                const rentCandidates = resultList.filter(row =>
                    idMatches(row.id, cmpId) && tpMatches(row.tp, cmpTp) && !isNaN(toNum(row.ju))
                );

                // 최저 매매, 최저 전세 각각 찾기
                let bestSale = null, bestSalePrice = Infinity;
                for (const r of saleCandidates) {
                    const p = toNum(r.me);
                    if (!isNaN(p) && p < bestSalePrice) { bestSale = r; bestSalePrice = p; }
                }

                let bestRent = null, bestRentPrice = Infinity;
                for (const r of rentCandidates) {
                    const p = toNum(r.ju);
                    if (!isNaN(p) && p < bestRentPrice) { bestRent = r; bestRentPrice = p; }
                }

                // 메타데이터 보강용(구/동/연식/세대/단지명 등) - 매매 우선, 없으면 같은 ID의 아무 행
                const anyRowSameId = resultList.find(row => idMatches(row.id, cmpId));
                const base = bestSale || anyRowSameId || bestRent; // 우선순위: 매매 > 같은ID > 전세

                // 출력 값 조립
                const id = cmpId;
                const gu = base ? base.gu : "";
                const dong = base ? base.dong : "";
                const nm = base ? base.nm : (cmpNm || "(비교대상 없음)");
                const yr = base ? base.yr : "";
                const sd = base ? base.sd : "";

                const tp = cmpTp || (base ? base.tp : "");           // 요청 타입 우선 노출
                const tp2 = bestSale ? bestSale.tp2 : (bestRent ? bestRent.tp2 : "");
                const bang = base ? base.bang : "";

                const me = bestSale ? bestSale.me : "";              // 매매 최저가(없으면 공백)
                const ju = bestRent ? bestRent.ju : "";              // 전세 최저가(없으면 공백)

                // 차액/전세가율 계산(둘 다 숫자일 때만)
                const mNum = toNum(me);
                const jNum = toNum(ju);
                const mj = (!isNaN(mNum) && !isNaN(jNum)) ? (Math.round((mNum - jNum) * 10) / 10) : "";
                const rate = (!isNaN(mNum) && mNum > 0 && !isNaN(jNum))
                    ? (Math.round((jNum / mNum) * 1000) / 10) + '%'
                    : "";




                // 개수/층/설명: 매매 우선, 전세는 전세행에서. 없으면 공백
                const mCnt = (bestSale && bestSale.mCnt) ? bestSale.mCnt : (base ? base.mCnt : "");
                const jCnt = (bestRent && bestRent.jCnt) ? bestRent.jCnt : (base ? base.jCnt : "");
                const mFr = (bestSale && bestSale.mFr) ? bestSale.mFr : (base ? base.mFr : "");
                const jFr = (bestRent && bestRent.jFr) ? bestRent.jFr : (base ? base.jFr : "");
                const desc = (bestSale && bestSale.desc) ? bestSale.desc : (base ? base.desc : "");
                const szKey = base ? base.szKey : "";

                console.log(mCnt);

                createTableList(
                    id, gu, dong, nm, yr, sd,
                    tp, tp2, bang, me, ju, mj,
                    rate, mCnt, jCnt, mFr, jFr, desc, szKey
                );
            }

            aptRowCnt();
        }


        function createTableList(id, gu, dong, nm, yr, sd, tp, tp2, bang, me, ju, mj, rate, mCnt, jCnt, mFr, jFr, desc, szKey) {

            // console.log(id, gu, dong, nm, yr, sd, tp, tp2, bang, me, ju, mj, rate, mCnt, jCnt, mFr, jFr, desc, szKey);

            var html = "";

            html += '<tr>';
            html += '<td><a href="https://new.land.naver.com/complexes/' + id + '" target="_blank">' + id + '</a></td>';              // ID(네이버)
            html += '<td>' + gu + '</td>';   // 구
            html += '<td>' + dong + '</td>'; // 동
            html += '<td><a href="https://fin.land.naver.com/complexes/' + id + '?tradeTypes=A1&sortingType=%EB%82%AE%EC%9D%80%EA%B0%80%EA%B2%A9%EC%88%9C&tab=article&articleSortingType=price_asc&articleTradeTypes=A1&articlePyeongTypeNumbers=' + szKey + '" target="_blank">' + nm + '</a></td>';            // 단지
            html += '<td>' + yr + '</td>';   // 연식
            html += '<td>' + sd + '</td>';   // 세대                
            html += '<td>' + tp + '</td>';  // 타입
            html += '<td>' + tp2 + '</td>';  // 유형
            html += '<td>' + bang + '</td>';  // 방
            html += '<td>' + me + '</td>';  // 매매가
            html += '<td>' + ju + '</td>';  // 전세가
            html += '<td>' + mj + '</td>';  // 차액
            html += '<td>' + rate + '</td>';  // 전세가율
            html += '<td>' + mCnt + '</td>';  // 매매개수
            html += '<td>' + jCnt + '</td>';  // 전세개수
            html += '<td>' + mFr + '</td>';  // 매매층
            html += '<td>' + jFr + '</td>';  // 전세층
            html += '<td>' + desc + '</td>';  // 설명
            html += '</tr>';

            $('#tbl_aptInfo tbody').append(html);
        }

        // url 에서 날짜를 추출해서 yyyy.mm.dd 형식으로 반환
        function extractFormattedDate(fileUrl) {
            // 정규식으로 _yyyymmdd.xlsx 패턴 추출
            var match = fileUrl.match(/_(\d{8})\.xlsx$/);
            if (!match) return null; // 날짜 패턴 없으면 null 반환

            var yyyymmdd = match[1];
            var year = yyyymmdd.substring(0, 4);
            var month = yyyymmdd.substring(4, 6);
            var day = yyyymmdd.substring(6, 8);

            return year + "." + month + "." + day;
        }


        function aptRowCnt() {
            const names = new Set();

            $('#tbl_aptInfo tbody tr').each(function () {
                const name = $(this).find('td:first').text().trim();
                names.add(name);
            });

            // $('#aptCnt').text(`TOTAL: ${names.size}`);
            $('#aptCntBadge').text(`TOTAL: ${names.size}`)
        }

    </script>
</body>

</html>