<!DOCTYPE html>
<html>

<head>
    <link href="./style2.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
    <!-- html2canvas 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #apt_tables {
            display: flex;
            flex-wrap: wrap;
            /* 줄바꿈 가능 */
            gap: 0;
            align-items: flex-start;
            /* 각 테이블의 위쪽을 맞추고 높이 강제 안 맞춤 */
        }

        #apt_tables table {
            border: 1px solid #ccc;
            border-collapse: collapse;
            /* border-spacing 완전히 제거 */
            margin: 0;
            /* 공백 제거 */
            width: auto;
            min-width: 150px;
            cursor: pointer;
        }

        #apt_tables th,
        #apt_tables td {            
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            box-sizing: border-box;
        }
    </style>
    <script>
        $(function () { });
        // 동적으로 생성된 table 클릭 시 이미지로 변환 후 클립보드 복사
        $(document).on("click", "#apt_tables table", function () {
            let tableElement = this;

            html2canvas(tableElement).then(canvas => {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([
                            new ClipboardItem({ "image/png": blob })
                        ]).then(() => {
                            alert("테이블 이미지가 클립보드에 복사되었습니다.");
                        }).catch(err => {
                            console.error("클립보드 복사 실패:", err);
                            alert("클립보드 복사 실패");
                        });
                    } else {
                        alert("이 브라우저에서는 이미지 클립보드 복사를 지원하지 않습니다.");
                    }
                });
            });
        });

        function isImgFile(file) {
            var ext = file.name.split(".").pop().toLowerCase();
            return ($.inArray(ext, ["jpg", "jpeg", "gif", "png"]) === -1) ? false : true;
        }

        function isExcelFile(file) {
            var ext = file.name.split(".").pop().toLowerCase();
            return ($.inArray(ext, ["xlsx", "xls"]) === -1) ? false : true;
        }

        // 엑셀 자료 추출
        function excelExport(event) {
            var aptArr = [];
            let input = event.target;
            let reader = new FileReader();
            reader.onload = function () {
                let data = reader.result;
                let workBook = XLSX.read(data, { type: 'binary' });
                workBook.SheetNames.forEach(function (sheetName) {
                    let rows = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
                    var keys = Object.keys(rows);
                    for (var i = 0; i < keys.length; i++) {
                        var key = keys[i];
                        var subKeys = Object.keys(rows[key]);

                        var dong = rows[key][subKeys[0]];    // 동
                        var aptNm = rows[key][subKeys[1]];    // 아파트명
                        var aptYear = rows[key][subKeys[2]];    // 연식
                        var aptSize = rows[key][subKeys[3]];    // 세대수
                        var pyung = rows[key][subKeys[4]];    // 평
                        var sell = rows[key][subKeys[5]];    // 매매가 
                        var junse = rows[key][subKeys[6]];    // 전세가

                        var label = dong + "/" + aptNm + "/" + aptYear + "/" + aptSize + "/" + pyung + "/" + sell + "/" + junse;
                        aptArr.push(label);
                    }
                    labelCreate(aptArr);
                })
            };
            reader.readAsBinaryString(input.files[0]);
        }

        function labelCreate(aptArr) {
            var aptChkArr = [];
            for (var i = 0; i < aptArr.length; i++) {
                var line = aptArr[i].split('/');
                var aptNm = line[0] + "/" + line[1] + "y/" + line[2] + "^"
                var idx = aptChkArr.indexOf(aptNm);
                if (idx > -1) {
                    console.log("중복::" + aptNm);
                } else {
                    chkDupAptNm(aptNm, aptArr);
                    aptChkArr.push(aptNm);
                }
            }
        }

        function chkDupAptNm(v, aptArr) {
            var aptCtntArr = new Array();
            for (var i = 0; i < aptArr.length; i++) {
                var line = aptArr[i].split('/');
                var aptNm = line[0] + "/" + line[1] + "y/" + line[2] + "^"
                if (v == aptNm) {
                    var p = line[3];
                    var s = line[4];
                    var j = (line[5] === '0' || line[5] === 'undefined') ? '' : '/' + line[5];
                    var ctnt = p + '/' + s + j;
                    aptCtntArr.push(ctnt);
                }
            }
            createLabel(v, aptCtntArr);
        }

        function createLabel(v, aptCtntArr) {
            var aptInfos = v.split('/');
            var aptNm = aptInfos[0];
            var aptInfo = aptInfos[1] + '/' + aptInfos[2];

            var html = "";
            html += '<table>';
            html += '<thead>';
            html += '<tr><th>' + aptNm + '<br/>' + aptInfo + '</th></tr>';
            html += '</thead>';
            html += '<tbody>';

            for (var i = 0; i < aptCtntArr.length; i++) {
                html += selectColor(aptCtntArr[i]);
            }
            html += '</tbody>';
            html += '</table>';

            // body 대신 apt_tables에 추가
            $('#apt_tables').append(html);

            var cnt = $('#apt_tables table').length;
            $('#apt_cnt').text(cnt);
        }

        function selectColor(aptCtntArr) {
            var html = "";
            var infos = aptCtntArr.split('/');
            var price = Number(infos[1]);

            if (price > 15) {
                html += '<tr><td bgcolor="#ff0000"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 10) {
                html += '<tr><td bgcolor="#ffa500"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 9) {
                html += '<tr><td bgcolor="#ffff00">' + aptCtntArr + '</td></tr>';
            } else if (price >= 8) {
                html += '<tr><td bgcolor="#00ff00">' + aptCtntArr + '</td></tr>';
            } else if (price >= 7) {
                html += '<tr><td bgcolor="#008000"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 6) {
                html += '<tr><td bgcolor="#00ffff">' + aptCtntArr + '</td></tr>';
            } else if (price >= 5) {
                html += '<tr><td bgcolor="#0000ff"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 4) {
                html += '<tr><td bgcolor="#000080"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 3) {
                html += '<tr><td bgcolor="#ff00ff"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 2) {
                html += '<tr><td bgcolor="#d3d3d3">' + aptCtntArr + '</td></tr>';
            } else {
                html += '<tr><td>' + aptCtntArr + '</td></tr>';
            }
            return html;
        }
    </script>
</head>

<body>
    <div class="title">
        <h1>시세라벨생성기</h1>
    </div>
    <div>
        아파트명/연식/세대수/타입/매매가/전세가
    </div>
    <div>
        엑셀 파일선택 <input type="file" id="excelFile" onchange="excelExport(event)" />
    </div>
    <div>
        <span style="background-color: #ff0000;">
            <font color="#ffffff">15억이상</font>
        </span>
        <span style="background-color: #ffa500;">
            <font color="#ffffff">10억대</font>
        </span>
        <span style="background-color: #ffff00;">9억대</span>
        <span style="background-color: #00ff00;">8억대</span>
        <span style="background-color: #008000;">
            <font color="#ffffff">7억대</font>
        </span>
        <span style="background-color: #00ffff;">6억대</span>
        <span style="background-color: #0000ff;">
            <font color="#ffffff">5억대</font>
        </span>
        <span style="background-color: #000080;">
            <font color="#ffffff">4억대</font>
        </span>
        <span style="background-color: #ff00ff;">
            <font color="#ffffff">3억대</font>
        </span>
        <span style="background-color: #d3d3d3;">2억대</span>
        <span style="background-color: #ffffff;">기타</span>
    </div>
    <div>생성된 라벨을 마우스로 클릭하면 클립보드에 복사가 되면 ctrl+v 로 이미지 처럼 바로 붙혀 넣을 수 있습니다.</div>
    <div id="apt_cnt"></div>

    <!-- 테이블 출력 영역 -->
    <div id="apt_tables"></div>
</body>

</html>