<!DOCTYPE html>
<html>

<head>
    <title>시세라벨생성기</title>
    <link href="./style2.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
    <!-- html2canvas 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
    :root{
        --bg: #f4f6fb;
        --panel: #ffffff;
        --text: #0f172a;
        --muted:#64748b;
        --border: rgba(15, 23, 42, 0.10);
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        --shadow-sm: 0 6px 18px rgba(15, 23, 42, 0.10);
        --radius: 14px;
    }

    *{ box-sizing: border-box; }
    body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, "Helvetica Neue", sans-serif;
        background: radial-gradient(1200px 500px at 10% 0%, rgba(99, 102, 241, 0.10), transparent 55%),
                    radial-gradient(900px 500px at 90% 10%, rgba(16, 185, 129, 0.10), transparent 55%),
                    var(--bg);
        color: var(--text);
    }

    .app{
        max-width: 1400px;
        margin: 0 auto;
        padding: 18px 18px 40px;
    }

    .topbar{
        display:flex;
        flex-wrap: wrap;
        gap: 12px 16px;
        align-items: flex-end;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .title h2{
        margin: 0;
        font-size: 22px;
        line-height: 1.2;
        letter-spacing: -0.3px;
    }

    .subtitle{
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
    }

    .controls{
        display:flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
    }

    .filebox{
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 8px 12px;
        box-shadow: 0 1px 0 rgba(15,23,42,0.04);
        display:flex;
        align-items:center;
        gap: 10px;
    }

    .filebox label{
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        letter-spacing: .1px;
    }

    .filebox input[type="file"]{
        font-size: 12px;
        color: var(--text);
    }

    .hint{
        background: rgba(255,255,255,0.65);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px 12px;
        box-shadow: 0 1px 0 rgba(15,23,42,0.04);
        color: var(--muted);
        font-size: 13px;
        margin: 10px 0 12px;
    }

    .legend{
        display:flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items:center;
        margin: 6px 0 10px;
    }

    .legend .legend-item{
        display:inline-flex;
        align-items:center;
        gap: 8px;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid rgba(15,23,42,0.08);
        background: rgba(255,255,255,0.70);
        box-shadow: 0 1px 0 rgba(15,23,42,0.04);
        font-size: 12px;
        color: var(--muted);
        font-weight: 700;
    }

    .legend .dot{
        width: 10px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.10);
        flex: 0 0 auto;
    }

    #apt_cnt{
        margin: 8px 0 10px;
        color: var(--muted);
        font-size: 13px;
        font-weight: 700;
    }

    /* 라벨 테이블 영역 */
    #apt_tables{
        display:flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-start;
    }

    #apt_tables table{
        border: 1px solid var(--border);
        border-collapse: separate;
        border-spacing: 0;
        margin: 0;
        width: auto;
        cursor: pointer;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
        transform: translateZ(0);
        transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }

    #apt_tables table:hover{
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
        border-color: rgba(15,23,42,0.18);
    }

    #apt_tables th{
        border: none;
        padding: 10px 12px;
        text-align: left;
        background: linear-gradient(180deg, #111827, #0b1220);
        color: #fff;
        white-space: nowrap;
        font-weight: 800;
        letter-spacing: -0.2px;
        line-height: 1.15;
        font-size: 13px;
    }

    #apt_tables th span{
        padding: 2px 6px;
        border-radius: 8px;
        display: inline-block;
        margin-right: 4px;
        line-height: 1.2;
    }

    #apt_tables td{
        border: none;
        padding: 8px 12px;
        text-align: center;
        white-space: nowrap;
        font-weight: 800;
        letter-spacing: -0.15px;
        font-size: 13px;
    }

    /* 행 사이 구분선(배경색은 그대로 살리고, 위에 얇은 라인만) */
    #apt_tables tbody tr + tr td{
        box-shadow: inset 0 1px 0 rgba(15,23,42,0.10);
    }

    /* 클릭 표시: 빨간 테두리(캡처에는 안 찍힘) */
    .clicked-outline{
        outline: 3px solid #ff2a2a;
        outline-offset: -3px;
        border-radius: 8px;
        box-shadow: 0 0 0 2px rgba(255,42,42,0.18), 0 10px 30px rgba(0,0,0,0.18);
    }

    #apt_tables table{
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    /* Toast */
    #toast-container{
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast{
        min-width: 220px;
        margin-top: 10px;
        padding: 12px 14px;
        border-radius: 12px;
        color: #fff;
        background: rgba(15, 23, 42, 0.88);
        border: 1px solid rgba(255,255,255,0.12);
        box-shadow: 0 14px 35px rgba(15,23,42,0.25);
        font-size: 13px;
        font-weight: 700;
        opacity: 0;
        transform: translateY(14px);
        transition: all 0.25s ease-in-out;
        backdrop-filter: blur(8px);
    }

    .toast.show{
        opacity: 1;
        transform: translateY(0);
    }

    /* 모바일에서 간격 살짝 */
    @media (max-width: 768px){
        .app{ padding: 14px 12px 30px; }
        #apt_tables{ gap: 10px; }
        #apt_tables th{ font-size: 12px; }
        #apt_tables td{ font-size: 12px; }
    }

/* === Korean font sharpening / crisp rendering === */
:root{
  --ui-font: "Pretendard", "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}
html, body {
  font-family: var(--ui-font);
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-synthesis: none;
}
/* Make label text crisp */
.label, .apt-label, .item, .card,
.label * , .apt-label * , .item * , .card * {
  font-family: var(--ui-font);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: geometricPrecision;
}

/* Slightly tighter, sharper label typography */
.label-title, .apt-title, .title {
  font-weight: 700;
  letter-spacing: -0.2px;
}
.label-subtitle, .apt-subtitle, .subtitle, .meta {
  font-weight: 600;
  letter-spacing: -0.15px;
}
.label-value, .value {
  font-weight: 700;
  letter-spacing: -0.1px;
}

/* Avoid fractional scaling that can blur text */
.label, .apt-label, .item, .card {
  transform: none !important;
}

</style>
    <script>
        $(function() {});
        // 동적으로 생성된 table 클릭 시 이미지로 변환 후 클립보드 복사
        $(document).on("click", "#apt_tables table", function() {
            let tableElement = this;

            // 1) 캡처 전에 기존 표시 제거 (다음 캡처에 표시선이 찍히지 않도록)
            $("#apt_tables table.clicked-outline").removeClass("clicked-outline");

            // 2) 캡처 진행
            html2canvas(tableElement).then(canvas => {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([
                            new ClipboardItem({
                                "image/png": blob
                            })
                        ]).then(() => {
                            showToast("테이블 이미지가 클립보드에 복사되었습니다 ✅");
                            console.log("복사성공");
                        }).catch(err => {
                            console.error("클립보드 복사 실패:", err);
                            showToast("클립보드 복사 실패 ❌");
                        }).finally(() => {
                            // 3) 캡처가 끝난 뒤에 표시선 적용 (이미지에는 안 찍힘)
                            $(tableElement).addClass("clicked-outline");
                        });
                    } else {
                        showToast("이 브라우저에서는 클립보드 복사를 지원하지 않습니다 ⚠️");
                        // 브라우저 미지원이어도 클릭 표시 자체는 보여주기
                        $(tableElement).addClass("clicked-outline");
                    }
                });
            });
        });

        function getYearBgColor(year) {
            if (isNaN(year)) return ""; // 숫자 아니면 색 안 줌

            if (year >= 2020) {
                return "background-color:#ff0000; color:#ffffff"; // 빨강
            } else if (year >= 2010) {
                return "background-color:#ffa500; color:#000000"; // 주황
            } else if (year >= 2000) {
                return "background-color:#ffff00; color:#000000"; // 노랑
            } else if (year >= 1990) {
                return "background-color:#90ee90; color:#000000"; // 연한 초록 (light blue)
            } else if (year >= 1980) {
                return "background-color:#006400; color:#ffffff"; // 진한 초록
            } else {
                return "color:#ffffff"; // 1980 미만은 색 없음 (원하면 여기도 지정 가능)
            }
        }

        function isImgFile(file) {
            var ext = file.name.split(".").pop().toLowerCase();
            return ($.inArray(ext, ["jpg", "jpeg", "gif", "png"]) === -1) ? false : true;
        }

        function isExcelFile(file) {
            var ext = file.name.split(".").pop().toLowerCase();
            return ($.inArray(ext, ["xlsx", "xls"]) === -1) ? false : true;
        }

        // 엑셀 자료 추출
        function excelExport(event) {
            var aptArr = [];
            let input = event.target;
            let reader = new FileReader();
            reader.onload = function() {
                let data = reader.result;
                let workBook = XLSX.read(data, {
                    type: 'binary'
                });
                workBook.SheetNames.forEach(function(sheetName) {
                    let rows = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
                    var keys = Object.keys(rows);
                    for (var i = 0; i < keys.length; i++) {
                        var key = keys[i];
                        var subKeys = Object.keys(rows[key]);

                        var dong = rows[key][subKeys[0]]; // 동
                        var aptNm = rows[key][subKeys[1]]; // 아파트명
                        var aptYear = rows[key][subKeys[2]]; // 연식
                        var aptSize = rows[key][subKeys[3]]; // 세대수
                        var pyung = rows[key][subKeys[4]]; // 평
                        var sell = rows[key][subKeys[5]]; // 매매가 
                        var junse = rows[key][subKeys[6]]; // 전세가

                        var label = dong + "/" + aptNm + "/" + aptYear + "/" + aptSize + "/" + pyung + "/" + sell + "/" + junse;
                        aptArr.push(label);
                    }
                    labelCreate(aptArr);
                })
            };
            reader.readAsBinaryString(input.files[0]);
        }

        function labelCreate(aptArr) {
            var aptChkArr = [];
            for (var i = 0; i < aptArr.length; i++) {
                var line = aptArr[i].split('/');
                var aptNm = line[0] + "/" + line[1] + "y/" + line[2] + "^"
                var idx = aptChkArr.indexOf(aptNm);
                if (idx > -1) {
                    console.log("중복::" + aptNm);
                } else {
                    chkDupAptNm(aptNm, aptArr);
                    aptChkArr.push(aptNm);
                }
            }
        }

        function chkDupAptNm(v, aptArr) {
            var aptCtntArr = new Array();
            for (var i = 0; i < aptArr.length; i++) {
                var line = aptArr[i].split('/');
                var aptNm = line[0] + "/" + line[1] + "y/" + line[2] + "^"
                if (v == aptNm) {
                    var p = line[3];
                    var s = line[4];
                    var j = (line[5] === '0' || line[5] === 'undefined') ? '' : '/' + line[5];
                    var ctnt = p + '/' + s + j;
                    aptCtntArr.push(ctnt);
                }
            }
            createLabel(v, aptCtntArr);
        }

        function createLabel(v, aptCtntArr) {
            var aptInfos = v.split('/');

            // v 형식 예시 가정:
            //  - "동/2010y/2644"   또는
            //  - "동/아파트명/2010y/2644" 같은 식이라면
            // 아래 로직에 맞춰 aptNm / aptInfo를 조합해서 쓰면 됨.

            // 1) 동(또는 상단 첫 줄에 올 텍스트)
            var aptNm = aptInfos[0];

            // 2) 연식 + 세대수 부분: 예) "2010y/2644"
            //    여기서 연식 부분은 aptInfos[1] 이라고 가정 (2010y)
            //    세대수는 aptInfos[2] (2644)
            var yearToken = aptInfos[1]; // "2010y"
            var sizeToken = aptInfos[2]; // "2644" 등

            // "2010y" 에서 숫자만 파싱해서 연식 숫자 추출
            var yearNum = parseInt(yearToken, 10); // 2010
            var yearBgColor = getYearBgColor(yearNum);

            // 3) 연식에 배경색 입히기 (텍스트는 그대로 "2010y")
            var yearHtml;
            if (yearBgColor) {
                yearHtml = '<span style="' + yearBgColor + '">' + yearToken + '</span>';
            } else {
                yearHtml = yearToken;
            }

            // 4) 헤더에 보여줄 aptInfo: 예) "2010y(색입힘)/2644"
            var aptInfo = yearHtml + '/' + sizeToken;

            var html = "";
            html += '<table>';
            html += '<thead>';
            html += '<tr><th>' + aptNm + '<br/>' + aptInfo + '</th></tr>';
            html += '</thead>';
            html += '<tbody>';

            for (var i = 0; i < aptCtntArr.length; i++) {
                html += selectColor(aptCtntArr[i]);
            }
            html += '</tbody>';
            html += '</table>';

            $('#apt_tables').append(html);

            var cnt = '단지 개수: ' + $('#apt_tables table').length;
            $('#apt_cnt').text(cnt);
        }

        function selectColor(aptCtntArr) {
            var html = "";
            var infos = aptCtntArr.split('/');
            var price = Number(infos[1]);

            if (price > 15) {
                html += '<tr><td bgcolor="#ff0000"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 10) {
                html += '<tr><td bgcolor="#ffa500"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 9) {
                html += '<tr><td bgcolor="#ffff00">' + aptCtntArr + '</td></tr>';
            } else if (price >= 8) {
                html += '<tr><td bgcolor="#00ff00">' + aptCtntArr + '</td></tr>';
            } else if (price >= 7) {
                html += '<tr><td bgcolor="#008000"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 6) {
                html += '<tr><td bgcolor="#00ffff">' + aptCtntArr + '</td></tr>';
            } else if (price >= 5) {
                html += '<tr><td bgcolor="#0000ff"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 4) {
                html += '<tr><td bgcolor="#000080"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 3) {
                html += '<tr><td bgcolor="#ff00ff"><font color="#ffffff">' + aptCtntArr + '</font></td></tr>';
            } else if (price >= 2) {
                html += '<tr><td bgcolor="#d3d3d3">' + aptCtntArr + '</td></tr>';
            } else {
                html += '<tr><td>' + aptCtntArr + '</td></tr>';
            }
            return html;
        }

        function showToast(message) {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.innerText = message;
            container.appendChild(toast);

            // 애니메이션으로 나타남
            setTimeout(() => toast.classList.add("show"), 100);

            // 3초 후 자동 사라짐
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <h2>시세라벨생성기 <small><i><span style="font-size:11px;color:rgba(255,255,255,0.0)">.</span><font size=1>by 필디</font></i></small></h2>
        <div class="subtitle">아파트명 / 연식 / 세대수 / 타입 / 매매가 / 전세가</div>
      </div>

      <div class="controls">
        <div class="filebox">
          <label>엑셀 파일</label>
          <input type="file" id="excelFile" onchange="excelExport(event)" />
        </div>
      </div>
    </div>

    <div class="legend" aria-label="가격 구간 색상 안내">
      <span class="legend-item"><span class="dot" style="background:#ff0000"></span>15억 이상</span>
      <span class="legend-item"><span class="dot" style="background:#ffa500"></span>10억대</span>
      <span class="legend-item"><span class="dot" style="background:#ffff00"></span>9억대</span>
      <span class="legend-item"><span class="dot" style="background:#00ff00"></span>8억대</span>
      <span class="legend-item"><span class="dot" style="background:#008000"></span>7억대</span>
      <span class="legend-item"><span class="dot" style="background:#00ffff"></span>6억대</span>
      <span class="legend-item"><span class="dot" style="background:#0000ff"></span>5억대</span>
      <span class="legend-item"><span class="dot" style="background:#000080"></span>4억대</span>
      <span class="legend-item"><span class="dot" style="background:#ff00ff"></span>3억대</span>
      <span class="legend-item"><span class="dot" style="background:#d3d3d3"></span>2억대</span>
      <span class="legend-item"><span class="dot" style="background:#ffffff"></span>기타</span>
    </div>

    <div class="hint">생성된 라벨을 클릭하면 클립보드에 복사됩니다. <b>[Ctrl + V]</b>로 PPT에 이미지처럼 붙여넣을 수 있어요.</div>

    <div id="apt_cnt"></div>

    <div id="apt_tables"></div>
  </div>

  <div id="toast-container"></div>
</body>

</html>